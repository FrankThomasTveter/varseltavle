{"ast":null,"code":"//console.log(\"Loading MatrixLib.js\");\nfunction Matrix() {\n  this.cnt = 0;\n  this.keyCnt = {};\n  this.levCnt = {};\n  this.values = {};\n  this.limit = 50; // displayed data\n\n  this.resolution = 20; // map resolution\n\n  this.area = {};\n  this.popSingle = 20000;\n  this.popSeries = 50000;\n\n  this.init = function (state) {\n    var par = \"Matrix\" + state.Utils.version;\n    state.Utils.init(par, this);\n  };\n\n  this.cntKey = function (state, key, nrec, where) {\n    var val;\n\n    if (this.values[key] === undefined) {\n      this.keyCnt[key] = 0;\n      this.values[key] = [];\n    }\n\n    if (state.Path.ignore.indexOf(key) === -1) {\n      //ignore special words... \n      var tcnt = 0;\n      var docs = state.Database.getKeyCnt(state, key, where); //console.log(\"Count:\",sql,JSON.stringify(docs));\n\n      var dlen = docs.length;\n\n      for (var jj = 0; jj < dlen; jj++) {\n        var doc = docs[jj];\n        val = doc[key];\n        var cnt = doc.cnt;\n\n        if (val !== undefined) {\n          //console.log(\"Found key:\",key,this.getDocVal(state,doc,key));\n          this.keyCnt[key] = this.keyCnt[key] + cnt;\n          this.values[key].push(val);\n          tcnt = tcnt + cnt;\n        }\n      }\n\n      ;\n\n      if (tcnt < nrec) {\n        // insert undefined...\n        val = \"\";\n\n        if (state.Path.trash.rest[key] !== undefined) {\n          // check if null is trash\n          //console.log(\"Trash (\",key,\"):\",JSON.stringify(state.Path.trash.rest[key]));\n          if (state.Path.trash.rest[key].indexOf(val) === -1) {\n            // value not in trash\n            //console.log(\"Adding blank to:\",key,\"(state,\",this.keyCnt[key],dlen,\")\");\n            this.values[key].push(val);\n          }\n\n          ;\n        } else {\n          this.values[key].push(val);\n        }\n      }\n\n      ;\n    }\n  };\n\n  this.initKeyCnt = function (state) {\n    this.values = {};\n    this.keyCnt = {};\n  };\n\n  this.mapKeyCnt = function (state, where, nrec, keys) {\n    if (keys !== undefined) {\n      var plen = keys.length;\n\n      for (var ii = 0; ii < plen; ii++) {\n        var key = keys[ii];\n        this.cntKey(state, key, nrec, where);\n      }\n    }\n\n    ;\n  };\n\n  this.updateKeyCnt = function (state, key) {\n    if (this.keyCnt[key] === undefined) {\n      this.keyCnt[key] = 1;\n      this.values[key] = [];\n    } else {\n      this.keyCnt[key]++;\n    }\n  };\n\n  this.updateValues = function (state, key, val) {\n    if (val !== undefined && this.values[key].indexOf(val) === -1) {\n      // value not in range\n      //console.log(\"Checking val=\",JSON.stringify(val),\" key=\",key,\" doc=\",JSON.stringify(doc));\n      //console.log(\"range=\",state.Utils.toString(state.Path.trash.values));\n      if (state.Path.trash.rest[key] !== undefined) {\n        if (state.Path.trash.values[key] === undefined) {\n          state.Path.trash.values[key] = [];\n        }\n\n        ; //console.log(\"Checking 2:\",JSON.stringify(val),key,state.Utils.toString(state.Path.trash.values));\n\n        if (state.Path.trash.values[key].indexOf(val) === -1) {\n          // value not in trash\n          this.values[key].push(val); // add value to range\n          //console.log(\"Checking trash 3:\",val,state.Utils.toString(state.Path.trash.values[key]));\n        } else {//console.log(\"Found trash.\",val,key,state.Utils.toString(state.Path.trash.values[key]));\n          }\n      } else {\n        this.values[key].push(val);\n      }\n    }\n\n    ;\n  }; // add \"undefined\" range of keys that are not present in every doc...\n\n\n  this.completeValues = function (state, key, dlen) {\n    if (this.keyCnt[key] < dlen) {\n      var val = \"\";\n\n      if (state.Path.trash.rest[key] !== undefined) {\n        // check if null is trash\n        //console.log(\"Trash (\",key,\"):\",JSON.stringify(state.Path.trash.rest[key]));\n        if (state.Path.trash.rest[key].indexOf(val) === -1) {\n          // value not in trash\n          //console.log(\"Adding blank to:\",key,\"(state,\",this.keyCnt[key],dlen,\")\");\n          this.values[key].push(val);\n        }\n\n        ;\n      } else {\n        this.values[key].push(val);\n      }\n    }\n  }; // parent path keys are always present (undefined parents can be used)...\n\n\n  this.addPathKeyCntValues = function (state) {\n    var plen = state.Path.keys.path.length;\n\n    for (var ii = 0; ii < plen; ii++) {\n      var key = state.Path.keys.path[ii];\n\n      if (this.keyCnt[key] === undefined) {\n        this.keyCnt[key] = 0;\n        this.values[key] = [];\n      }\n    }\n  };\n\n  this.posToVal = function (state, pos, min, max) {\n    var dmin = 0.01;\n    var res = this.resolution - 1;\n\n    if (pos !== undefined && min !== undefined && max !== undefined) {\n      var ret;\n      var dlon = (max - min) / res;\n\n      if (Math.abs(state, dlon) < dmin) {\n        ret = (min + max) / 2;\n      } else {\n        var dbor = dlon / 2;\n        var val = (Number(pos) + 0.5) * dlon + min - dbor;\n        ret = Math.floor(state, val * 1000 + 0.5) / 1000;\n      }\n\n      return ret.toString();\n    }\n  };\n\n  this.valToPos = function (state, val, min, max) {\n    var dmin = 0.01;\n    var res = this.resolution - 1;\n\n    if (val !== undefined && min !== undefined && max !== undefined) {\n      var dlon = (max - min) / res;\n\n      if (Math.abs(state, dlon) < dmin) {\n        return Math.floor(state, res / 2);\n      } else {\n        var dbor = dlon / 2;\n        var pos = (Number(val) - min + dbor) / dlon; //console.log(\"ValToPos:\",pos,Number(val)-min+dbor,dlon);\n\n        return Math.max(0, Math.min(res, Math.floor(state, pos)));\n      }\n    }\n  };\n\n  this.lonToPos = function (state, val) {\n    var min = this.area.minlon;\n    var max = this.area.maxlon;\n    return this.valToPos(state, val, min, max);\n  };\n\n  this.posToLon = function (state, pos) {\n    var min = this.area.minlon;\n    var max = this.area.maxlon;\n    return this.posToVal(state, pos, min, max);\n  };\n\n  this.latToPos = function (state, val) {\n    var min = this.area.minlat;\n    var max = this.area.maxlat;\n    return this.valToPos(state, val, min, max);\n  };\n\n  this.posToLat = function (state, pos) {\n    var min = this.area.minlat;\n    var max = this.area.maxlat;\n    return this.posToVal(state, pos, min, max);\n  };\n\n  this.makeMapRange = function (state) {\n    this.values[\"_lat\"] = [];\n    var ii;\n\n    for (ii = 0; ii < this.resolution; ii++) {\n      var lat = this.posToLat(state, this.resolution - ii - 1); //console.log(\"Values _lat:\",ii,lat)\n\n      this.values[\"_lat\"].push(lat);\n    }\n\n    this.values[\"_lon\"] = [];\n\n    for (ii = 0; ii < this.resolution; ii++) {\n      var lon = this.posToLon(state, ii); //console.log(\"Values _lon:\",ii,lon)\n\n      this.values[\"_lon\"].push(lon);\n    }\n  };\n\n  this.getLonWhere = function (state, keylon, arr, poslon) {\n    var lon = arr[poslon];\n    var min = Number(arr[0]);\n    var max = Number(arr[arr.length - 1]);\n    var pos = this.valToPos(state, lon, min, max);\n    var lonmin = this.posToVal(state, pos - 0.5, min, max);\n    var lonmax = this.posToVal(state, pos + 0.5, min, max);\n\n    if (lonmin < lonmax) {\n      return '' + keylon + ' >= ' + lonmin + ' and ' + keylon + ' < ' + lonmax + '';\n    } else {\n      return '' + keylon + ' >= ' + lonmax + ' and ' + keylon + ' < ' + lonmin + '';\n    }\n  };\n\n  this.getLatWhere = function (state, keylat, arr, poslat) {\n    var lat = arr[poslat];\n    var min = Number(arr[0]);\n    var max = Number(arr[arr.length - 1]);\n    var pos = this.valToPos(state, lat, min, max);\n    var latmin = this.posToVal(state, pos - 0.5, min, max);\n    var latmax = this.posToVal(state, pos + 0.5, min, max);\n    var res = this.resolution - 1;\n    var dlon = (max - min) / res;\n    var dbor = dlon / 2; //var val=( (Number(pos)+0.5) * dlon ) + min - dbor;\n    //var ret=Math.floor(state,val*1000+0.5)/1000;\n\n    var xpos = (Number(lat) - min + dbor) / dlon;\n    console.log(\"GetLatWhere:\", lat, poslat, pos, xpos, min, max, \" lat=\", lat, latmin, latmax, \" d=\", dbor, dlon);\n\n    if (latmin < latmax) {\n      return '' + keylat + ' >= ' + latmin + ' and ' + keylat + ' < ' + latmax + '';\n    } else {\n      return '' + keylat + ' >= ' + latmax + ' and ' + keylat + ' < ' + latmin + '';\n    }\n  };\n\n  this.addMapKeys = function (state, docs) {\n    //var maxlat,minlat,maxlon,minlon;\n    var dlen = docs.length;\n\n    for (var ii = 0; ii < dlen; ii++) {\n      var doc = docs[ii]; //var vals=[];\n      //var lat=docs[\"lat\"];\n\n      var latpos = this.latToPos(state, doc.lat);\n      var ilat = this.posToLat(state, latpos); //var lon=docs[\"lon\"];\n\n      var lonpos = this.lonToPos(state, doc.lon);\n      var ilon = this.posToLon(state, lonpos);\n      doc._lat = ilat;\n      doc._lon = ilon; //console.log(\"Trash doc=\",ii,JSON.stringify(doc));\n    }\n  };\n\n  this.mapKeys = function (state, docs) {\n    var key;\n    var maxlat, minlat, maxlon, minlon;\n    var dlen = docs.length;\n\n    for (var ii = 0; ii < dlen; ii++) {\n      var doc = docs[ii]; //console.log(\"Trash doc=\",ii,JSON.stringify(doc));\n      //var vals=[];\n\n      for (key in doc) {\n        // loop over keys in each doc\n        this.updateKeyCnt(state, key);\n        var val = this.getDocVal(state, doc, key);\n        this.updateValues(state, key, val);\n\n        if (key === \"lat\") {\n          if (maxlat === undefined) {\n            maxlat = val;\n          } else {\n            maxlat = Math.max(val, maxlat);\n          }\n\n          ;\n\n          if (minlat === undefined) {\n            minlat = val;\n          } else {\n            minlat = Math.min(val, minlat);\n          }\n\n          ;\n          this.updateKeyCnt(state, \"_lat\");\n        } else if (key === \"lon\") {\n          if (maxlon === undefined) {\n            maxlon = val;\n          } else {\n            maxlon = Math.max(val, maxlon);\n          }\n\n          ;\n\n          if (minlon === undefined) {\n            minlon = val;\n          } else {\n            minlon = Math.min(val, minlon);\n          }\n\n          ;\n          this.updateKeyCnt(state, \"_lon\");\n        }\n      }\n\n      ;\n    }\n\n    this.area = {\n      minlat: minlat,\n      maxlat: maxlat,\n      minlon: minlon,\n      maxlon: maxlon\n    }; // make lat-lon range\n\n    this.makeMapRange(state); // add \"undefined\" range of keys that are not present in every doc...\n\n    for (key in this.keyCnt) {\n      this.completeValues(state, key, dlen);\n    }\n\n    ;\n    this.addPathKeyCntValues(state);\n  };\n\n  this.makeMatrixCnt = function (state, docs, matrix) {\n    //var lonmin,lonmax,latmin,latmax;\n    var found = false;\n    var colkey = state.Path.getColKey(state);\n    var rowkey = state.Path.getRowKey(state);\n    this.levCnt = {}; //var pos=[];\n\n    var dlen = docs.length;\n\n    for (var ii = 0; ii < dlen; ii++) {\n      var doc = docs[ii];\n      var colval = this.getDocVal(state, doc, colkey);\n      var rowval = this.getDocVal(state, doc, rowkey);\n      var cnt = this.getDocVal(state, doc, \"cnt\");\n      var lev = this.getDocVal(state, doc, \"lev\");\n      var minlon = this.getDocVal(state, doc, \"minlon\");\n      var maxlon = this.getDocVal(state, doc, \"maxlon\");\n      var minlat = this.getDocVal(state, doc, \"minlat\");\n      var maxlat = this.getDocVal(state, doc, \"maxlat\"); //if (lonmin === undefined || minlon < lonmin) {\n      //\tlonmin=minlon\n      //};\n      //if (latmin === undefined || minlat < latmin) {\n      //\tlatmin=minlat\n      //};\n      // find matrix array element\n\n      var arr = this.makeMatrixElement(state, colval, rowval, matrix); // update matrix array element\n      //console.log (\"Processing:\",JSON.stringify(pos),pos.length,JSON.stringify(doc));\n\n      if (lev !== -1) {\n        found = true;\n      }\n\n      if (arr !== undefined) {\n        arr.lev = lev;\n        arr.cnt = cnt;\n        arr.docs = [];\n      }\n    }\n\n    if (!found) {\n      console.log(\"this.makeMatrix No relevant thresholds found.\");\n      alert(state, \"this.makeMatrix No relevant thresholds found.\");\n    }\n\n    this.area = {\n      minlat: minlat,\n      maxlat: maxlat,\n      minlon: minlon,\n      maxlon: maxlon\n    };\n    this.makeMapRange(state);\n  };\n\n  this.makeMatrix = function (state, docs, matrix) {\n    var found = false;\n    var colkey = state.Path.getColKey(state);\n    var rowkey = state.Path.getRowKey(state);\n    this.levCnt = {}; //var pos=[];\n\n    var dlen = docs.length;\n\n    for (var ii = 0; ii < dlen; ii++) {\n      var doc = docs[ii];\n      var colval = this.getDocVal(state, doc, colkey);\n      var rowval = this.getDocVal(state, doc, rowkey); //console.log(\"Found doc:\",colval,rowval,doc[\"lon\"],doc[\"lat\"])\n      // find matrix array element\n\n      var arr = this.makeMatrixElement(state, colval, rowval, matrix); // update matrix array element\n      //console.log (\"Processing:\",JSON.stringify(pos),pos.length,JSON.stringify(doc));\n\n      state.Threshold.setGThr(state, doc);\n      var dlev = state.Threshold.getLevel(state, doc);\n\n      if (dlev !== -1) {\n        found = true;\n      }\n\n      this.updateLevCnt(state, colval, dlev);\n      this.updateLevCnt(state, rowval, dlev);\n      this.updateMatrixElement(state, arr, dlev, doc);\n    }\n\n    if (!found) {\n      console.log(\"this.makeMatrix No relevant thresholds found.\");\n      alert(state, \"this.makeMatrix No relevant thresholds found.\");\n    }\n  };\n\n  this.updateLevCnt = function (state, val, lev) {\n    if (this.levCnt[val] === undefined) {\n      this.levCnt[val] = {};\n    }\n\n    ;\n\n    if (this.levCnt[val][lev] === undefined) {\n      this.levCnt[val][lev] = 0;\n    }\n\n    ;\n    this.levCnt[val][lev] = this.levCnt[val][lev] + 1;\n  };\n\n  this.makeMatrixElement = function (state, colval, rowval, matrix) {\n    if (matrix[colval] === undefined) {\n      matrix[colval] = {};\n    }\n\n    ;\n\n    if (matrix[colval][rowval] === undefined) {\n      matrix[colval][rowval] = {};\n    }\n\n    ;\n    return matrix[colval][rowval];\n  };\n\n  this.getMatrixElement = function (colval, rowval, matrix) {\n    if (matrix[colval] !== undefined && matrix[colval][rowval] !== undefined) {\n      return matrix[colval][rowval];\n    }\n\n    return;\n  };\n\n  this.getDocVal = function (state, doc, key) {\n    var val = doc[key];\n\n    if (val === undefined) {\n      val = \"\";\n    }\n\n    ;\n    return val;\n  };\n\n  this.updateMatrixElement = function (state, arr, dlev, doc) {\n    // called once for every hit\n    //console.log (\"Updating:\",JSON.stringify(arr));\n    if (arr === undefined) {\n      console.log(\"Undefined matrix element.\");\n      return;\n    }\n\n    ;\n    var nn = arr.cnt || 0;\n\n    if (arr.lev === undefined || arr.lev === -1 || dlev !== -1 && arr.lev < dlev) {\n      arr.lev = dlev;\n    }\n\n    ;\n    arr.cnt = nn + 1;\n\n    if (arr.docs === undefined) {\n      arr.docs = [];\n    }\n\n    ;\n\n    if (arr.cnt < this.limit) {\n      arr.docs.push(doc);\n    }\n\n    ;\n  };\n\n  this.getRange = function (state, matrix, colvalues, rowvalues) {\n    var range; //console.log(\"Thresholds:\",JSON.stringify(state.Threshold.thrs));\n\n    range = undefined;\n    var slenx = colvalues.length;\n\n    for (var ii = 0; ii < slenx; ii++) {\n      var sleny = rowvalues.length;\n\n      for (var jj = 0; jj < sleny; jj++) {\n        var element = this.getMatrixElement(state, colvalues[ii], rowvalues[jj], matrix);\n\n        if (element !== undefined) {\n          //console.log(\"Looking for range:\",ii,\"='\",colvalues[ii],\"' \",\n          //                                 jj,\"='\",rowvalues[jj],\"'\",\n          //\t    JSON.stringify(m));\n          var docs = element.docs;\n\n          if (docs !== undefined) {\n            var dlen = docs.length;\n\n            for (var dd = 0; dd < dlen; dd++) {\n              var doc = docs[dd];\n              var thrs = state.Threshold.getThresholds(doc);\n\n              for (var tkey in thrs) {\n                var tt = thrs[tkey];\n                var max = tt[state.Threshold.imax];\n                var thr = tt[state.Threshold.ithr];\n                var key = tt[state.Threshold.ikey]; //var lev   = tt[state.Threshold.ilev];\n\n                var val = tt[state.Threshold.ival];\n                range = this.setRange(range, val);\n                var ts, dr;\n\n                if (max) {\n                  ts = state.Threshold.thrs[thr][key].max;\n                  dr = ts[0] - ts[ts.length - 1];\n\n                  if (ts[ts.length - 1] > 0 && ts[ts.length - 1] - dr < 0) {\n                    // include zero\n                    range = this.setRange(range, 0);\n                  } //console.log(\"Found max:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n\n                } else {\n                  ts = state.Threshold.thrs[thr][key].min;\n                  dr = ts[ts.length - 1] - ts[0];\n\n                  if (ts[ts.length - 1] < 0 && ts[ts.length - 1] + dr > 0) {\n                    // include zero\n                    range = this.setRange(range, 0);\n                  } //console.log(\"Found min:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n\n                }\n\n                range = this.setRange(range, ts[0]); // include lowest level\n\n                range = this.setRange(range, ts[ts.length - 1]); // include highest level\n                //console.log(\"After adjustment:\",tlev,ts.length,JSON.stringify(ts[tlev]),\"range=\",JSON.stringify(range));\n              }\n            }\n          } else {\n            console.log(\"No documents found:\", JSON.stringify(colvalues[ii]), JSON.stringify(rowvalues[jj]));\n          }\n        }\n      }\n    } //console.log(\"Initial range:\",JSON.stringify(range));\n\n\n    range = this.adjustRange(range); //console.log(\"Final range:\",JSON.stringify(range));\n\n    return range;\n  };\n\n  this.setRange = function (range, val) {\n    //console.log(\"SetRange Start:\",JSON.stringify(range),val);\n    if (range === undefined) {\n      range = [val, val];\n    } else {\n      range = [Math.min(val, range[0]), Math.max(val, range[1])];\n    }\n\n    ; //console.log(\"SetRange Final:\",JSON.stringify(range),val);\n\n    return range;\n  };\n\n  this.adjustRange = function (range) {\n    if (range !== undefined) {\n      //console.log(\"Adjusting:\",JSON.stringify(range));\n      var dx = range[1] - range[0];\n      range = [range[0] - dx * 0.01, range[1] + dx * 0.01];\n\n      if (range[0] > 0 && range[0] - dx < 0) {\n        range[0] = 0;\n      }\n\n      if (range[1] < 0 && range[1] + dx > 0) {\n        range[1] = 0;\n      } //console.log(\"Result:\",JSON.stringify(range));\n\n\n      return range;\n    }\n  };\n\n  this.sortMatrixValues = function (state) {\n    var tlen = state.Path.other.table.length; //console.log(\"this.sortMatrixValues row/column:\",JSON.stringify(state.Path.other.table),tlen);\n    // sort values\n\n    for (var jj = 0; jj < tlen; jj++) {\n      var key = state.Path.other.table[jj]; //console.log(\"Key:\",key,\"Values:\",JSON.stringify(this.values[key]),jj,\n      //\t    \" sort:\",JSON.stringify(state.Database.keyCnt));\n\n      if (state.Database.keyCnt[key].order === state.Database.casc) {\n        this.values[key] = this.values[key].sort(state.Utils.ascending);\n      } else if (state.Database.keyCnt[key].order === state.Database.nasc) {\n        this.values[key] = this.values[key].sort(state.Utils.descendingN);\n      } else if (state.Database.keyCnt[key].order === state.Database.cdes) {\n        this.values[key] = this.values[key].sort(state.Utils.descending);\n      } else if (state.Database.keyCnt[key].order === state.Database.ndes) {\n        this.values[key] = this.values[key].sort(state.Utils.descendingN);\n      }\n\n      ; //console.log(\"Sorted keys:\",key,JSON.stringify(this.values[key]),state.Database.keyCnt[key].order);\n      // override sort\n\n      if (state.Path.order !== undefined && state.Path.order[key] !== undefined) {\n        // we have a predefined order\n        var buff = [];\n        var olen = state.Path.order[key].length;\n        var kk, val; //console.log(\"Order length:\",olen,jj);\n        // add ordered values (not in trash)\n\n        for (kk = 0; kk < olen; kk++) {\n          val = state.Path.order[key][kk];\n\n          if (this.values[key].indexOf(val) !== -1) {\n            if (state.Path.trash.values === undefined || state.Path.trash.values[key] === undefined || state.Path.trash.values[key].indexOf(val) === -1) {\n              // not in trash\n              //console.log(\"Adding:\",kk,val);\n              buff.push(val);\n            }\n          }\n        } // add remaining this.values values (not in trash)\n\n\n        var rlen = this.values[key].length;\n\n        for (kk = 0; kk < rlen; kk++) {\n          val = this.values[key][kk];\n\n          if (buff.indexOf(val) === -1) {\n            // not in sub\n            if (state.Path.trash.values === undefined || state.Path.trash.values[key] === undefined || state.Path.trash.values[key].indexOf(val) === -1) {\n              // not in trash\n              buff.push(val);\n              state.Path.order[key].push(val);\n            }\n          }\n        }\n\n        ;\n        this.values[key] = buff; // use requested order\n        //console.log(\"Using requested order:\",key);\n      }\n\n      ; //console.log(\"Found values:\",key,JSON.stringify(this.values[key]));\n    }\n\n    ;\n  };\n\n  this.sortedKeys = function (state, obj) {\n    var key;\n    var skeys = [];\n\n    for (key in obj) {\n      if (obj.hasOwnProperty(key)) {\n        skeys.push(key);\n      }\n    }\n\n    ;\n    skeys = skeys.sort(state.Utils.ascending);\n    var ks = [];\n    var slen = skeys.length;\n\n    for (var jj = 0; jj < slen; jj++) {\n      key = skeys[jj];\n\n      if (key.substr(state, 0, 1) !== \"_\" && ks.indexOf(key) === -1) {\n        ks.push(key);\n      }\n    } //console.log(\"state.Utils.sortedKeys...\",JSON.stringify(skeys),JSON.stringify(ks));\n\n\n    return ks;\n  };\n}\n\n;\nexport default Matrix;","map":{"version":3,"sources":["/home/franktt/react/varseltavle/src/lib/MatrixLib.js"],"names":["Matrix","cnt","keyCnt","levCnt","values","limit","resolution","area","popSingle","popSeries","init","state","par","Utils","version","cntKey","key","nrec","where","val","undefined","Path","ignore","indexOf","tcnt","docs","Database","getKeyCnt","dlen","length","jj","doc","push","trash","rest","initKeyCnt","mapKeyCnt","keys","plen","ii","updateKeyCnt","updateValues","completeValues","addPathKeyCntValues","path","posToVal","pos","min","max","dmin","res","ret","dlon","Math","abs","dbor","Number","floor","toString","valToPos","lonToPos","minlon","maxlon","posToLon","latToPos","minlat","maxlat","posToLat","makeMapRange","lat","lon","getLonWhere","keylon","arr","poslon","lonmin","lonmax","getLatWhere","keylat","poslat","latmin","latmax","xpos","console","log","addMapKeys","latpos","ilat","lonpos","ilon","_lat","_lon","mapKeys","getDocVal","makeMatrixCnt","matrix","found","colkey","getColKey","rowkey","getRowKey","colval","rowval","lev","makeMatrixElement","alert","makeMatrix","Threshold","setGThr","dlev","getLevel","updateLevCnt","updateMatrixElement","getMatrixElement","nn","getRange","colvalues","rowvalues","range","slenx","sleny","element","dd","thrs","getThresholds","tkey","tt","imax","thr","ithr","ikey","ival","setRange","ts","dr","JSON","stringify","adjustRange","dx","sortMatrixValues","tlen","other","table","order","casc","sort","ascending","nasc","descendingN","cdes","descending","ndes","buff","olen","kk","rlen","sortedKeys","obj","skeys","hasOwnProperty","ks","slen","substr"],"mappings":"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","sourcesContent":["//console.log(\"Loading MatrixLib.js\");\n\nfunction Matrix() {\n    this.cnt=0;\n    this.keyCnt={};\n    this.levCnt={};\n    this.values={};\n    this.limit=50;     // displayed data\n    this.resolution=20; // map resolution\n    this.area={};\n    this.popSingle=20000;\n    this.popSeries=50000;\n    this.init=function(state){\n\tvar par=\"Matrix\"+state.Utils.version;\n\tstate.Utils.init(par,this);\n    };\n    this.cntKey=function(state,key,nrec,where) {\n\tvar val;\n\tif (this.values[key]  === undefined) {\n\t    this.keyCnt[key]=0;\n\t    this.values[key]=[];\n\t}\n\tif (state.Path.ignore.indexOf(key)  === -1) {//ignore special words... \n\t    var tcnt=0;\n\t    var docs=state.Database.getKeyCnt(state,key,where)\n\t    //console.log(\"Count:\",sql,JSON.stringify(docs));\n\t    var dlen = docs.length;\n\t    for (var jj = 0; jj < dlen; jj++) {\n    \t\tvar doc=docs[jj];\n    \t\tval=doc[key];\n\t\tvar cnt=doc.cnt;\n\t\tif (val !== undefined) {\n\t\t    //console.log(\"Found key:\",key,this.getDocVal(state,doc,key));\n    \t\t    this.keyCnt[key]=this.keyCnt[key]+cnt;\n\t\t    this.values[key].push(val);\n\t\t    tcnt=tcnt+cnt;\n\t\t}\n\t    };\n\t    if (tcnt < nrec) { // insert undefined...\n\t\tval=\"\";\n\t\tif (state.Path.trash.rest[key] !== undefined) { // check if null is trash\n\t\t    //console.log(\"Trash (\",key,\"):\",JSON.stringify(state.Path.trash.rest[key]));\n\t\t    if (state.Path.trash.rest[key].indexOf(val)  === -1) { // value not in trash\n\t\t\t//console.log(\"Adding blank to:\",key,\"(state,\",this.keyCnt[key],dlen,\")\");\n\t\t\tthis.values[key].push(val);\n\t\t    };\n\t\t} else {\n\t\t    this.values[key].push(val);\n\t\t}\n\t    };\n\t}\n    };\n    this.initKeyCnt=function(state) {\n\tthis.values={};\n\tthis.keyCnt={};\n    };\n    this.mapKeyCnt=function(state,where,nrec,keys) {\n\tif (keys !== undefined) {\n\t    var plen = keys.length;\n\t    for (var ii = 0; ii < plen; ii++) {\n\t\tvar key=keys[ii];\n\t\tthis.cntKey(state,key,nrec,where);\n\t    }\n\t};\n    };\n    this.updateKeyCnt=function(state,key){\n\tif (this.keyCnt[key]  === undefined) {\n    \t    this.keyCnt[key]=1;\n\t    this.values[key]=[];\n\t} else {\n    \t    this.keyCnt[key]++;\n\t}\n    };\n    this.updateValues=function(state,key,val) {\n\tif ( val !== undefined &&\n\t     this.values[key].indexOf(val)  === -1 ) { // value not in range\n\t\t//console.log(\"Checking val=\",JSON.stringify(val),\" key=\",key,\" doc=\",JSON.stringify(doc));\n\t\t//console.log(\"range=\",state.Utils.toString(state.Path.trash.values));\n\t\tif (state.Path.trash.rest[key] !== undefined) {\n\t\t    if (state.Path.trash.values[key]  === undefined) {state.Path.trash.values[key]=[];};\n\t\t    //console.log(\"Checking 2:\",JSON.stringify(val),key,state.Utils.toString(state.Path.trash.values));\n\t\t    if (state.Path.trash.values[key].indexOf(val)  === -1) { // value not in trash\n    \t\t\tthis.values[key].push(val); // add value to range\n\t\t\t//console.log(\"Checking trash 3:\",val,state.Utils.toString(state.Path.trash.values[key]));\n\t\t    } else {\n\t\t\t//console.log(\"Found trash.\",val,key,state.Utils.toString(state.Path.trash.values[key]));\n\t\t    }\n\t\t} else {\n    \t\t    this.values[key].push(val);\n\t\t}\n\t};\n    }\n\n    // add \"undefined\" range of keys that are not present in every doc...\n    this.completeValues=function(state,key,dlen){\n\tif (this.keyCnt[key] < dlen) {\n\t    var val=\"\";\n\t    if (state.Path.trash.rest[key] !== undefined) { // check if null is trash\n\t\t//console.log(\"Trash (\",key,\"):\",JSON.stringify(state.Path.trash.rest[key]));\n\t\tif (state.Path.trash.rest[key].indexOf(val)  === -1) { // value not in trash\n\t\t    //console.log(\"Adding blank to:\",key,\"(state,\",this.keyCnt[key],dlen,\")\");\n\t\t    this.values[key].push(val);\n\t\t};\n\t    } else {\n\t\tthis.values[key].push(val);\n\t    }\n\t}\n    }\n\n    // parent path keys are always present (undefined parents can be used)...\n    this.addPathKeyCntValues=function(state) {\n\tvar plen = state.Path.keys.path.length;\n\tfor (var ii = 0; ii < plen; ii++) {\n\t    var key=state.Path.keys.path[ii];\n\t    if (this.keyCnt[key]  === undefined) {\n    \t\tthis.keyCnt[key]=0;\n\t\tthis.values[key]=[];\n\t    }\n\t}\n    };\n    this.posToVal=function(state,pos,min,max) {\n\tvar dmin=0.01;\n\tvar res=this.resolution-1;\n\tif (pos !== undefined &&\n\t    min !== undefined &&\n\t    max !== undefined ) {\n\t    var ret;\n\t    var dlon=(max-min)/res;\n\t    if (Math.abs(state,dlon) < dmin) {\n\t\tret=(min+max)/2;\n\t    } else {\n\t\tvar dbor=dlon/2;\n\t\tvar val=( (Number(pos)+0.5) * dlon ) + min - dbor;\n\t\tret=Math.floor(state,val*1000+0.5)/1000;\n\t    }\n\t    return ret.toString();\n\t}\n    };\n    this.valToPos=function(state,val,min,max) {\n\tvar dmin=0.01;\n\tvar res=this.resolution-1;\n\tif (val !== undefined &&\n\t    min !== undefined &&\n\t    max !== undefined ) {\n\t    var dlon=(max-min)/res;\n\t    if (Math.abs(state,dlon) < dmin) {\n\t\treturn Math.floor(state,res/2);\n\t    } else {\n\t\tvar dbor=dlon/2;\n\t\tvar pos=(Number(val) - min + dbor)/dlon;\n\t\t//console.log(\"ValToPos:\",pos,Number(val)-min+dbor,dlon);\n\t\treturn Math.max(0,Math.min(res,Math.floor(state,pos)))\n\t    }\n\t}\n    };\n    this.lonToPos=function(state,val) {\n\tvar min=this.area.minlon;\n\tvar max=this.area.maxlon;\n\treturn this.valToPos(state,val,min,max)\n    };\n    this.posToLon=function(state,pos) {\n\tvar min=this.area.minlon;\n\tvar max=this.area.maxlon;\n\treturn this.posToVal(state,pos,min,max)\n    };\n    this.latToPos=function(state,val) {\n\tvar min=this.area.minlat;\n\tvar max=this.area.maxlat;\n\treturn this.valToPos(state,val,min,max)\n    };\n    this.posToLat=function(state,pos) {\n\tvar min=this.area.minlat;\n\tvar max=this.area.maxlat;\n\treturn this.posToVal(state,pos,min,max)\n    };\n    this.makeMapRange=function(state){\n\tthis.values[\"_lat\"]=[];\n\tvar ii;\n\tfor (ii=0;ii<this.resolution;ii++) {\n\t    var lat=this.posToLat(state,this.resolution-ii-1);\n\t    //console.log(\"Values _lat:\",ii,lat)\n\t    this.values[\"_lat\"].push(lat);\n\t}\n\tthis.values[\"_lon\"]=[];\n\tfor (ii=0;ii<this.resolution;ii++) {\n\t    var lon=this.posToLon(state,ii);\n\t    //console.log(\"Values _lon:\",ii,lon)\n\t    this.values[\"_lon\"].push(lon);\n\t}\n    };\n    this.getLonWhere=function(state,keylon,arr,poslon) {\n\tvar lon=arr[poslon];\n\tvar min=Number(arr[0]);\n\tvar max=Number(arr[arr.length-1]);\n\tvar pos=this.valToPos(state,lon,min,max);\n\tvar lonmin=this.posToVal(state,pos-0.5,min,max);\n\tvar lonmax=this.posToVal(state,pos+0.5,min,max);\n\tif (lonmin < lonmax) {\n\t    return ''+keylon+' >= '+lonmin+' and '+keylon+ ' < '+lonmax+'';\n\t} else {\n\t    return ''+keylon+' >= '+lonmax+' and '+keylon+ ' < '+lonmin+'';\n\t}\n    };\n    this.getLatWhere=function(state,keylat,arr,poslat) {\n\tvar lat=arr[poslat];\n\tvar min=Number(arr[0]);\n\tvar max=Number(arr[arr.length-1]);\n\tvar pos=this.valToPos(state,lat,min,max);\n\tvar latmin=this.posToVal(state,pos-0.5,min,max);\n\tvar latmax=this.posToVal(state,pos+0.5,min,max);\n\n\tvar res=this.resolution-1;\n\tvar dlon=(max-min)/res;\n\tvar dbor=dlon/2;\n\t//var val=( (Number(pos)+0.5) * dlon ) + min - dbor;\n\t//var ret=Math.floor(state,val*1000+0.5)/1000;\n\tvar xpos=(Number(lat) - min + dbor)/dlon;\n\n\tconsole.log(\"GetLatWhere:\",lat,poslat,pos,xpos,min,max,\" lat=\",lat,latmin,latmax,\" d=\",dbor,dlon);\n\n\tif (latmin < latmax) {\n\t    return ''+keylat+' >= '+latmin+' and '+keylat+ ' < '+latmax+'';\n\t} else {\n\t    return ''+keylat+' >= '+latmax+' and '+keylat+ ' < '+latmin+'';\n\t}\n    };\n    this.addMapKeys=function(state,docs) {\n\t//var maxlat,minlat,maxlon,minlon;\n\tvar dlen = docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n    \t    //var vals=[];\n\t    //var lat=docs[\"lat\"];\n\t    var latpos=this.latToPos(state,doc.lat);\n\t    var ilat=this.posToLat(state,latpos);\n\t    //var lon=docs[\"lon\"];\n\t    var lonpos=this.lonToPos(state,doc.lon);\n\t    var ilon=this.posToLon(state,lonpos);\n\t    doc._lat=ilat\n\t    doc._lon=ilon\n\t    //console.log(\"Trash doc=\",ii,JSON.stringify(doc));\n\t}\n    };\n    this.mapKeys=function(state,docs) {\n\tvar key;\n\tvar maxlat,minlat,maxlon,minlon;\n\tvar dlen = docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n\t    //console.log(\"Trash doc=\",ii,JSON.stringify(doc));\n    \t    //var vals=[];\n    \t    for (key in doc) { // loop over keys in each doc\n\t\tthis.updateKeyCnt(state,key);\n\t\tvar val=this.getDocVal(state,doc,key);\n\t\tthis.updateValues(state,key,val)\n\t\tif (key  === \"lat\") {\n\t\t    if (maxlat  === undefined) {\n\t\t\tmaxlat=val\n\t\t    }else {\n\t\t\tmaxlat=Math.max(val,maxlat)\n\t\t    };\n\t\t    if (minlat  === undefined) {\n\t\t\tminlat=val\n\t\t    }else {\n\t\t\tminlat=Math.min(val,minlat)\n\t\t    };\n\t\t    this.updateKeyCnt(state,\"_lat\");\n\t\t} else if (key  === \"lon\") {\n\t\t    if (maxlon  === undefined) {\n\t\t\tmaxlon=val\n\t\t    }else {\n\t\t\tmaxlon=Math.max(val,maxlon)\n\t\t    };\n\t\t    if (minlon  === undefined) {\n\t\t\tminlon=val\n\t\t    }else {\n\t\t\tminlon=Math.min(val,minlon)\n\t\t    };\n\t\t    this.updateKeyCnt(state,\"_lon\");\n\t\t}\n    \t    };\n\t}\n\tthis.area={minlat:minlat,maxlat:maxlat,minlon:minlon,maxlon:maxlon};\n\t// make lat-lon range\n\tthis.makeMapRange(state);\n\t// add \"undefined\" range of keys that are not present in every doc...\n\tfor (key in this.keyCnt) {this.completeValues(state,key,dlen) };\n\tthis.addPathKeyCntValues(state);\n    };\n    this.makeMatrixCnt=function(state,docs,matrix) {\n\t//var lonmin,lonmax,latmin,latmax;\n\tvar found=false;\n\tvar colkey=state.Path.getColKey(state);\n\tvar rowkey=state.Path.getRowKey(state);\n\tthis.levCnt={};\n\t//var pos=[];\n\tvar dlen=docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n\t    var colval=this.getDocVal(state,doc,colkey);\n\t    var rowval=this.getDocVal(state,doc,rowkey);\n\t    var cnt=this.getDocVal(state,doc,\"cnt\");\n\t    var lev=this.getDocVal(state,doc,\"lev\");\n\t    var minlon=this.getDocVal(state,doc,\"minlon\");\n\t    var maxlon=this.getDocVal(state,doc,\"maxlon\");\n\t    var minlat=this.getDocVal(state,doc,\"minlat\");\n\t    var maxlat=this.getDocVal(state,doc,\"maxlat\");\n\t    //if (lonmin === undefined || minlon < lonmin) {\n\t//\tlonmin=minlon\n\t    //};\n\t    //if (latmin === undefined || minlat < latmin) {\n\t//\tlatmin=minlat\n\t    //};\n    \t    // find matrix array element\n    \t    var arr=this.makeMatrixElement(state,colval,rowval,matrix);\n    \t    // update matrix array element\n    \t    //console.log (\"Processing:\",JSON.stringify(pos),pos.length,JSON.stringify(doc));\n\t    if (lev !== -1) { found=true;}\n\t    if (arr !== undefined) {\n\t\tarr.lev=lev;\n\t\tarr.cnt=cnt;\n\t\tarr.docs=[];\n\t    }\n\t}\n\tif (! found) {\n\t    console.log(\"this.makeMatrix No relevant thresholds found.\");\n\t    alert(state,\"this.makeMatrix No relevant thresholds found.\");\n\t}\n\tthis.area={minlat:minlat,maxlat:maxlat,minlon:minlon,maxlon:maxlon};\n\tthis.makeMapRange(state);\n    };\n    this.makeMatrix=function(state,docs,matrix) {\n\tvar found=false;\n\tvar colkey=state.Path.getColKey(state);\n\tvar rowkey=state.Path.getRowKey(state);\n\tthis.levCnt={};\n\t//var pos=[];\n\tvar dlen=docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n\t    var colval=this.getDocVal(state,doc,colkey);\n\t    var rowval=this.getDocVal(state,doc,rowkey);\n\t    //console.log(\"Found doc:\",colval,rowval,doc[\"lon\"],doc[\"lat\"])\n    \t    // find matrix array element\n    \t    var arr=this.makeMatrixElement(state,colval,rowval,matrix);\n    \t    // update matrix array element\n    \t    //console.log (\"Processing:\",JSON.stringify(pos),pos.length,JSON.stringify(doc));\n\t    state.Threshold.setGThr(state,doc);\n\t    var dlev=state.Threshold.getLevel(state,doc);\n\t    if (dlev !== -1) { found=true;}\n\t    this.updateLevCnt(state,colval,dlev);\n\t    this.updateLevCnt(state,rowval,dlev);\n    \t    this.updateMatrixElement(state,arr,dlev,doc);\n\t}\n\tif (! found) {\n\t    console.log(\"this.makeMatrix No relevant thresholds found.\");\n\t    alert(state,\"this.makeMatrix No relevant thresholds found.\");\n\t}\n    };\n    this.updateLevCnt=function(state,val,lev) {\n\tif (this.levCnt[val]  === undefined) { this.levCnt[val]={};};\n\tif (this.levCnt[val][lev]  === undefined) { this.levCnt[val][lev]=0;};\n\tthis.levCnt[val][lev]=this.levCnt[val][lev]+1;\n    };\n    this.makeMatrixElement=function(state,colval,rowval,matrix) {\n\tif (matrix[colval] === undefined) {matrix[colval]={};};\n\tif (matrix[colval][rowval] === undefined) {matrix[colval][rowval]={};};\n\treturn matrix[colval][rowval];\n    };\n    this.getMatrixElement=function(colval,rowval,matrix) {\n\tif (matrix[colval] !== undefined && matrix[colval][rowval] !== undefined ) {\n\t    return matrix[colval][rowval];\n\t}\n\treturn;\n    };\n    this.getDocVal=function(state,doc,key) {\n\tvar val = doc[key];if (val  === undefined) {val=\"\";};return val;\n    };\n    this.updateMatrixElement=function(state,arr,dlev,doc) { // called once for every hit\n\t//console.log (\"Updating:\",JSON.stringify(arr));\n\tif (arr  === undefined) {\n\t    console.log(\"Undefined matrix element.\");\n\t    return;\n\t};\n\tvar nn=arr.cnt||0;\n\tif (arr.lev  === undefined || arr.lev === -1 ||\n\t    (dlev !== -1 && arr.lev < dlev)) {\n\t    arr.lev=dlev;\n\t};\n\tarr.cnt=nn+1;\n\tif (arr.docs === undefined) {arr.docs=[];};\n\tif (arr.cnt < this.limit) {arr.docs.push(doc);};\n    };\n    this.getRange=function(state,matrix,colvalues,rowvalues) {\n\tvar range;\n\t//console.log(\"Thresholds:\",JSON.stringify(state.Threshold.thrs));\n\trange=undefined;\n\tvar slenx=colvalues.length;\n\tfor(var ii=0; ii<slenx; ii++) {\n\t    var sleny=rowvalues.length;\n\t    for(var jj=0; jj<sleny; jj++) {\n\t\tvar element=this.getMatrixElement(state,colvalues[ii],rowvalues[jj],matrix);\n\t\tif (element !== undefined) {\n\t\t    //console.log(\"Looking for range:\",ii,\"='\",colvalues[ii],\"' \",\n\t\t    //                                 jj,\"='\",rowvalues[jj],\"'\",\n\t\t    //\t    JSON.stringify(m));\n\t\t    var docs=element.docs;\n\t\t    if (docs !== undefined) {\n\t\t\tvar dlen = docs.length;\n\t\t\tfor (var dd = 0; dd < dlen; dd++) {\n    \t\t\t    var doc=docs[dd];\n\t\t\t    var thrs=state.Threshold.getThresholds(doc);\n\t\t\t    for (var tkey in thrs) {\n\t\t\t\tvar tt    = thrs[tkey];\n\t\t\t\tvar max   = tt[state.Threshold.imax];\n\t\t\t\tvar thr   = tt[state.Threshold.ithr];\n\t\t\t\tvar key   = tt[state.Threshold.ikey];\n\t\t\t\t//var lev   = tt[state.Threshold.ilev];\n\t\t\t\tvar val   = tt[state.Threshold.ival];\n\t\t\t\trange=this.setRange(range,val);\n\t\t\t\tvar ts,dr;\n\t\t\t\tif (max) {\n\t\t\t\t    ts=state.Threshold.thrs[thr][key].max;\n\t\t\t\t    dr=ts[0]-ts[ts.length-1];\n\t\t\t\t    if (ts[ts.length-1]>0 && ts[ts.length-1]-dr<0) { // include zero\n\t\t\t\t\trange=this.setRange(range,0);\n\t\t\t\t    }\n\t\t\t\t    //console.log(\"Found max:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n\t\t\t\t} else {\n\t\t\t\t    ts=state.Threshold.thrs[thr][key].min;\n\t\t\t\t    dr=ts[ts.length-1]-ts[0];\n\t\t\t\t    if (ts[ts.length-1]<0 && ts[ts.length-1]+dr>0) { // include zero\n\t\t\t\t\trange=this.setRange(range,0);\n\t\t\t\t    }\n\t\t\t\t    //console.log(\"Found min:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n\t\t\t\t}\n\t\t\t\trange=this.setRange(range,ts[0]); // include lowest level\n\t\t\t\trange=this.setRange(range,ts[ts.length-1]); // include highest level\n\t\t\t\t//console.log(\"After adjustment:\",tlev,ts.length,JSON.stringify(ts[tlev]),\"range=\",JSON.stringify(range));\n\t\t\t    }\n\t\t\t}\n\t\t    } else {\n\t\t\tconsole.log(\"No documents found:\",\n\t\t\t\t    JSON.stringify(colvalues[ii]),\n\t\t\t\t    JSON.stringify(rowvalues[jj]));\n\t\t    }\n\t\t}\n\t    }\n\t}\n\t//console.log(\"Initial range:\",JSON.stringify(range));\n\trange=this.adjustRange(range);\n\t//console.log(\"Final range:\",JSON.stringify(range));\n\treturn range;\n    };\n    this.setRange=function(range,val) {\n\t//console.log(\"SetRange Start:\",JSON.stringify(range),val);\n\tif (range  === undefined) {\n\t    range=[val,val];\n\t} else {\n\t    range=[Math.min(val,range[0]),Math.max(val,range[1])];\n\t};\n\t//console.log(\"SetRange Final:\",JSON.stringify(range),val);\n\treturn range;\n    };\n    this.adjustRange=function(range) {\n\tif (range !== undefined) {\n\t    //console.log(\"Adjusting:\",JSON.stringify(range));\n\t    var dx=(range[1]-range[0]);\n\t    range=[range[0]-dx*0.01,range[1]+dx*0.01];\n\t    if (range[0]>0 && range[0]-dx<0) { range[0]=0;}\n\t    if (range[1]<0 && range[1]+dx>0) { range[1]=0;}\n\t    //console.log(\"Result:\",JSON.stringify(range));\n\t    return range;\n\t}\n    };\n    this.sortMatrixValues=function(state) {\n\tvar tlen=state.Path.other.table.length;\n\t//console.log(\"this.sortMatrixValues row/column:\",JSON.stringify(state.Path.other.table),tlen);\n\t// sort values\n\tfor (var jj = 0; jj < tlen; jj++) {\n    \t    var key=state.Path.other.table[jj];\n\t    //console.log(\"Key:\",key,\"Values:\",JSON.stringify(this.values[key]),jj,\n\t    //\t    \" sort:\",JSON.stringify(state.Database.keyCnt));\n\t    if (state.Database.keyCnt[key].order  === state.Database.casc) {\n    \t\tthis.values[key]=this.values[key].sort(state.Utils.ascending);\n\t    } else if (state.Database.keyCnt[key].order  === state.Database.nasc) {\n    \t\tthis.values[key]=this.values[key].sort(state.Utils.descendingN);\n\t    } else if (state.Database.keyCnt[key].order  === state.Database.cdes) {\n    \t\tthis.values[key]=this.values[key].sort(state.Utils.descending);\n\t    } else if (state.Database.keyCnt[key].order  === state.Database.ndes) {\n    \t\tthis.values[key]=this.values[key].sort(state.Utils.descendingN);\n\t    };\n\t    //console.log(\"Sorted keys:\",key,JSON.stringify(this.values[key]),state.Database.keyCnt[key].order);\n\t    // override sort\n\t    if (state.Path.order !== undefined &&\n\t\tstate.Path.order[key] !== undefined) { // we have a predefined order\n\t\t    var buff=[];\n\t\tvar olen=state.Path.order[key].length;\n\t\tvar kk,val;\n\t\t//console.log(\"Order length:\",olen,jj);\n\t\t// add ordered values (not in trash)\n\t\tfor (kk = 0; kk < olen; kk++) {\n\t\t    val=state.Path.order[key][kk];\n\t\t    if (this.values[key].indexOf(val) !== -1) {\n\t\t\tif (state.Path.trash.values  === undefined ||\n\t\t\t    state.Path.trash.values[key]  === undefined ||\n\t\t\t    state.Path.trash.values[key].indexOf(val)  === -1) { // not in trash\n\t\t\t\t//console.log(\"Adding:\",kk,val);\n\t\t\t\tbuff.push(val);\n\t\t\t}\n\t\t    }\n\t\t}\n\t\t// add remaining this.values values (not in trash)\n\t\tvar rlen=this.values[key].length;\n\t\tfor (kk = 0; kk < rlen; kk++) {\n\t\t    val=this.values[key][kk];\n\t\t    if (buff.indexOf(val)  === -1) { // not in sub\n\t\t\tif (state.Path.trash.values === undefined ||\n\t\t\t    state.Path.trash.values[key] === undefined ||\n\t\t\t    state.Path.trash.values[key].indexOf(val)  === -1) { // not in trash\n\t\t\t\tbuff.push(val);\n\t\t\t    state.Path.order[key].push(val);\n\t\t\t}\n\t\t    }\n\t\t};\n\t\tthis.values[key]=buff; // use requested order\n\t\t//console.log(\"Using requested order:\",key);\n\t    };\n    \t    //console.log(\"Found values:\",key,JSON.stringify(this.values[key]));\n\t};\n    };\n    this.sortedKeys=function(state,obj) {\n\tvar key;\n\tvar skeys = [];\n\tfor(key in obj){\n\t    if (obj.hasOwnProperty(key)) {skeys.push(key);}\n\t};\n\tskeys=skeys.sort(state.Utils.ascending);\n\tvar ks=[];\n\tvar slen=skeys.length;\n\tfor (var jj = 0; jj < slen; jj++) {\n\t    key=skeys[jj];\n\t    if (key.substr(state,0,1) !== \"_\" && ks.indexOf(key) === -1) {\n\t\tks.push(key);\n\t    }\n\t}\n\t//console.log(\"state.Utils.sortedKeys...\",JSON.stringify(skeys),JSON.stringify(ks));\n\treturn ks;\n    }\n};\nexport default Matrix;\n"]},"metadata":{},"sourceType":"module"}