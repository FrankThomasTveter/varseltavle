{"ast":null,"code":"//console.log(\"Loading MatrixLib.js\");\nfunction Matrix(){this.cnt=0;this.keyCnt={};this.levCnt={};this.values={};this.limit=100;// displayed data\nthis.resolution=20;// map resolution\nthis.area={};this.popSingle=1000;//0000;\nthis.popSeries=5000;//0000;\nthis.init=function(state){var par=\"Matrix\";state.Utils.init(par,this);};this.cntKey=function(state,key,nrec,where){var val;if(this.values[key]===undefined){this.keyCnt[key]=0;this.values[key]=[];}if(state.Path.ignore.indexOf(key)===-1&&key!==\"\"){//ignore special words... \nvar tcnt=0;var docs=state.Database.getKeyCnt(state,key,where);//console.log(\"Count:\",sql,JSON.stringify(docs));\nvar dlen=docs.length;for(var jj=0;jj<dlen;jj++){var doc=docs[jj];val=doc[key];var cnt=doc.cnt;if(val!==undefined){//console.log(\"Found key:\",key,this.getDocVal(state,doc,key));\nthis.keyCnt[key]=this.keyCnt[key]+cnt;this.values[key].push(val);tcnt=tcnt+cnt;}};if(tcnt<nrec){// insert undefined...\nval=\"\";this.values[key].push(val);};}else if(key===\"\"){console.log(\"Key error...\",new Error().stack);}};this.initKeyCnt=function(state){this.values={};this.keyCnt={};};this.makeKeyCnt=function(state,where,nrec,keys){if(keys!==undefined){var plen=keys.length;for(var ii=0;ii<plen;ii++){var key=keys[ii];if(key!==\"\"){this.cntKey(state,key,nrec,where);}}};};this.updateKeyCnt=function(state,key){if(this.keyCnt[key]===undefined){this.keyCnt[key]=1;this.values[key]=[];}else{this.keyCnt[key]++;}};this.updateValues=function(state,key,val){if(val!==undefined&&this.values[key].indexOf(val)===-1){// value not in range\n//console.log(\"Checking val=\",JSON.stringify(val),\" key=\",key,\" doc=\",JSON.stringify(doc));\n//console.log(\"range=\",state.Utils.toString(state.Path.trash));\nthis.values[key].push(val);};};// add \"undefined\" range of keys that are not present in every doc...\nthis.addUndefinedKeyCnt=function(state,docs){var dlen=docs.length;for(var key in this.keyCnt){if(this.keyCnt[key]<dlen){var val=\"\";this.values[key].push(val);}}};// parent path keys are always present (undefined parents can be used)...\nthis.addUndefinedKeyCntValues=function(state){var plen=state.Path.keys.path.length;for(var ii=0;ii<plen;ii++){var key=state.Path.keys.path[ii];if(this.keyCnt[key]===undefined){this.keyCnt[key]=0;this.values[key]=[];}}};this.posToVal=function(state,pos,min,max){var dmin=0.01;var res=this.resolution-1;if(pos!==undefined&&min!==undefined&&max!==undefined){var ret;var dlon=(max-min)/res;if(Math.abs(dlon)<dmin){ret=(min+max)/2;}else{var dbor=dlon/2;var val=(Number(pos)+0.5)*dlon+min-dbor;ret=Math.floor(val*1000+0.5)/1000;}return ret.toString();}};this.valToPos=function(state,val,min,max){var dmin=0.01;var res=this.resolution-1;if(val!==undefined&&min!==undefined&&max!==undefined){var dlon=(max-min)/res;if(Math.abs(dlon)<dmin){return Math.floor(res/2);}else{var dbor=dlon/2;var pos=(Number(val)-min+dbor)/dlon;//console.log(\"ValToPos:\",pos,Number(val)-min+dbor,dlon);\nreturn Math.max(0,Math.min(res,Math.floor(pos)));}}};this.lonToPos=function(state,val){var min=this.area.minlon;var max=this.area.maxlon;return this.valToPos(state,val,min,max);};this.posToLon=function(state,pos){var min=this.area.minlon;var max=this.area.maxlon;return this.posToVal(state,pos,min,max);};this.latToPos=function(state,val){var min=this.area.minlat;var max=this.area.maxlat;return this.valToPos(state,val,min,max);};this.posToLat=function(state,pos){var min=this.area.minlat;var max=this.area.maxlat;return this.posToVal(state,pos,min,max);};this.makeMapRange=function(state){this.values[\"_lat\"]=[];var ii;for(ii=0;ii<this.resolution;ii++){var lat=this.posToLat(state,this.resolution-ii-1);//console.log(\"Values _lat:\",ii,lat)\nthis.values[\"_lat\"].push(lat);}this.values[\"_lon\"]=[];for(ii=0;ii<this.resolution;ii++){var lon=this.posToLon(state,ii);//console.log(\"Values _lon:\",ii,lon)\nthis.values[\"_lon\"].push(lon);}};this.getLonWhere=function(state,keylon,arr,poslon){var lon=arr[poslon];var min=Number(arr[0]);var max=Number(arr[arr.length-1]);var pos=this.valToPos(state,lon,min,max);var lonmin=this.posToVal(state,pos-0.5,min,max);var lonmax=this.posToVal(state,pos+0.5,min,max);if(lonmin<lonmax){return''+keylon+' >= '+lonmin+' and '+keylon+' < '+lonmax+'';}else{return''+keylon+' >= '+lonmax+' and '+keylon+' < '+lonmin+'';}};this.getLatWhere=function(state,keylat,arr,poslat){var lat=arr[poslat];var min=Number(arr[0]);var max=Number(arr[arr.length-1]);var pos=this.valToPos(state,lat,min,max);var latmin=this.posToVal(state,pos-0.5,min,max);var latmax=this.posToVal(state,pos+0.5,min,max);var res=this.resolution-1;var dlon=(max-min)/res;var dbor=dlon/2;//var val=( (Number(pos)+0.5) * dlon ) + min - dbor;\n//var ret=Math.floor(state,val*1000+0.5)/1000;\nvar xpos=(Number(lat)-min+dbor)/dlon;console.log(\"GetLatWhere:\",lat,poslat,pos,xpos,min,max,\" lat=\",lat,latmin,latmax,\" d=\",dbor,dlon);if(latmin<latmax){return''+keylat+' >= '+latmin+' and '+keylat+' < '+latmax+'';}else{return''+keylat+' >= '+latmax+' and '+keylat+' < '+latmin+'';}};this.addMapAreaKeys=function(state,docs){//var maxlat,minlat,maxlon,minlon;\nvar dlen=docs.length;for(var ii=0;ii<dlen;ii++){var doc=docs[ii];//var vals=[];\n//var lat=docs[\"lat\"];\nvar latpos=this.latToPos(state,doc.lat);var ilat=this.posToLat(state,latpos);//var lon=docs[\"lon\"];\nvar lonpos=this.lonToPos(state,doc.lon);var ilon=this.posToLon(state,lonpos);doc._lat=ilat;doc._lon=ilon;//console.log(\"Trash doc=\",doc.lon,lonpos,ilon,doc._lon,JSON.stringify(this.area));\n}};this.makeKeyCntMap=function(state,docs){var key;var maxlat,minlat,maxlon,minlon;var dlen=docs.length;for(var ii=0;ii<dlen;ii++){var doc=docs[ii];//console.log(\"Trash doc=\",ii,JSON.stringify(doc));\n//var vals=[];\nfor(key in doc){// loop over keys in each doc\nthis.updateKeyCnt(state,key);var val=this.getDocVal(state,doc,key);this.updateValues(state,key,val);if(key===\"lat\"){if(maxlat===undefined){maxlat=val;}else{maxlat=Math.max(val,maxlat);};if(minlat===undefined){minlat=val;}else{minlat=Math.min(val,minlat);};this.updateKeyCnt(state,\"_lat\");}else if(key===\"lon\"){if(maxlon===undefined){maxlon=val;}else{maxlon=Math.max(val,maxlon);};if(minlon===undefined){minlon=val;}else{minlon=Math.min(val,minlon);};this.updateKeyCnt(state,\"_lon\");}};}this.area={minlat:minlat,maxlat:maxlat,minlon:minlon,maxlon:maxlon};return;};this.setupMap=function(state,docs){this.makeMapArea(state,docs);this.makeMapRange(state);this.addUndefinedKeyCnt(state,docs);// add \"undefined\"\nthis.addPathKeyCntValues(state);this.addMapAreaKeys(state,docs);};this.makeMatrixCntMap=function(state,cntDocs,matrix){//console.log(\"MatrixCnt:\",JSON.stringify(cntDocs));\n//var lonmin,lonmax,latmin,latmax;\nvar found=false;var colkey=state.Path.getColKey(state);var rowkey=state.Path.getRowKey(state);this.levCnt={};//var pos=[];\nvar dlen=cntDocs.length;for(var ii=0;ii<dlen;ii++){var doc=cntDocs[ii];var colval=this.getDocVal(state,doc,colkey);var rowval=this.getDocVal(state,doc,rowkey);var cnt=this.getDocVal(state,doc,\"cnt\");var maxlev=this.getDocVal(state,doc,\"maxlev\");var maxrank=this.getDocVal(state,doc,\"maxrank\");var minlev=this.getDocVal(state,doc,\"minlev\");var minlon=this.getDocVal(state,doc,\"minlon\");var maxlon=this.getDocVal(state,doc,\"maxlon\");var minlat=this.getDocVal(state,doc,\"minlat\");var maxlat=this.getDocVal(state,doc,\"maxlat\");//if (lonmin === undefined || minlon < lonmin) {\n//\tlonmin=minlon\n//};\n//if (latmin === undefined || minlat < latmin) {\n//\tlatmin=minlat\n//};\n// find matrix array element\n//console.log (\"Processing:\",JSON.stringify(doc),maxlev,minlev,cnt);\nvar arr=this.makeMatrixElement(state,colval,rowval,matrix);// update matrix array element\nif(maxlev>=0){found=true;}if(arr!==undefined){arr.maxlev=maxlev;arr.minlev=minlev;arr.maxrank=maxrank;arr.cnt=cnt;arr.def=0;//arr.docs=[];\n//console.log (\"Array:\",JSON.stringify(arr));\n}}if(!found){console.log(\"this.makeMatrix No relevant thresholds found.\");state.Html.setFootnote(state,\"No data found.\");}if(state.Layout.state.tooltip===0){// pre-generate all tooltips\nstate.Matrix.addAllTooltip(state,matrix);};//console.log (\"Matrix:\",JSON.stringify(matrix));\nthis.area={minlat:minlat,maxlat:maxlat,minlon:minlon,maxlon:maxlon};};this.makeMatrix=function(state,docs,matrix){var found=false;var colkey=state.Path.getColKey(state);var rowkey=state.Path.getRowKey(state);this.levCnt={};//var pos=[];\nvar dlen=docs.length;for(var ii=0;ii<dlen;ii++){var doc=docs[ii];var colval=this.getDocVal(state,doc,colkey);var rowval=this.getDocVal(state,doc,rowkey);//console.log(\"Found doc:\",colval,rowval,doc[\"lon\"],doc[\"lat\"])\n// find matrix array element\nvar arr=this.makeMatrixElement(state,colval,rowval,matrix);// update matrix array element\n//console.log (\"Processing:\",JSON.stringify(pos),pos.length,JSON.stringify(doc));\nvar dlev=state.Threshold.getLevel(state,doc);if(dlev===undefined){dlev=-2;};if(dlev>=0){found=true;}this.updateLevCnt(state,colval,dlev);this.updateLevCnt(state,rowval,dlev);this.updateMatrixElement(state,arr,dlev,doc);}if(!found){console.log(\"this.makeMatrix No relevant thresholds found.\");state.Html.setFootnote(state,\"No data with valid threshold was found.\");}};this.updateLevCnt=function(state,val,lev){if(this.levCnt[val]===undefined){this.levCnt[val]={};};if(this.levCnt[val][lev]===undefined){this.levCnt[val][lev]=0;};this.levCnt[val][lev]=this.levCnt[val][lev]+1;};this.makeMatrixElement=function(state,colval,rowval,matrix){var first=false;if(matrix[colval]===undefined){first=true;matrix[colval]={};};if(matrix[colval][rowval]===undefined){first=true;matrix[colval][rowval]={};};var m=matrix[colval][rowval];if(first){m.colval=colval;m.rowval=rowval;};return m;};this.getMatrixElement=function(colval,rowval,matrix){//console.log(\"getMatrixElement:\",colval,\"|\",rowval,\"|\",JSON.stringify(matrix));\nif(matrix[colval]!==undefined&&matrix[colval][rowval]!==undefined){return matrix[colval][rowval];}return;};this.getMatrixElements=function(icolvalues,irowval,matrix,iindex,istep){var colvalues=icolvalues===undefined?undefined:icolvalues.slice();var index=iindex;var step=istep;var elements=undefined;if(colvalues===undefined){// all colvalues\ncolvalues=Object.keys(matrix);index=0;step=colvalues.length;};var clen=colvalues.length;if(matrix!==undefined&&matrix!==null){for(var kk=index;kk<Math.min(clen,index+step);kk++){var colval=colvalues[kk];var rowvalues=[irowval];if(irowval===undefined){var mm=matrix[colval];if(mm!==undefined){rowvalues=Object.keys(mm);}}//console.log(\"Checking:\",kk,clen,colval,JSON.stringify(rowvalues),\n//\t    JSON.stringify(icolvalues),JSON.stringify(colvalues),irowval,index,step);\nvar rlen=rowvalues.length;for(var ll=0;ll<rlen;ll++){var rowval=rowvalues[ll];var element=this.getMatrixElement(colvalues[kk],rowval,matrix);if(element===undefined){}else{//console.log(\"getMatrixElements Found:\",kk,colval,rowval);\nif(elements===undefined){elements=[];};elements.push(element);//console.log(\"Added element:\",JSON.stringify(element),element.docs.length);\n}}};}else{//console.log(\"No matrix available.\");\n}return elements;};this.getMatrixRowElements=function(colval,rowvalues,matrix,index,step){var rlen=rowvalues.length;var elements=undefined;if(matrix!==undefined){for(var kk=index;kk<Math.min(rlen,index+step);kk++){var element=this.getMatrixElement(colval,rowvalues[kk],matrix);if(element===undefined){}else{//console.log(\"getMatrixElements Found:\",kk,rowvalues[kk],colval);\nif(elements===undefined){elements=[];};elements.push(element);}};}else{console.log(\"No matrix available.\");}return elements;};this.getDocVal=function(state,doc,key){var val=doc[key];if(val===undefined){val=\"\";};return val;};this.updateMatrixElement=function(state,arr,dlev,doc){// called once for every hit\nif(arr===undefined){console.log(\"Undefined matrix element.\");return;};var nn=arr.cnt||0;var dd=arr.def||0;if(arr.maxlev===undefined||arr.maxlev===-1||dlev!==-1&&arr.maxlev<dlev){arr.maxlev=dlev;};if(arr.minlev===undefined||arr.minlev>dlev){arr.minlev=dlev;};if(arr.docs===undefined){arr.docs=[];};arr.cnt=nn+1;//console.log(\"Matrix doc:\",JSON.stringify(doc),dlev);\nif(doc._thr!==undefined&&doc._thr.val!==undefined){arr.def=dd+1;if(arr.def<=this.limit){arr.docs.push(doc);};}else if(nn===dd){// make sure at least 1 undef is added...\narr.docs.push(doc);}//if (state.Layout.state.tooltip === 0) {\nvar rank=state.Threshold.getRank(state,doc);if(arr.tooltip===undefined){arr.tooltip={};};var el=this.getTooltipElement(state,arr.tooltip,doc);if(dlev!==-1&&(el.maxrank===undefined&&el.maxlev===undefined||el.maxlev<dlev||el.maxlev===dlev&&el.maxrank<rank)){el.maxlev=dlev;el.maxrank=rank;el.docs=[];el.docs.push(doc);}else if(el.maxlev===dlev&&el.maxrank===rank){if(dlev>0&&dlev<state.Threshold.getMaxLevel(doc)&&el.docs.length<3||el.docs.length<1){el.docs.push(doc);};};//}\n//console.log (\"Updating:\",JSON.stringify(arr),dlev,rank,JSON.stringify(doc));\n};this.getTooltipElement=function(state,tooltip,doc){var ret=tooltip;var keys=state.Path.tooltip.select;var lenk=keys.length;//console.log(\"Select-keys: \",lenk,JSON.stringify(keys));\nfor(var ii=0;ii<lenk;ii++){var key=keys[ii];var val=doc[key];if(ret[val]===undefined){ret[val]={};};ret=ret[val];//console.log(\"Selecting: \",ii,key,val,JSON.stringify(ret));\n};return ret;};this.getRange=function(state,matrix,colvalues,rowvalues){var range;//console.log(\"Thresholds:\",JSON.stringify(state.Threshold.thrs));\n//console.log(\"getRange Cols:\"+JSON.stringify(colvalues)+\" Rows:\"+JSON.stringify(rowvalues));\nrange=undefined;var slenx=colvalues.length;for(var ii=0;ii<slenx;ii++){var sleny=rowvalues.length;for(var jj=0;jj<sleny;jj++){var element=this.getMatrixElement(colvalues[ii],rowvalues[jj],matrix);if(element!==undefined){//console.log(\"Looking for range:\",ii,\"='\",colvalues[ii],\"' \",\n//                                jj,\"='\",rowvalues[jj],\"'\",\n//\t    JSON.stringify(element));\nvar docs=element.docs;if(docs!==undefined){var dlen=docs.length;for(var dd=0;dd<dlen;dd++){var doc=docs[dd];if(doc._thr!==undefined&&doc._thr.val!==undefined){var val=doc._thr.val;range=this.setRange(range,val);var ts,dr;if(doc._thr.max!==undefined){//console.log(\"GetRange:\",JSON.stringify(doc._thr));\nts=doc._thr.max;dr=ts[0]-ts[ts.length-1];if(ts[ts.length-1]>0&&ts[ts.length-1]-dr<0){// include zero\nrange=this.setRange(range,0);}//console.log(\"Found max:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n}else if(doc._thr.min!==undefined){ts=doc._thr.min;if(ts[ts.length-1]<0&&ts[ts.length-1]+dr>0){// include zero\nrange=this.setRange(range,0);}//console.log(\"Found min:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n}range=this.setRange(range,ts[0]);// include lowest level\nrange=this.setRange(range,ts[ts.length-1]);// include highest level\n//console.log(\"After adjustment:\",tlev,ts.length,JSON.stringify(ts[tlev]),\"range=\",JSON.stringify(range));\n};}}else{//console.log(\"No matrix-element found:\",\n//\t    JSON.stringify(colvalues[ii]),\n//\t    JSON.stringify(rowvalues[jj]),\n//\t    matrix.length,JSON.stringify(Object.keys(matrix))\n//\t   );\n}}}}//console.log(\"Initial range:\",JSON.stringify(range));\nrange=this.adjustRange(range);//console.log(\"Final range:\",JSON.stringify(range));\nreturn range;};this.setRange=function(range,val){//console.log(\"SetRange Start:\",JSON.stringify(range),val);\nif(range===undefined){range=[val,val];}else{range=[Math.min(val,range[0]),Math.max(val,range[1])];};//console.log(\"SetRange Final:\",JSON.stringify(range),val);\nreturn range;};this.adjustRange=function(range){if(range!==undefined){//console.log(\"Adjusting:\",JSON.stringify(range));\nvar dx=range[1]-range[0];range=[range[0]-dx*0.01,range[1]+dx*0.01];if(range[0]>0&&range[0]-dx<0){range[0]=0;}if(range[1]<0&&range[1]+dx>0){range[1]=0;}//console.log(\"Result:\",JSON.stringify(range));\nreturn range;}};this.sortTooltipDocs=function(state,docs){var sort=state.Path.tooltip.sort||[];var lens=sort.length;var order=state.Path.order;var funk=function funk(a,b){for(var ss=0;ss<lens;ss++){var key=sort[ss];var va=a[key];var vb=b[key];if(order[key]!==undefined){// we have a predefined order\nvar ia=order[key].indexOf(va);var ib=order[key].indexOf(vb);if(ia!==-1&&ib!==-1){return ia-ib;}else if(ia!==-1){return 1;}else if(ia!==-1){return-1;}else if(va!==vb){return(va>vb)-(va<vb);}}else{if(va!==vb){return(va>vb)-(va<vb);}}}return 0;};var ret=docs.sort(funk);return ret;};this.sortMatrixValues=function(state){var tlen=state.Path.other.table.length;//console.log(\"this.sortMatrixValues row/column:\",JSON.stringify(state.Path.other.table),tlen);\n// sort values\nfor(var jj=0;jj<tlen;jj++){var key=state.Path.other.table[jj];if(this.values[key]!==undefined){//console.log(\"Key:\",key,\"Values:\",JSON.stringify(this.values[key]),jj,\n//\t    \" sort:\",JSON.stringify(state.Database.keyCnt));\nif(state.Database.keyCnt[key].order===state.Database.casc){this.values[key]=this.values[key].sort(state.Utils.ascending);}else if(state.Database.keyCnt[key].order===state.Database.nasc){this.values[key]=this.values[key].sort(state.Utils.descendingN);}else if(state.Database.keyCnt[key].order===state.Database.cdes){this.values[key]=this.values[key].sort(state.Utils.descending);}else if(state.Database.keyCnt[key].order===state.Database.ndes){this.values[key]=this.values[key].sort(state.Utils.descendingN);};//console.log(\"Sorted keys:\",key,JSON.stringify(this.values[key]),state.Database.keyCnt[key].order);\n// override sort\nif(state.Path.order!==undefined&&state.Path.order[key]!==undefined){// we have a predefined order\nvar buff=[];var olen=state.Path.order[key].length;var kk,val;//console.log(\"Order length:\",olen,jj);\n// add ordered values (not in trash)\nfor(kk=0;kk<olen;kk++){val=state.Path.order[key][kk];if(this.values[key].indexOf(val)!==-1){//console.log(\"Adding:\",kk,val);\nbuff.push(val);}}// add remaining this.values values (not in trash)\nvar rlen=this.values[key].length;for(kk=0;kk<rlen;kk++){val=this.values[key][kk];if(buff.indexOf(val)===-1){// not in sub\nbuff.push(val);state.Path.order[key].push(val);}};this.values[key]=buff;// use requested order\n//console.log(\"Using requested order:\",key);\n};};//console.log(\"Found values:\",key,JSON.stringify(this.values[key]));\n};};this.sortedKeys=function(state,obj){var key;var skeys=[];for(key in obj){if(obj.hasOwnProperty(key)&&key.substring(0,1)!==\"_\"){skeys.push(key);}};skeys=skeys.sort(state.Utils.ascending);var ks=[];var slen=skeys.length;for(var jj=0;jj<slen;jj++){key=skeys[jj];if(key.substr(state,0,1)!==\"_\"&&ks.indexOf(key)===-1){ks.push(key);}}//console.log(\"state.Utils.sortedKeys...\",JSON.stringify(skeys),JSON.stringify(ks));\nreturn ks;};this.getInfo=function(state,elements){var tooltip={};// list of maxrank-docs\nvar cnt=0;var maxlev=-1;var minlev=0;var docs=[];if(elements===undefined){console.log(\"No elements found.\");}else{var elen=elements.length;for(var ee=0;ee<elen;ee++){cnt=cnt+elements[ee].cnt;if(elements[ee].maxlev===undefined||elements[ee].minlev===undefined){minlev=Math.min(minlev,-2);}else{maxlev=Math.max(maxlev,elements[ee].maxlev);minlev=Math.min(minlev,elements[ee].minlev);}// loop over tooltips and put maxrank-docs into tooltip array\nthis.mergeTooltipElement(state,elements[ee].tooltip,tooltip,state.Path.tooltip.select.length);}docs=this.getTooltipDocs(state,tooltip);//console.log(\"Tooltip docs:\",JSON.stringify(docs));\n}return{cnt:cnt,minlev:minlev,maxlev:maxlev,tooltip:this.sortTooltipDocs(state,docs)};};this.mergeTooltipElement=function(state,nel,mel,pos){if(nel===undefined){return;}// nothing to merge\nvar ipos=pos;if(ipos===undefined){ipos=state.Path.tooltip.select.length;}//console.log(\"Merging tooltip:\",ipos,JSON.stringify(nel));\nif(ipos>0){var vals=Object.keys(nel);var lenv=vals.length;for(var ii=0;ii<lenv;ii++){var val=vals[ii];if(mel[val]===undefined){mel[val]={};};this.mergeTooltipElement(state,nel[val],mel[val],ipos-1);}}else{if(mel.maxrank===undefined||mel.maxrank<nel.maxrank){mel.maxrank=nel.maxrank;mel.docs=nel.docs;};}};this.getTooltipDocs=function(state,el,pos){var docs=[];var ipos=pos;if(ipos===undefined){ipos=state.Path.tooltip.select.length;}if(el!==undefined){if(ipos>0){var vals=Object.keys(el);var lenv=vals.length;for(var ii=0;ii<lenv;ii++){var val=vals[ii];var ndocs=this.getTooltipDocs(state,el[val],ipos-1);state.Utils.cpArray(docs,ndocs);}}else if(el.docs!==undefined){state.Utils.cpArray(docs,el.docs);};};return docs;};this.checkTooltip=function(state,data){var rowval=data.rowval;var colvalues=data.colvalues;var step=data.step;var index=data.index;// get elements\nvar elements=this.getMatrixElements(colvalues,rowval,state.React.matrix,index,step)||[];// loop over elements\t\nvar lene=elements.length;var ttset=true;for(var ee=0;ee<lene;ee++){// check if elements have tooltip set\nif(elements[ee].tooltip===undefined){ttset=false;}//console.log(\"Element:\",ee,JSON.stringify(elements[ee]));\n};return ttset;};this.addTooltip=function(state,data){console.log(\"Updated Matrix with tooltip.\",data.rowkey,data.colkey);var rowval=data.rowval;var colvalues=data.colvalues;var step=data.step;var index=data.index;// get elements\nvar elements=this.getMatrixElements(colvalues,rowval,state.React.matrix,index,step)||[];var lene=elements.length;for(var ee=0;ee<lene;ee++){// check if elements have tooltip set\nif(elements[ee].tooltip===undefined){this.addElementTooltip(state,elements[ee]);}};};this.makeCntTooltip=function(state,docs){// called when matrix is made if tooltip mode is toggled\nvar tooltip={};var dlen=docs.length;for(var ii=0;ii<dlen;ii++){var doc=docs[ii];var rank=doc._rank;var el=this.getTooltipElement(state,tooltip,doc);if(el.maxrank===undefined||el.maxrank<rank){el.maxrank=rank;el.docs=[];el.docs.push(doc);}else if(el.maxrank===rank){if(rank!==0||el.docs.length<3){el.docs.push(doc);}}//console.log(\"Rank:\",rank,el.maxrank,JSON.stringify(tooltip));\n}return tooltip;};this.getElementWhere=function(state,el){var where=state.Database.getWhere(state);var colkey=state.Path.getColKey(state);var rowkey=state.Path.getRowKey(state);if(rowkey!==undefined&&rowkey!==\"\"){var rowval=el.rowval;where=state.Database.addWhere(where,rowkey+\"='\"+rowval+\"'\");};if(colkey!==undefined&&colkey!==\"\"){var colval=el.colval;where=state.Database.addWhere(where,colkey+\"='\"+colval+\"'\");};return where;};this.addAllTooltip=function(state,matrix){// loop over all elements and add tooltips\nvar colvalues=Object.keys(matrix);var lenc=colvalues.length;for(var cc=0;cc<lenc;cc++){var col=colvalues[cc];var column=matrix[col];var rowvalues=Object.keys(column);var lenr=rowvalues.length;for(var rr=0;rr<lenr;rr++){var row=rowvalues[rr];var el=column[row];this.addElementTooltip(state,el);}}};this.addElementTooltip=function(state,el){// called when info-button is pressed - to add tooltip to element...\nvar where=this.getElementWhere(state,el);var docs=[];if(el.cnt>0){docs=state.Database.getDocs(state,where);};el.tooltip=this.makeCntTooltip(state,docs);//console.log(\"Added tooltip for element:\",docs.length,where); // JSON.stringify(el);\n};this.getTooltip=function(state,data){var rowval=data.rowval;var colvalues=data.colvalues;var step=data.step;var index=data.index;// // get elements\nvar elements=this.getMatrixElements(colvalues,rowval,state.React.matrix,index,step);//console.log(\"Elements:\",JSON.stringify(elements));\nvar info=this.getInfo(state,elements);return info.tooltip;};};export default Matrix;","map":{"version":3,"sources":["/home/franktt/react/varseltavle/src/lib/MatrixLib.js"],"names":["Matrix","cnt","keyCnt","levCnt","values","limit","resolution","area","popSingle","popSeries","init","state","par","Utils","cntKey","key","nrec","where","val","undefined","Path","ignore","indexOf","tcnt","docs","Database","getKeyCnt","dlen","length","jj","doc","push","console","log","Error","stack","initKeyCnt","makeKeyCnt","keys","plen","ii","updateKeyCnt","updateValues","addUndefinedKeyCnt","addUndefinedKeyCntValues","path","posToVal","pos","min","max","dmin","res","ret","dlon","Math","abs","dbor","Number","floor","toString","valToPos","lonToPos","minlon","maxlon","posToLon","latToPos","minlat","maxlat","posToLat","makeMapRange","lat","lon","getLonWhere","keylon","arr","poslon","lonmin","lonmax","getLatWhere","keylat","poslat","latmin","latmax","xpos","addMapAreaKeys","latpos","ilat","lonpos","ilon","_lat","_lon","makeKeyCntMap","getDocVal","setupMap","makeMapArea","addPathKeyCntValues","makeMatrixCntMap","cntDocs","matrix","found","colkey","getColKey","rowkey","getRowKey","colval","rowval","maxlev","maxrank","minlev","makeMatrixElement","def","Html","setFootnote","Layout","tooltip","addAllTooltip","makeMatrix","dlev","Threshold","getLevel","updateLevCnt","updateMatrixElement","lev","first","m","getMatrixElement","getMatrixElements","icolvalues","irowval","iindex","istep","colvalues","slice","index","step","elements","Object","clen","kk","rowvalues","mm","rlen","ll","element","getMatrixRowElements","nn","dd","_thr","rank","getRank","el","getTooltipElement","getMaxLevel","select","lenk","getRange","range","slenx","sleny","setRange","ts","dr","adjustRange","dx","sortTooltipDocs","sort","lens","order","funk","a","b","ss","va","vb","ia","ib","sortMatrixValues","tlen","other","table","casc","ascending","nasc","descendingN","cdes","descending","ndes","buff","olen","sortedKeys","obj","skeys","hasOwnProperty","substring","ks","slen","substr","getInfo","elen","ee","mergeTooltipElement","getTooltipDocs","nel","mel","ipos","vals","lenv","ndocs","cpArray","checkTooltip","data","React","lene","ttset","addTooltip","addElementTooltip","makeCntTooltip","_rank","getElementWhere","getWhere","addWhere","lenc","cc","col","column","lenr","rr","row","getDocs","getTooltip","info"],"mappings":"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","sourcesContent":["//console.log(\"Loading MatrixLib.js\");\n\nfunction Matrix() {\n    this.cnt=0;\n    this.keyCnt={};\n    this.levCnt={};\n    this.values={};\n    this.limit=100;     // displayed data\n    this.resolution=20; // map resolution\n    this.area={};\n    this.popSingle=1000;//0000;\n    this.popSeries=5000;//0000;\n    this.init=function(state){\n\tvar par=\"Matrix\";\n\tstate.Utils.init(par,this);\n    };\n    this.cntKey=function(state,key,nrec,where) {\n\tvar val;\n\tif (this.values[key]  === undefined) {\n\t    this.keyCnt[key]=0;\n\t    this.values[key]=[];\n\t}\n\tif (state.Path.ignore.indexOf(key)  === -1 && key !== \"\") {//ignore special words... \n\t    var tcnt=0;\n\t    var docs=state.Database.getKeyCnt(state,key,where)\n\t    //console.log(\"Count:\",sql,JSON.stringify(docs));\n\t    var dlen = docs.length;\n\t    for (var jj = 0; jj < dlen; jj++) {\n    \t\tvar doc=docs[jj];\n    \t\tval=doc[key];\n\t\tvar cnt=doc.cnt;\n\t\tif (val !== undefined) {\n\t\t    //console.log(\"Found key:\",key,this.getDocVal(state,doc,key));\n    \t\t    this.keyCnt[key]=this.keyCnt[key]+cnt;\n\t\t    this.values[key].push(val);\n\t\t    tcnt=tcnt+cnt;\n\t\t}\n\t    };\n\t    if (tcnt < nrec) { // insert undefined...\n\t\tval=\"\";\n\t\tthis.values[key].push(val);\n\t    };\n\t} else if (key === \"\") {\n\t    console.log(\"Key error...\",new Error().stack);\n\t}\n    };\n    this.initKeyCnt=function(state) {\n\tthis.values={};\n\tthis.keyCnt={};\n    };\n    this.makeKeyCnt=function(state,where,nrec,keys) {\n\tif (keys !== undefined) {\n\t    var plen = keys.length;\n\t    for (var ii = 0; ii < plen; ii++) {\n\t\tvar key=keys[ii];\n\t\tif (key !== \"\") {\n\t\t    this.cntKey(state,key,nrec,where);\n\t\t}\n\t    }\n\t};\n    };\n    this.updateKeyCnt=function(state,key){\n\tif (this.keyCnt[key]  === undefined) {\n    \t    this.keyCnt[key]=1;\n\t    this.values[key]=[];\n\t} else {\n    \t    this.keyCnt[key]++;\n\t}\n    };\n    this.updateValues=function(state,key,val) {\n\tif ( val !== undefined &&\n\t     this.values[key].indexOf(val)  === -1 ) { // value not in range\n\t\t//console.log(\"Checking val=\",JSON.stringify(val),\" key=\",key,\" doc=\",JSON.stringify(doc));\n\t\t//console.log(\"range=\",state.Utils.toString(state.Path.trash));\n    \t\tthis.values[key].push(val);\n\t};\n    }\n\n    // add \"undefined\" range of keys that are not present in every doc...\n    this.addUndefinedKeyCnt=function(state,docs){\n\tvar dlen = docs.length;\n\tfor (var key in this.keyCnt) {\n\t    if (this.keyCnt[key] < dlen) {\n\t\tvar val=\"\";\n\t\tthis.values[key].push(val);\n\t    }\n\t}\n    };\n    // parent path keys are always present (undefined parents can be used)...\n    this.addUndefinedKeyCntValues=function(state) {\n\tvar plen = state.Path.keys.path.length;\n\tfor (var ii = 0; ii < plen; ii++) {\n\t    var key=state.Path.keys.path[ii];\n\t    if (this.keyCnt[key]  === undefined) {\n    \t\tthis.keyCnt[key]=0;\n\t\tthis.values[key]=[];\n\t    }\n\t}\n    };\n    this.posToVal=function(state,pos,min,max) {\n\tvar dmin=0.01;\n\tvar res=this.resolution-1;\n\tif (pos !== undefined &&\n\t    min !== undefined &&\n\t    max !== undefined ) {\n\t    var ret;\n\t    var dlon=(max-min)/res;\n\t    if (Math.abs(dlon) < dmin) {\n\t\tret=(min+max)/2;\n\t    } else {\n\t\tvar dbor=dlon/2;\n\t\tvar val=( (Number(pos)+0.5) * dlon ) + min - dbor;\n\t\tret=Math.floor(val*1000+0.5)/1000;\n\t    }\n\t    return ret.toString();\n\t}\n    };\n    this.valToPos=function(state,val,min,max) {\n\tvar dmin=0.01;\n\tvar res=this.resolution-1;\n\tif (val !== undefined &&\n\t    min !== undefined &&\n\t    max !== undefined ) {\n\t    var dlon=(max-min)/res;\n\t    if (Math.abs(dlon) < dmin) {\n\t\treturn Math.floor(res/2);\n\t    } else {\n\t\tvar dbor=dlon/2;\n\t\tvar pos=(Number(val) - min + dbor)/dlon;\n\t\t//console.log(\"ValToPos:\",pos,Number(val)-min+dbor,dlon);\n\t\treturn Math.max(0,Math.min(res,Math.floor(pos)))\n\t    }\n\t}\n    };\n    this.lonToPos=function(state,val) {\n\tvar min=this.area.minlon;\n\tvar max=this.area.maxlon;\n\treturn this.valToPos(state,val,min,max)\n    };\n    this.posToLon=function(state,pos) {\n\tvar min=this.area.minlon;\n\tvar max=this.area.maxlon;\n\treturn this.posToVal(state,pos,min,max)\n    };\n    this.latToPos=function(state,val) {\n\tvar min=this.area.minlat;\n\tvar max=this.area.maxlat;\n\treturn this.valToPos(state,val,min,max)\n    };\n    this.posToLat=function(state,pos) {\n\tvar min=this.area.minlat;\n\tvar max=this.area.maxlat;\n\treturn this.posToVal(state,pos,min,max)\n    };\n    this.makeMapRange=function(state){\n\tthis.values[\"_lat\"]=[];\n\tvar ii;\n\tfor (ii=0;ii<this.resolution;ii++) {\n\t    var lat=this.posToLat(state,this.resolution-ii-1);\n\t    //console.log(\"Values _lat:\",ii,lat)\n\t    this.values[\"_lat\"].push(lat);\n\t}\n\tthis.values[\"_lon\"]=[];\n\tfor (ii=0;ii<this.resolution;ii++) {\n\t    var lon=this.posToLon(state,ii);\n\t    //console.log(\"Values _lon:\",ii,lon)\n\t    this.values[\"_lon\"].push(lon);\n\t}\n    };\n    this.getLonWhere=function(state,keylon,arr,poslon) {\n\tvar lon=arr[poslon];\n\tvar min=Number(arr[0]);\n\tvar max=Number(arr[arr.length-1]);\n\tvar pos=this.valToPos(state,lon,min,max);\n\tvar lonmin=this.posToVal(state,pos-0.5,min,max);\n\tvar lonmax=this.posToVal(state,pos+0.5,min,max);\n\tif (lonmin < lonmax) {\n\t    return ''+keylon+' >= '+lonmin+' and '+keylon+ ' < '+lonmax+'';\n\t} else {\n\t    return ''+keylon+' >= '+lonmax+' and '+keylon+ ' < '+lonmin+'';\n\t}\n    };\n    this.getLatWhere=function(state,keylat,arr,poslat) {\n\tvar lat=arr[poslat];\n\tvar min=Number(arr[0]);\n\tvar max=Number(arr[arr.length-1]);\n\tvar pos=this.valToPos(state,lat,min,max);\n\tvar latmin=this.posToVal(state,pos-0.5,min,max);\n\tvar latmax=this.posToVal(state,pos+0.5,min,max);\n\n\tvar res=this.resolution-1;\n\tvar dlon=(max-min)/res;\n\tvar dbor=dlon/2;\n\t//var val=( (Number(pos)+0.5) * dlon ) + min - dbor;\n\t//var ret=Math.floor(state,val*1000+0.5)/1000;\n\tvar xpos=(Number(lat) - min + dbor)/dlon;\n\n\tconsole.log(\"GetLatWhere:\",lat,poslat,pos,xpos,min,max,\" lat=\",lat,latmin,latmax,\" d=\",dbor,dlon);\n\n\tif (latmin < latmax) {\n\t    return ''+keylat+' >= '+latmin+' and '+keylat+ ' < '+latmax+'';\n\t} else {\n\t    return ''+keylat+' >= '+latmax+' and '+keylat+ ' < '+latmin+'';\n\t}\n    };\n    this.addMapAreaKeys=function(state,docs) {\n\t//var maxlat,minlat,maxlon,minlon;\n\tvar dlen = docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n    \t    //var vals=[];\n\t    //var lat=docs[\"lat\"];\n\t    var latpos=this.latToPos(state,doc.lat);\n\t    var ilat=this.posToLat(state,latpos);\n\t    //var lon=docs[\"lon\"];\n\t    var lonpos=this.lonToPos(state,doc.lon);\n\t    var ilon=this.posToLon(state,lonpos);\n\t    doc._lat=ilat\n\t    doc._lon=ilon\n\t    //console.log(\"Trash doc=\",doc.lon,lonpos,ilon,doc._lon,JSON.stringify(this.area));\n\t}\n    };\n    this.makeKeyCntMap=function(state,docs) {\n\tvar key;\n\tvar maxlat,minlat,maxlon,minlon;\n\tvar dlen = docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n\t    //console.log(\"Trash doc=\",ii,JSON.stringify(doc));\n    \t    //var vals=[];\n    \t    for (key in doc) { // loop over keys in each doc\n\t\tthis.updateKeyCnt(state,key);\n\t\tvar val=this.getDocVal(state,doc,key);\n\t\tthis.updateValues(state,key,val)\n\t\tif (key  === \"lat\") {\n\t\t    if (maxlat  === undefined) {\n\t\t\tmaxlat=val\n\t\t    }else {\n\t\t\tmaxlat=Math.max(val,maxlat)\n\t\t    };\n\t\t    if (minlat  === undefined) {\n\t\t\tminlat=val\n\t\t    }else {\n\t\t\tminlat=Math.min(val,minlat)\n\t\t    };\n\t\t    this.updateKeyCnt(state,\"_lat\");\n\t\t} else if (key  === \"lon\") {\n\t\t    if (maxlon  === undefined) {\n\t\t\tmaxlon=val\n\t\t    }else {\n\t\t\tmaxlon=Math.max(val,maxlon)\n\t\t    };\n\t\t    if (minlon  === undefined) {\n\t\t\tminlon=val\n\t\t    }else {\n\t\t\tminlon=Math.min(val,minlon)\n\t\t    };\n\t\t    this.updateKeyCnt(state,\"_lon\");\n\t\t}\n    \t    };\n\t}\n\tthis.area={minlat:minlat,maxlat:maxlat,minlon:minlon,maxlon:maxlon};\n\treturn;\n    };\n    this.setupMap=function(state,docs) {\n\tthis.makeMapArea(state,docs);\n\tthis.makeMapRange(state);\n\tthis.addUndefinedKeyCnt(state,docs); // add \"undefined\"\n\tthis.addPathKeyCntValues(state);\n\tthis.addMapAreaKeys(state,docs);\n    };\n    this.makeMatrixCntMap=function(state,cntDocs,matrix) {\n\t//console.log(\"MatrixCnt:\",JSON.stringify(cntDocs));\n\t//var lonmin,lonmax,latmin,latmax;\n\tvar found=false;\n\tvar colkey=state.Path.getColKey(state);\n\tvar rowkey=state.Path.getRowKey(state);\n\tthis.levCnt={};\n\t//var pos=[];\n\tvar dlen=cntDocs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=cntDocs[ii];\n\t    var colval=this.getDocVal(state,doc,colkey);\n\t    var rowval=this.getDocVal(state,doc,rowkey);\n\t    var cnt=this.getDocVal(state,doc,\"cnt\");\n\t    var maxlev=this.getDocVal(state,doc,\"maxlev\");\n\t    var maxrank=this.getDocVal(state,doc,\"maxrank\");\n\t    var minlev=this.getDocVal(state,doc,\"minlev\");\n\t    var minlon=this.getDocVal(state,doc,\"minlon\");\n\t    var maxlon=this.getDocVal(state,doc,\"maxlon\");\n\t    var minlat=this.getDocVal(state,doc,\"minlat\");\n\t    var maxlat=this.getDocVal(state,doc,\"maxlat\");\n\t    //if (lonmin === undefined || minlon < lonmin) {\n\t//\tlonmin=minlon\n\t    //};\n\t    //if (latmin === undefined || minlat < latmin) {\n\t//\tlatmin=minlat\n\t    //};\n    \t    // find matrix array element\n    \t    //console.log (\"Processing:\",JSON.stringify(doc),maxlev,minlev,cnt);\n    \t    var arr=this.makeMatrixElement(state,colval,rowval,matrix);\n    \t    // update matrix array element\n\t    if (maxlev >= 0) { found=true;}\n\t    if (arr !== undefined) {\n\t\tarr.maxlev=maxlev;\n\t\tarr.minlev=minlev;\n\t\tarr.maxrank=maxrank;\n\t\tarr.cnt=cnt;\n\t\tarr.def=0;\n\t\t//arr.docs=[];\n    \t\t//console.log (\"Array:\",JSON.stringify(arr));\n\t    }\n\t}\n\tif (! found) {\n\t    console.log(\"this.makeMatrix No relevant thresholds found.\");\n\t    state.Html.setFootnote(state,\"No data found.\");\n\t}\n\tif (state.Layout.state.tooltip === 0) { // pre-generate all tooltips\n\t    state.Matrix.addAllTooltip(state,matrix);\n\t};\n    \t//console.log (\"Matrix:\",JSON.stringify(matrix));\n\tthis.area={minlat:minlat,maxlat:maxlat,minlon:minlon,maxlon:maxlon};\n    };\n    this.makeMatrix=function(state,docs,matrix) {\n\tvar found=false;\n\tvar colkey=state.Path.getColKey(state);\n\tvar rowkey=state.Path.getRowKey(state);\n\tthis.levCnt={};\n\t//var pos=[];\n\tvar dlen=docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n\t    var colval=this.getDocVal(state,doc,colkey);\n\t    var rowval=this.getDocVal(state,doc,rowkey);\n\t    //console.log(\"Found doc:\",colval,rowval,doc[\"lon\"],doc[\"lat\"])\n    \t    // find matrix array element\n    \t    var arr=this.makeMatrixElement(state,colval,rowval,matrix);\n    \t    // update matrix array element\n    \t    //console.log (\"Processing:\",JSON.stringify(pos),pos.length,JSON.stringify(doc));\n\t    var dlev=state.Threshold.getLevel(state,doc);\n\t    if (dlev === undefined) {dlev=-2;};\n\t    if (dlev >= 0) { found=true;}\n\t    this.updateLevCnt(state,colval,dlev);\n\t    this.updateLevCnt(state,rowval,dlev);\n    \t    this.updateMatrixElement(state,arr,dlev,doc);\n\t}\n\tif (! found) {\n\t    console.log(\"this.makeMatrix No relevant thresholds found.\");\n\t    state.Html.setFootnote(state,\"No data with valid threshold was found.\");\n\t}\n    };\n    this.updateLevCnt=function(state,val,lev) {\n\tif (this.levCnt[val]  === undefined) { this.levCnt[val]={};};\n\tif (this.levCnt[val][lev]  === undefined) { this.levCnt[val][lev]=0;};\n\tthis.levCnt[val][lev]=this.levCnt[val][lev]+1;\n    };\n    this.makeMatrixElement=function(state,colval,rowval,matrix) {\n\tvar first=false;\n\tif (matrix[colval] === undefined) {first=true;matrix[colval]={};};\n\tif (matrix[colval][rowval] === undefined) {first=true;matrix[colval][rowval]={};};\n\tvar m=matrix[colval][rowval];\n\tif (first) {\n\t    m.colval=colval;\n\t    m.rowval=rowval;\n\t};\n\treturn m\n    };\n    this.getMatrixElement=function(colval,rowval,matrix) {\n\t//console.log(\"getMatrixElement:\",colval,\"|\",rowval,\"|\",JSON.stringify(matrix));\n\tif (matrix[colval] !== undefined && matrix[colval][rowval] !== undefined ) {\n\t    return matrix[colval][rowval];\n\t}\n\treturn;\n    };\n    this.getMatrixElements=function(icolvalues,irowval,matrix,iindex,istep) {\n\tvar colvalues= (icolvalues === undefined ? undefined : icolvalues.slice());\n\tvar index=iindex;\n\tvar step=istep;\n\tvar elements=undefined;\n\tif (colvalues === undefined) { // all colvalues\n\t    colvalues=Object.keys(matrix);\n\t    index=0;\n\t    step=colvalues.length;\n\t};\n\tvar clen=colvalues.length;\n\tif (matrix!==undefined && matrix !== null) {\n\t    for (var kk=index;kk<Math.min(clen,index+step);kk++) {\n\t\tvar colval=colvalues[kk];\n\t\tvar rowvalues=[irowval];\n\t\tif (irowval===undefined) {\n\t\t    var mm=matrix[colval];if (mm !== undefined) {rowvalues=Object.keys(mm);}\n\t\t}\n\t\t//console.log(\"Checking:\",kk,clen,colval,JSON.stringify(rowvalues),\n\t\t//\t    JSON.stringify(icolvalues),JSON.stringify(colvalues),irowval,index,step);\n\t\tvar rlen=rowvalues.length;\n\t\tfor (var ll=0;ll<rlen;ll++) {\n\t\t    var rowval=rowvalues[ll];\n\t\t    var element=this.getMatrixElement(colvalues[kk],rowval,matrix);\n\t\t    if (element === undefined) {\n\t\t    } else {\n\t\t\t//console.log(\"getMatrixElements Found:\",kk,colval,rowval);\n\t\t\tif (elements===undefined) {elements=[];};\n\t\t\telements.push(element);\n\t\t\t//console.log(\"Added element:\",JSON.stringify(element),element.docs.length);\n\t\t    }\n\t\t}\n\t    };               \n\t} else {\n\t    //console.log(\"No matrix available.\");\n\t}\n\treturn elements;\n    };\n    this.getMatrixRowElements=function(colval,rowvalues,matrix,index,step) {\n\tvar rlen=rowvalues.length;\n\tvar elements=undefined;\n\tif (matrix!==undefined) {\n            for (var kk=index;kk<Math.min(rlen,index+step);kk++) {\n\t\tvar element=this.getMatrixElement(colval,rowvalues[kk],matrix);\n\t\tif (element === undefined) {\n\t\t} else {\n                    //console.log(\"getMatrixElements Found:\",kk,rowvalues[kk],colval);\n                    if (elements===undefined) {elements=[];};\n                    elements.push(element);\n\t\t}\n            };               \n\t} else {\n\t    console.log(\"No matrix available.\");\n\t}\n\treturn elements;\n    };\n    this.getDocVal=function(state,doc,key) {\n\tvar val = doc[key];if (val  === undefined) {val=\"\";};return val;\n    };\n    this.updateMatrixElement=function(state,arr,dlev,doc) { // called once for every hit\n\tif (arr  === undefined) {\n\t    console.log(\"Undefined matrix element.\");\n\t    return;\n\t};\n\tvar nn=arr.cnt||0;\n\tvar dd=arr.def||0;\n\tif (arr.maxlev  === undefined || arr.maxlev === -1 ||\n\t    (dlev !== -1 && arr.maxlev < dlev)) {\n\t    arr.maxlev=dlev;\n\t};\n\tif (arr.minlev === undefined || (arr.minlev > dlev)) {\n\t    arr.minlev=dlev;\n\t};\n\tif (arr.docs === undefined) {arr.docs=[];};\n\tarr.cnt=nn+1;\n\t//console.log(\"Matrix doc:\",JSON.stringify(doc),dlev);\n\tif (doc._thr !== undefined && doc._thr.val !== undefined) {\n\t    arr.def=dd+1;\n\t    if (arr.def <= this.limit) {arr.docs.push(doc);};\n\t} else if (nn === dd) { // make sure at least 1 undef is added...\n\t    arr.docs.push(doc);\n\t}\n\t//if (state.Layout.state.tooltip === 0) {\n\t    var rank=state.Threshold.getRank(state,doc);\n\t    if (arr.tooltip === undefined) {arr.tooltip={};};\n\t    var el=this.getTooltipElement(state,arr.tooltip,doc);\n\t    if ( dlev !== -1 &&\n\t\t ((el.maxrank === undefined && el.maxlev === undefined) || \n\t\t  (el.maxlev < dlev || (el.maxlev===dlev && el.maxrank < rank)))\n\t       ) {\n\t\tel.maxlev=dlev;\n\t\tel.maxrank=rank;\n\t\tel.docs=[];\n\t\tel.docs.push(doc);\n\t    } else if (el.maxlev === dlev && el.maxrank === rank) {\n\t\tif ((dlev > 0 && dlev < state.Threshold.getMaxLevel(doc) && \n\t\t     el.docs.length < 3) || el.docs.length < 1) {\n\t\t    el.docs.push(doc);\n\t\t};\n\t    };\n\t//}\n\t//console.log (\"Updating:\",JSON.stringify(arr),dlev,rank,JSON.stringify(doc));\n    };\n    this.getTooltipElement=function(state,tooltip,doc) {\n\tvar ret=tooltip;\n\tvar keys=state.Path.tooltip.select;\n\tvar lenk=keys.length;\n\t//console.log(\"Select-keys: \",lenk,JSON.stringify(keys));\n\tfor (var ii=0;ii < lenk;ii++) {\n\t    var key=keys[ii];\n\t    var val=doc[key];\n\t    if (ret[val]=== undefined) {ret[val]={};};\n\t    ret=ret[val];\n\t    //console.log(\"Selecting: \",ii,key,val,JSON.stringify(ret));\n\t};\n\treturn ret;\n    };\n    this.getRange=function(state,matrix,colvalues,rowvalues) {\n\tvar range;\n\t//console.log(\"Thresholds:\",JSON.stringify(state.Threshold.thrs));\n\t//console.log(\"getRange Cols:\"+JSON.stringify(colvalues)+\" Rows:\"+JSON.stringify(rowvalues));\n\trange=undefined;\n\tvar slenx=colvalues.length;\n\tfor(var ii=0; ii<slenx; ii++) {\n\t    var sleny=rowvalues.length;\n\t    for(var jj=0; jj<sleny; jj++) {\n\t\tvar element=this.getMatrixElement(colvalues[ii],rowvalues[jj],matrix);\n\t\tif (element !== undefined) {\n\t\t    //console.log(\"Looking for range:\",ii,\"='\",colvalues[ii],\"' \",\n\t\t    //                                jj,\"='\",rowvalues[jj],\"'\",\n\t\t    //\t    JSON.stringify(element));\n\t\t    var docs=element.docs;\n\t\t    if (docs !== undefined) {\n\t\t\tvar dlen = docs.length;\n\t\t\tfor (var dd = 0; dd < dlen; dd++) {\n    \t\t\t    var doc = docs[dd];\n\t\t\t    if  (doc._thr !== undefined && doc._thr.val !== undefined) {\n\t\t\t\tvar val = doc._thr.val;\n\t\t\t\trange=this.setRange(range,val);\n\t\t\t\tvar ts,dr;\n\t\t\t\tif (doc._thr.max !== undefined) {\n\t\t\t\t    //console.log(\"GetRange:\",JSON.stringify(doc._thr));\n\t\t\t\t    ts=doc._thr.max;\n\t\t\t\t    dr=ts[0]-ts[ts.length-1];\n\t\t\t\t    if (ts[ts.length-1]>0 && ts[ts.length-1]-dr<0) { // include zero\n\t\t\t\t\trange=this.setRange(range,0);\n\t\t\t\t    }\n\t\t\t\t    //console.log(\"Found max:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n\t\t\t\t} else if (doc._thr.min !== undefined) {\n\t\t\t\t    ts=doc._thr.min;\n\t\t\t\t    if (ts[ts.length-1]<0 && ts[ts.length-1]+dr>0) { // include zero\n\t\t\t\t\trange=this.setRange(range,0);\n\t\t\t\t    }\n\t\t\t\t    //console.log(\"Found min:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n\t\t\t\t}\n\t\t\t\trange=this.setRange(range,ts[0]); // include lowest level\n\t\t\t\trange=this.setRange(range,ts[ts.length-1]); // include highest level\n\t\t\t\t//console.log(\"After adjustment:\",tlev,ts.length,JSON.stringify(ts[tlev]),\"range=\",JSON.stringify(range));\n\t\t\t    };\n\t\t\t}\n\t\t    } else {\n\t\t\t//console.log(\"No matrix-element found:\",\n\t\t\t//\t    JSON.stringify(colvalues[ii]),\n\t\t\t//\t    JSON.stringify(rowvalues[jj]),\n\t\t\t//\t    matrix.length,JSON.stringify(Object.keys(matrix))\n\t\t\t//\t   );\n\t\t    }\n\t\t}\n\t    }\n\t}\n\t//console.log(\"Initial range:\",JSON.stringify(range));\n\trange=this.adjustRange(range);\n\t//console.log(\"Final range:\",JSON.stringify(range));\n\treturn range;\n    };\n    this.setRange=function(range,val) {\n\t//console.log(\"SetRange Start:\",JSON.stringify(range),val);\n\tif (range  === undefined) {\n\t    range=[val,val];\n\t} else {\n\t    range=[Math.min(val,range[0]),Math.max(val,range[1])];\n\t};\n\t//console.log(\"SetRange Final:\",JSON.stringify(range),val);\n\treturn range;\n    };\n    this.adjustRange=function(range) {\n\tif (range !== undefined) {\n\t    //console.log(\"Adjusting:\",JSON.stringify(range));\n\t    var dx=(range[1]-range[0]);\n\t    range=[range[0]-dx*0.01,range[1]+dx*0.01];\n\t    if (range[0]>0 && range[0]-dx<0) { range[0]=0;}\n\t    if (range[1]<0 && range[1]+dx>0) { range[1]=0;}\n\t    //console.log(\"Result:\",JSON.stringify(range));\n\t    return range;\n\t}\n    };\n    this.sortTooltipDocs=function(state,docs) {\n\tvar sort=state.Path.tooltip.sort||[];\n\tvar lens=sort.length;\n\tvar order=state.Path.order;\n\tvar funk=function(a,b){\n\t    for (var ss=0;ss<lens;ss++) {\n\t\tvar key=sort[ss];\n\t\tvar va=a[key];\n\t\tvar vb=b[key];\n\t\tif (order[key] !== undefined) { // we have a predefined order\n\t\t    var ia=order[key].indexOf(va);\n\t\t    var ib=order[key].indexOf(vb);\n\t\t    if (ia !==-1 && ib !== -1) {\n\t\t\treturn ia-ib\n\t\t    } else if (ia !== -1) {\n\t\t\treturn 1;\n\t\t    } else if (ia !== -1) {\n\t\t\treturn -1;\n\t\t    } else if (va !== vb) {\n\t\t\treturn (va > vb) - (va < vb);\n\t\t    }\n\t\t} else {\n\t\t    if (va !== vb) {\n\t\t\treturn (va > vb) - (va < vb);\n\t\t    }\n\t\t}\n\t    }\n\t    return 0;\n\t};\n\tvar ret=docs.sort(funk);\n\treturn ret; \n    };\n    this.sortMatrixValues=function(state) {\n\tvar tlen=state.Path.other.table.length;\n\t//console.log(\"this.sortMatrixValues row/column:\",JSON.stringify(state.Path.other.table),tlen);\n\t// sort values\n\tfor (var jj = 0; jj < tlen; jj++) {\n    \t    var key=state.Path.other.table[jj];\n\t    if (this.values[key] !== undefined) {\n\t\t//console.log(\"Key:\",key,\"Values:\",JSON.stringify(this.values[key]),jj,\n\t    \t//\t    \" sort:\",JSON.stringify(state.Database.keyCnt));\n\t\tif (state.Database.keyCnt[key].order  === state.Database.casc) {\n    \t\t    this.values[key]=this.values[key].sort(state.Utils.ascending);\n\t\t} else if (state.Database.keyCnt[key].order  === state.Database.nasc) {\n    \t\t    this.values[key]=this.values[key].sort(state.Utils.descendingN);\n\t\t} else if (state.Database.keyCnt[key].order  === state.Database.cdes) {\n    \t\t    this.values[key]=this.values[key].sort(state.Utils.descending);\n\t\t} else if (state.Database.keyCnt[key].order  === state.Database.ndes) {\n    \t\t    this.values[key]=this.values[key].sort(state.Utils.descendingN);\n\t\t};\n\t\t//console.log(\"Sorted keys:\",key,JSON.stringify(this.values[key]),state.Database.keyCnt[key].order);\n\t\t// override sort\n\t\tif (state.Path.order !== undefined &&\n\t\t    state.Path.order[key] !== undefined) { // we have a predefined order\n\t\t\tvar buff=[];\n\t\t    var olen=state.Path.order[key].length;\n\t\t    var kk,val;\n\t\t    //console.log(\"Order length:\",olen,jj);\n\t\t    // add ordered values (not in trash)\n\t\t    for (kk = 0; kk < olen; kk++) {\n\t\t\tval=state.Path.order[key][kk];\n\t\t\tif (this.values[key].indexOf(val) !== -1) {\n\t\t\t    //console.log(\"Adding:\",kk,val);\n\t\t\t    buff.push(val);\n\t\t\t}\n\t\t    }\n\t\t    // add remaining this.values values (not in trash)\n\t\t    var rlen=this.values[key].length;\n\t\t    for (kk = 0; kk < rlen; kk++) {\n\t\t\tval=this.values[key][kk];\n\t\t\tif (buff.indexOf(val)  === -1) { // not in sub\n\t\t\t    buff.push(val);\n\t\t\t    state.Path.order[key].push(val);\n\t\t\t}\n\t\t    };\n\t\t    this.values[key]=buff; // use requested order\n\t\t    //console.log(\"Using requested order:\",key);\n\t\t};\n\t    };\n    \t    //console.log(\"Found values:\",key,JSON.stringify(this.values[key]));\n\t};\n    };\n    this.sortedKeys=function(state,obj) {\n\tvar key;\n\tvar skeys = [];\n\tfor(key in obj){\n\t    if (obj.hasOwnProperty(key) && key.substring(0,1) !== \"_\") {skeys.push(key);}\n\t};\n\tskeys=skeys.sort(state.Utils.ascending);\n\tvar ks=[];\n\tvar slen=skeys.length;\n\tfor (var jj = 0; jj < slen; jj++) {\n\t    key=skeys[jj];\n\t    if (key.substr(state,0,1) !== \"_\" && ks.indexOf(key) === -1) {\n\t\tks.push(key);\n\t    }\n\t}\n\t//console.log(\"state.Utils.sortedKeys...\",JSON.stringify(skeys),JSON.stringify(ks));\n\treturn ks;\n    }\n    this.getInfo=function(state,elements) {\n\tvar tooltip={}; // list of maxrank-docs\n\tvar cnt=0;\n\tvar maxlev=-1;\n\tvar minlev=0;\n\tvar docs=[];\n\tif (elements === undefined) {\n\t    console.log(\"No elements found.\");\n\t} else {\n\t    var elen=elements.length;\n\t    for (var ee=0;ee<elen;ee++) {\n\t\tcnt=cnt+elements[ee].cnt;\n\t\tif (elements[ee].maxlev === undefined || elements[ee].minlev === undefined) {\n\t\t    minlev=Math.min(minlev,-2);\n\t\t} else {\n\t\t    maxlev=Math.max(maxlev,elements[ee].maxlev);\n\t\t    minlev=Math.min(minlev,elements[ee].minlev);\n\t\t}\n\t\t// loop over tooltips and put maxrank-docs into tooltip array\n\t\tthis.mergeTooltipElement(state,elements[ee].tooltip,tooltip,state.Path.tooltip.select.length);\n\t    }\n\t    docs=this.getTooltipDocs(state,tooltip);\n\t    //console.log(\"Tooltip docs:\",JSON.stringify(docs));\n\t}\n\treturn {cnt:cnt,\n\t\tminlev:minlev,\n\t\tmaxlev:maxlev,\n\t\ttooltip:this.sortTooltipDocs(state,docs)};\n    }\n    this.mergeTooltipElement=function(state,nel,mel,pos) {\n\tif (nel === undefined) {return;} // nothing to merge\n\tvar ipos=pos;\n\tif (ipos === undefined) {ipos=state.Path.tooltip.select.length;}\n\t//console.log(\"Merging tooltip:\",ipos,JSON.stringify(nel));\n\tif (ipos > 0) {\n\t    var vals=Object.keys(nel);\n\t    var lenv=vals.length;\n\t    for (var ii=0;ii<lenv;ii++) {\n\t\tvar val=vals[ii];\n\t\tif (mel[val]===undefined) {mel[val]={}};\n\t\tthis.mergeTooltipElement(state,nel[val],mel[val],ipos-1);\n\t    }\n\t} else {\n\t    if (mel.maxrank === undefined || mel.maxrank < nel.maxrank) {\n\t\tmel.maxrank=nel.maxrank;\n\t\tmel.docs=nel.docs;\n\t    };\n\t}\n    };\n    this.getTooltipDocs=function(state,el,pos) {\n\tvar docs=[];\n\tvar ipos=pos;\n\tif (ipos === undefined) {ipos=state.Path.tooltip.select.length;}\n\tif (el !== undefined) {\n\t    if (ipos > 0) {\n\t\tvar vals=Object.keys(el);\n\t\tvar lenv=vals.length;\n\t\tfor (var ii=0;ii<lenv;ii++) {\n\t\t    var val=vals[ii];\n\t\t    var ndocs=this.getTooltipDocs(state,el[val],ipos-1);\n\t\t    state.Utils.cpArray(docs,ndocs);\n\t\t}\n\t    } else if (el.docs !== undefined) {\n\t\tstate.Utils.cpArray(docs,el.docs);\n\t    };\n\t};\n\treturn docs;\n    };\n    this.checkTooltip=function(state,data) {\n\tvar rowval=data.rowval;\n\tvar colvalues=data.colvalues;\n\tvar step=data.step;\n\tvar index=data.index;\n\t// get elements\n\tvar elements=this.getMatrixElements(colvalues,rowval,state.React.matrix,index,step)||[];\n\t// loop over elements\t\n\tvar lene=elements.length;\n\tvar ttset=true;\n\tfor (var ee=0; ee<lene; ee++) {\n\t    // check if elements have tooltip set\n\t    if (elements[ee].tooltip===undefined) {\n\t\tttset=false;\n\t    }\n\t    //console.log(\"Element:\",ee,JSON.stringify(elements[ee]));\n\n\t};\n\treturn ttset;\n    };\n    this.addTooltip=function(state,data) {\n\tconsole.log(\"Updated Matrix with tooltip.\",data.rowkey,data.colkey);\n\tvar rowval=data.rowval;\n\tvar colvalues=data.colvalues;\n\tvar step=data.step;\n\tvar index=data.index;\n\t// get elements\n\tvar elements=this.getMatrixElements(colvalues,rowval,state.React.matrix,index,step)||[];\n\tvar lene=elements.length;\n\tfor (var ee=0; ee<lene; ee++) {\n\t    // check if elements have tooltip set\n\t    if (elements[ee].tooltip===undefined) {\n\t\tthis.addElementTooltip(state,elements[ee]);\n\t    }\n\t};\n    };\n    this.makeCntTooltip=function(state,docs) {\n\t// called when matrix is made if tooltip mode is toggled\n\tvar tooltip={};\n\tvar dlen=docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n\t    var rank=doc._rank\n\t    var el=this.getTooltipElement(state,tooltip,doc);\n\t    if (el.maxrank === undefined || el.maxrank < rank) {\n\t\tel.maxrank=rank;\n\t\tel.docs=[];\n\t\tel.docs.push(doc);\n\t    } else if (el.maxrank === rank) {\n\t\tif (rank!==0 || el.docs.length < 3) {\n\t\t    el.docs.push(doc);\n\t\t}\n\t    }\n\t    //console.log(\"Rank:\",rank,el.maxrank,JSON.stringify(tooltip));\n\t}\n\treturn tooltip;\n    };\n    this.getElementWhere=function(state,el) {\n\tvar where = state.Database.getWhere(state);\n\tvar colkey= state.Path.getColKey(state);\n\tvar rowkey= state.Path.getRowKey(state);\n\tif (rowkey !== undefined && rowkey !== \"\") {\n\t    var rowval=el.rowval;\n\t    where=state.Database.addWhere(where,rowkey+\"='\" + rowval+\"'\");\n\t};\n\tif (colkey !== undefined && colkey !== \"\") {\n\t    var colval=el.colval;\n\t    where=state.Database.addWhere(where,colkey+\"='\" + colval+\"'\");\n\t};\n\treturn where;\n    };\n    this.addAllTooltip=function(state,matrix) {\n\t// loop over all elements and add tooltips\n\tvar colvalues=Object.keys(matrix);\n\tvar lenc=colvalues.length;\n\tfor (var cc=0;cc<lenc;cc++) {\n\t    var col=colvalues[cc];\n\t    var column=matrix[col];\n\t    var rowvalues=Object.keys(column);\n\t    var lenr=rowvalues.length;\n\t    for (var rr=0;rr<lenr;rr++) {\n\t\tvar row=rowvalues[rr];\n\t\tvar el=column[row];\n\t\tthis.addElementTooltip(state,el);\n\t    }\n\t}\n    };\n    this.addElementTooltip=function(state,el) {\n\t// called when info-button is pressed - to add tooltip to element...\n\tvar where = this.getElementWhere(state,el);\n\tvar docs=[];\n\tif (el.cnt>0) {docs=state.Database.getDocs(state,where);};\n\tel.tooltip=this.makeCntTooltip(state,docs);\n\t//console.log(\"Added tooltip for element:\",docs.length,where); // JSON.stringify(el);\n    };\n    this.getTooltip=function(state,data) {\n\tvar rowval=data.rowval;\n\tvar colvalues=data.colvalues;\n\tvar step=data.step;\n\tvar index=data.index;\n\t// // get elements\n\tvar elements=this.getMatrixElements(colvalues,rowval,state.React.matrix,index,step);\n\n\t//console.log(\"Elements:\",JSON.stringify(elements));\n\n\tvar info=this.getInfo(state,elements);\n\treturn info.tooltip;\n    };\n};\nexport default Matrix;\n"]},"metadata":{},"sourceType":"module"}