{"ast":null,"code":"//console.log(\"Loading MatrixLib.js\");\nfunction Matrix() {\n  this.bdeb = false;\n  this.cnt = 0;\n  this.keyCnt = {};\n  this.levCnt = {};\n  this.values = {};\n  this.limit = 100; // displayed data\n\n  this.resolution = 20; // map resolution\n\n  this.area = {};\n  this.popSingle = 1000; //0000;\n\n  this.popSeries = 5000; //0000;\n\n  this.init = function (state) {\n    var par = \"Matrix\";\n    state.Utils.init(par, this);\n  };\n\n  this.cntKey = function (state, key, nrec, where) {\n    var val;\n\n    if (this.values[key] === undefined) {\n      this.keyCnt[key] = 0;\n      this.values[key] = [];\n    }\n\n    if (state.Path.ignore.indexOf(key) === -1 && key !== \"\") {\n      //ignore special words... \n      var tcnt = 0;\n      var docs = state.Database.getKeyCnt(state, key, where); //console.log(\"Count:\",sql,JSON.stringify(docs));\n\n      var dlen = docs.length;\n\n      for (var jj = 0; jj < dlen; jj++) {\n        var doc = docs[jj];\n        val = doc[key];\n        var cnt = doc.cnt;\n\n        if (val !== undefined) {\n          //console.log(\"Found key:\",key,this.getDocVal(state,doc,key));\n          this.keyCnt[key] = this.keyCnt[key] + cnt;\n          this.values[key].push(val);\n          tcnt = tcnt + cnt;\n        }\n      }\n\n      ;\n\n      if (tcnt < nrec) {\n        // insert undefined...\n        val = \"\";\n        this.values[key].push(val);\n      }\n\n      ;\n    } else if (key === \"\") {\n      console.log(\"Key error...\", new Error().stack);\n    }\n  };\n\n  this.initKeyCnt = function (state) {\n    this.values = {};\n    this.keyCnt = {};\n  };\n\n  this.makeKeyCnt = function (state, where, nrec, keys) {\n    if (keys !== undefined) {\n      var plen = keys.length;\n\n      for (var ii = 0; ii < plen; ii++) {\n        var key = keys[ii];\n\n        if (key !== \"\") {\n          this.cntKey(state, key, nrec, where);\n        }\n      }\n    }\n\n    ;\n  };\n\n  this.updateKeyCnt = function (state, key) {\n    if (this.keyCnt[key] === undefined) {\n      this.keyCnt[key] = 1;\n      this.values[key] = [];\n    } else {\n      this.keyCnt[key]++;\n    }\n  };\n\n  this.updateValues = function (state, key, val) {\n    if (val !== undefined && this.values[key].indexOf(val) === -1) {\n      // value not in range\n      //console.log(\"Checking val=\",JSON.stringify(val),\" key=\",key,\" doc=\",JSON.stringify(doc));\n      //console.log(\"range=\",state.Utils.toString(state.Path.trash));\n      this.values[key].push(val);\n    }\n\n    ;\n  }; // add \"undefined\" range of keys that are not present in every doc...\n\n\n  this.addUndefinedKeyCnt = function (state, docs) {\n    var dlen = docs.length;\n\n    for (var key in this.keyCnt) {\n      if (this.keyCnt[key] < dlen) {\n        var val = \"\";\n        this.values[key].push(val);\n      }\n    }\n  }; // parent path keys are always present (undefined parents can be used)...\n\n\n  this.addUndefinedKeyCntValues = function (state) {\n    var plen = state.Path.keys.path.length;\n\n    for (var ii = 0; ii < plen; ii++) {\n      var key = state.Path.keys.path[ii];\n\n      if (this.keyCnt[key] === undefined) {\n        this.keyCnt[key] = 0;\n        this.values[key] = [];\n      }\n    }\n  };\n\n  this.roundup = function (val) {\n    return Math.ceil(val * 1000) / 1000;\n  };\n\n  this.rounddown = function (val) {\n    return Math.floor(val * 1000) / 1000;\n  };\n\n  this.posToVal = function (state, pos, min, max) {\n    var res = this.resolution - 1;\n\n    if (pos !== undefined && min !== undefined && max !== undefined) {\n      var ret;\n      var dlon = (max - min) / res;\n      var dbor = dlon / 2;\n      var val = Number(pos) * dlon + min;\n\n      if (this.bdeb) {\n        console.log(\"PosToVal \", pos, min, max, val);\n      }\n\n      ;\n      return val.toString();\n    }\n  };\n\n  this.valToPos = function (state, val, min, max) {\n    var res = this.resolution - 1;\n\n    if (val !== undefined && min !== undefined && max !== undefined) {\n      var dlon = (max - min) / res;\n\n      if (max == min) {\n        console.log(\"ValToPos#\", Number(val) - min, dlon, res / 2);\n        return Math.floor(res / 2);\n      } else {\n        var dbor = dlon / 2;\n        var pos = (Number(val) - min + dbor) / dlon;\n\n        if (this.bdeb) {\n          console.log(\"ValToPos:\", pos, Number(val) - min + dbor, dlon);\n        }\n\n        ;\n        return Math.max(0, Math.min(res, Math.floor(pos)));\n      }\n    }\n  };\n\n  this.lonToPos = function (state, val) {\n    var min = this.area.minlon;\n    var max = this.area.maxlon;\n    return this.valToPos(state, val, min, max);\n  };\n\n  this.posToLon = function (state, pos) {\n    var min = this.area.minlon;\n    var max = this.area.maxlon;\n    return this.posToVal(state, pos, min, max);\n  };\n\n  this.latToPos = function (state, val) {\n    var min = this.area.minlat;\n    var max = this.area.maxlat;\n    return this.valToPos(state, val, min, max);\n  };\n\n  this.posToLat = function (state, pos) {\n    var min = this.area.minlat;\n    var max = this.area.maxlat;\n    return this.posToVal(state, pos, min, max);\n  };\n\n  this.makeMapRange = function (state) {\n    var distinct = function distinct(value, index, self) {\n      return self.indexOf(value) === index;\n    };\n\n    var vals = [];\n    var ii;\n\n    if (this.bdeb) {\n      console.log(\"makeMapRange:\", JSON.stringify(this.area));\n    }\n\n    ;\n\n    for (ii = 0; ii < this.resolution; ii++) {\n      var lat = this.posToLat(state, this.resolution - ii - 1);\n\n      if (this.bdeb) {\n        console.log(\"Values _lat:\", this.resolution, ii, lat);\n      }\n\n      ;\n      vals.push(lat);\n    }\n\n    this.values[\"_lat\"] = vals.filter(distinct);\n    vals = [];\n\n    for (ii = 0; ii < this.resolution; ii++) {\n      var lon = this.posToLon(state, ii);\n\n      if (this.bdeb) {\n        console.log(\"Values _lon:\", this.resolution, ii, lon);\n      }\n\n      ;\n      vals.push(lon);\n    }\n\n    this.values[\"_lon\"] = vals.filter(distinct);\n  };\n\n  this.getLonRange = function (state, lon) {\n    var min = parseFloat(this.area.minlon); //Number(arr[0]);\n\n    var max = parseFloat(this.area.maxlon); //Number(arr[arr.length-1]);\n\n    var pos = this.valToPos(state, lon, min, max);\n    var lonmin = parseFloat(this.posToVal(state, pos - 0.506, min, max));\n    var lonmax = parseFloat(this.posToVal(state, pos + 0.494, min, max));\n    return {\n      min: lonmin,\n      max: lonmax\n    };\n  };\n\n  this.getLonWhere = function (state, keylon, lon) {\n    var range = this.getLonRange(state, lon);\n    var lonmin = range.min;\n    var lonmax = range.max;\n\n    if (parseFloat(lonmin) < parseFloat(lonmax)) {\n      return '' + keylon + ' >= ' + lonmin + ' and ' + keylon + ' < ' + lonmax + '';\n    } else {\n      return '' + keylon + ' >= ' + lonmax + ' and ' + keylon + ' < ' + lonmin + '';\n    }\n  };\n\n  this.getLatRange = function (state, lat) {\n    var min = parseFloat(this.area.minlat); //Number(arr[0]);\n\n    var max = parseFloat(this.area.maxlat); //Number(arr[arr.length-1]);\n\n    var pos = this.valToPos(state, lat, min, max);\n    var latmin = parseFloat(this.posToVal(state, pos - 0.506, min, max));\n    var latmax = parseFloat(this.posToVal(state, pos + 0.494, min, max));\n    return {\n      min: latmin,\n      max: latmax\n    };\n  };\n\n  this.getLatWhere = function (state, keylat, lat) {\n    var range = this.getLatRange(state, lat);\n    var latmin = range.min;\n    var latmax = range.max;\n\n    if (parseFloat(latmin) < parseFloat(latmax)) {\n      return '' + keylat + ' >= ' + latmin + ' and ' + keylat + ' < ' + latmax + '';\n    } else {\n      return '' + keylat + ' >= ' + latmax + ' and ' + keylat + ' < ' + latmin + '';\n    }\n  };\n\n  this.addMapAreaKeys = function (state, docs) {\n    //var maxlat,minlat,maxlon,minlon;\n    var dlen = docs.length;\n\n    for (var ii = 0; ii < dlen; ii++) {\n      var doc = docs[ii]; //var vals=[];\n      //var lat=docs[\"lat\"];\n\n      var latpos = this.latToPos(state, doc.lat);\n      var ilat = this.posToLat(state, latpos); //var lon=docs[\"lon\"];\n\n      var lonpos = this.lonToPos(state, doc.lon);\n      var ilon = this.posToLon(state, lonpos);\n      doc._lat = ilat;\n      doc._lon = ilon;\n      this.updateKeyCnt(state, \"_lat\");\n      this.updateKeyCnt(state, \"_lon\"); //console.log(\"AddMapAreaKeys=\",doc.lon,lonpos,ilon,doc._lon,JSON.stringify(this.area));\n    }\n  };\n\n  this.setArea = function (iminlat, imaxlat, iminlon, imaxlon) {\n    var eps = 0.1;\n    var minlat = parseFloat(iminlat);\n    var maxlat = parseFloat(imaxlat);\n    var minlon = parseFloat(iminlon);\n    var maxlon = parseFloat(imaxlon);\n    var epslon = maxlon - minlon;\n    var epslat = maxlat - minlat;\n\n    if (epslon < eps) {\n      maxlon = maxlon + eps / 2;\n      minlon = minlon - eps / 2;\n    }\n\n    ;\n\n    if (epslat < eps) {\n      maxlat = maxlat + eps / 2;\n      minlat = minlat - eps / 2;\n    }\n\n    ;\n    this.area = {\n      minlat: minlat,\n      maxlat: maxlat,\n      minlon: minlon,\n      maxlon: maxlon\n    };\n    console.log(\"setArea:\", JSON.stringify(this.area));\n  };\n\n  this.makeKeyCntMap = function (state, docs) {\n    var key;\n    var maxlat, minlat, maxlon, minlon;\n    var dlen = docs.length;\n\n    for (var ii = 0; ii < dlen; ii++) {\n      var doc = docs[ii]; //console.log(\"Trash doc=\",ii,JSON.stringify(doc));\n      //var vals=[];\n\n      for (key in doc) {\n        // loop over keys in each doc\n        this.updateKeyCnt(state, key);\n        var val = this.getDocVal(state, doc, key);\n        this.updateValues(state, key, val);\n\n        if (key === \"lat\") {\n          if (maxlat === undefined) {\n            maxlat = val;\n          } else {\n            maxlat = Math.max(val, maxlat);\n          }\n\n          ;\n\n          if (minlat === undefined) {\n            minlat = val;\n          } else {\n            minlat = Math.min(val, minlat);\n          }\n\n          ;\n          this.updateKeyCnt(state, \"_lat\");\n        } else if (key === \"lon\") {\n          if (maxlon === undefined) {\n            maxlon = val;\n          } else {\n            maxlon = Math.max(val, maxlon);\n          }\n\n          ;\n\n          if (minlon === undefined) {\n            minlon = val;\n          } else {\n            minlon = Math.min(val, minlon);\n          }\n\n          ;\n          this.updateKeyCnt(state, \"_lon\");\n        }\n      }\n\n      ;\n    }\n\n    this.setArea(minlat, maxlat, minlon, maxlon);\n    return;\n  };\n\n  this.setupMap = function (state, docs) {\n    this.makeMapArea(state, docs);\n    this.makeMapRange(state);\n    this.addUndefinedKeyCnt(state, docs); // add \"undefined\"\n\n    this.addPathKeyCntValues(state);\n    this.addMapAreaKeys(state, docs);\n  };\n\n  this.makeMatrixCntMap = function (state, cntDocs, matrix) {\n    //console.log(\"MatrixCnt:\",JSON.stringify(cntDocs));\n    //var lonmin,lonmax,latmin,latmax;\n    var found = false;\n    var colkey = state.Path.getColKey(state);\n    var rowkey = state.Path.getRowKey(state);\n    this.levCnt = {};\n\n    if (this.bdeb) {\n      console.log(\"Keys:\", JSON.stringify(colkey), JSON.stringify(rowkey));\n    }\n\n    ; //var pos=[];\n\n    var dlen = cntDocs.length;\n\n    for (var ii = 0; ii < dlen; ii++) {\n      var doc = cntDocs[ii];\n      var colval = this.getDocVal(state, doc, colkey);\n      var rowval = this.getDocVal(state, doc, rowkey);\n      var cnt = this.getDocVal(state, doc, \"cnt\");\n      var maxlev = this.getDocVal(state, doc, \"maxlev\");\n      var maxrank = this.getDocVal(state, doc, \"maxrank\");\n      var minlev = this.getDocVal(state, doc, \"minlev\");\n      var minlon = this.getDocVal(state, doc, \"minlon\");\n      var maxlon = this.getDocVal(state, doc, \"maxlon\");\n      var minlat = this.getDocVal(state, doc, \"minlat\");\n      var maxlat = this.getDocVal(state, doc, \"maxlat\"); //if (lonmin === undefined || minlon < lonmin) {\n      //\tlonmin=minlon\n      //};\n      //if (latmin === undefined || minlat < latmin) {\n      //\tlatmin=minlat\n      //};\n      // find matrix array element\n      //console.log (\"Processing:\",JSON.stringify(doc),maxlev,minlev,cnt);\n\n      var arr = this.makeMatrixElement(state, colval, rowval, matrix); // update matrix array element\n\n      if (maxlev >= 0) {\n        found = true;\n      }\n\n      if (arr !== undefined) {\n        arr.maxlev = maxlev;\n        arr.minlev = minlev;\n        arr.maxrank = maxrank;\n        arr.cnt = cnt;\n        arr.def = 0; //arr.docs=[];\n        //console.log (\"Array:\",JSON.stringify(arr));\n      } // \tthis.setArea(minlat,maxlat,minlon,maxlon);\n\n    }\n\n    if (!found) {\n      console.log(\"this.makeMatrix No relevant thresholds found.\");\n      state.Html.setFootnote(state, \"No data found.\");\n    }\n\n    if (state.Layout.state.tooltip === 0) {\n      // pre-generate all tooltips\n      state.Matrix.addAllTooltip(state, matrix);\n    }\n\n    ; //console.log (\"Matrix:\",JSON.stringify(matrix));\n  };\n\n  this.setMapArea = function (state, docs) {\n    var dlen = docs.length;\n\n    for (var ii = 0; ii < dlen; ii++) {\n      var doc = docs[ii];\n      var minlon = this.getDocVal(state, doc, \"minlon\");\n      var maxlon = this.getDocVal(state, doc, \"maxlon\");\n      var minlat = this.getDocVal(state, doc, \"minlat\");\n      var maxlat = this.getDocVal(state, doc, \"maxlat\");\n      this.setArea(minlat, maxlat, minlon, maxlon);\n\n      if (this.bdeb) {\n        console.log(\"setMapArea:\", JSON.stringify(this.area), JSON.stringify(this.doc));\n      }\n\n      ;\n    }\n  };\n\n  this.makeMatrix = function (state, docs, matrix) {\n    var found = false;\n    var colkey = state.Path.getColKey(state);\n    var rowkey = state.Path.getRowKey(state);\n    this.levCnt = {}; //var pos=[];\n\n    var dlen = docs.length;\n\n    for (var ii = 0; ii < dlen; ii++) {\n      var doc = docs[ii];\n      var colval = this.getDocVal(state, doc, colkey);\n      var rowval = this.getDocVal(state, doc, rowkey); //console.log(\"Found doc:\",colval,rowval,doc[\"lon\"],doc[\"lat\"])\n      // find matrix array element\n\n      var arr = this.makeMatrixElement(state, colval, rowval, matrix); // update matrix array element\n      //console.log (\"Processing:\",JSON.stringify(pos),pos.length,JSON.stringify(doc));\n\n      var dlev = state.Threshold.getLevel(state, doc);\n\n      if (dlev === undefined) {\n        dlev = -2;\n      }\n\n      ;\n\n      if (dlev >= 0) {\n        found = true;\n      }\n\n      this.updateLevCnt(state, colval, dlev);\n      this.updateLevCnt(state, rowval, dlev);\n      this.updateMatrixElement(state, arr, dlev, doc);\n    }\n\n    if (!found) {\n      console.log(\"this.makeMatrix No relevant thresholds found.\");\n      state.Html.setFootnote(state, \"No data with valid threshold was found.\");\n    }\n  };\n\n  this.updateLevCnt = function (state, val, lev) {\n    if (this.levCnt[val] === undefined) {\n      this.levCnt[val] = {};\n    }\n\n    ;\n\n    if (this.levCnt[val][lev] === undefined) {\n      this.levCnt[val][lev] = 0;\n    }\n\n    ;\n    this.levCnt[val][lev] = this.levCnt[val][lev] + 1;\n  };\n\n  this.makeMatrixElement = function (state, colval, rowval, matrix) {\n    var first = false;\n\n    if (matrix[colval] === undefined) {\n      first = true;\n      matrix[colval] = {};\n    }\n\n    ;\n\n    if (matrix[colval][rowval] === undefined) {\n      first = true;\n      matrix[colval][rowval] = {};\n    }\n\n    ;\n    var m = matrix[colval][rowval];\n\n    if (first) {\n      m.colval = colval;\n      m.rowval = rowval;\n    }\n\n    ;\n    return m;\n  };\n\n  this.getMatrixElement = function (colval, rowval, matrix) {\n    //console.log(\"getMatrixElement:\",colval,\"|\",rowval,\"|\",JSON.stringify(matrix));\n    if (matrix[colval] !== undefined && matrix[colval][rowval] !== undefined) {\n      return matrix[colval][rowval];\n    }\n\n    return;\n  };\n\n  this.printElements = function (matrix) {\n    // loop over colvalues\n    //console.log(\"Matrix:\",JSON.stringify(matrix));\n    var colvalues = Object.keys(matrix); //console.log(\"Matrix keys:\",JSON.stringify(colvalues));\n    //for (var colval of colvalues) {\n    //   console.log(\">\",colval);\n    //    if (colval === undefined) {\n    //\tconsole.log(colval,\": ***\");\n    //    } else {\n    //\t//var rowvalues=Object.keys(matrix[colval]);\n    //\t//console.log(colval,\":\",rowvalues);\n    //    };\n    //};\n  };\n\n  this.getMatrixElements = function (icolvalues, irowval, matrix, iindex, istep) {\n    var colvalues = icolvalues === undefined ? undefined : icolvalues.slice();\n    var index = iindex;\n    var step = istep;\n    var elements = undefined;\n\n    if (colvalues === undefined) {\n      // all colvalues\n      colvalues = Object.keys(matrix);\n      index = 0;\n      step = colvalues.length;\n    }\n\n    ;\n    var clen = colvalues.length;\n\n    if (matrix !== undefined && matrix !== null) {\n      for (var kk = index; kk < Math.min(clen, index + step); kk++) {\n        var colval = colvalues[kk];\n        var rowvalues = [irowval];\n\n        if (irowval === undefined) {\n          var mm = matrix[colval];\n\n          if (mm !== undefined) {\n            rowvalues = Object.keys(mm);\n          }\n        } //console.log(\"Checking:\",kk,clen,colval,JSON.stringify(rowvalues),\n        //\t    JSON.stringify(icolvalues),JSON.stringify(colvalues),irowval,index,step);\n\n\n        var rlen = rowvalues.length;\n\n        for (var ll = 0; ll < rlen; ll++) {\n          var rowval = rowvalues[ll];\n          var element = this.getMatrixElement(colvalues[kk], rowval, matrix);\n\n          if (element === undefined) {} else {\n            //console.log(\"getMatrixElements Found:\",kk,colval,rowval);\n            if (elements === undefined) {\n              elements = [];\n            }\n\n            ;\n            elements.push(element); //console.log(\"Added element:\",JSON.stringify(element),element.docs.length);\n          }\n        }\n      }\n\n      ;\n    } else {//console.log(\"No matrix available.\");\n    }\n\n    return elements;\n  };\n\n  this.getMatrixRowElements = function (colval, rowvalues, matrix, index, step) {\n    var rlen = rowvalues.length;\n    var elements = undefined;\n\n    if (matrix !== undefined) {\n      for (var kk = index; kk < Math.min(rlen, index + step); kk++) {\n        var element = this.getMatrixElement(colval, rowvalues[kk], matrix);\n\n        if (element === undefined) {} else {\n          //console.log(\"getMatrixElements Found:\",kk,rowvalues[kk],colval);\n          if (elements === undefined) {\n            elements = [];\n          }\n\n          ;\n          elements.push(element);\n        }\n      }\n\n      ;\n    } else {\n      console.log(\"No matrix available.\");\n    }\n\n    return elements;\n  };\n\n  this.getDocVal = function (state, doc, key) {\n    var val = doc[key];\n\n    if (val === undefined) {\n      val = \"\";\n    }\n\n    ;\n    return val;\n  };\n\n  this.updateMatrixElement = function (state, arr, dlev, doc) {\n    // called once for every hit\n    if (arr === undefined) {\n      console.log(\"Undefined matrix element.\");\n      return;\n    }\n\n    ;\n    var nn = arr.cnt || 0;\n    var dd = arr.def || 0;\n\n    if (arr.maxlev === undefined || arr.maxlev === -1 || dlev !== -1 && arr.maxlev < dlev) {\n      arr.maxlev = dlev;\n    }\n\n    ;\n\n    if (arr.minlev === undefined || arr.minlev > dlev) {\n      arr.minlev = dlev;\n    }\n\n    ;\n\n    if (arr.docs === undefined) {\n      arr.docs = [];\n    }\n\n    ;\n    arr.cnt = nn + 1; //console.log(\"Matrix doc:\",JSON.stringify(doc),dlev);\n\n    if (doc._thr !== undefined && doc._thr.val !== undefined) {\n      arr.def = dd + 1;\n\n      if (arr.def <= this.limit) {\n        arr.docs.push(doc);\n      }\n\n      ;\n    } else if (nn === dd) {\n      // make sure at least 1 undef is added...\n      arr.docs.push(doc);\n    } //if (state.Layout.state.tooltip === 0) {\n\n\n    var rank = state.Threshold.getRank(state, doc);\n\n    if (arr.tooltip === undefined) {\n      arr.tooltip = {};\n    }\n\n    ;\n    var el = this.getTooltipElement(state, arr.tooltip, doc);\n\n    if (dlev !== -1 && (el.maxrank === undefined && el.maxlev === undefined || el.maxlev < dlev || el.maxlev === dlev && el.maxrank < rank)) {\n      el.maxlev = dlev;\n      el.maxrank = rank;\n      el.docs = [];\n      el.docs.push(doc);\n    } else if (el.maxlev === dlev && el.maxrank === rank) {\n      if (dlev > 0 && dlev < state.Threshold.getMaxLevel(doc) && el.docs.length < 3 || el.docs.length < 1) {\n        el.docs.push(doc);\n      }\n\n      ;\n    }\n\n    ; //}\n    //console.log (\"Updating:\",JSON.stringify(arr),dlev,rank,JSON.stringify(doc));\n  };\n\n  this.getTooltipElement = function (state, tooltip, doc) {\n    var ret = tooltip;\n    var keys = state.Path.tooltip.select;\n    var lenk = keys.length; //console.log(\"Select-keys: \",lenk,JSON.stringify(keys));\n\n    for (var ii = 0; ii < lenk; ii++) {\n      var key = keys[ii];\n      var val = doc[key];\n\n      if (ret[val] === undefined) {\n        ret[val] = {};\n      }\n\n      ;\n      ret = ret[val]; //console.log(\"Selecting: \",ii,key,val,JSON.stringify(ret));\n    }\n\n    ;\n    return ret;\n  };\n\n  this.getRange = function (state, matrix, colvalues, rowvalues) {\n    var range; //console.log(\"Thresholds:\",JSON.stringify(state.Threshold.thrs));\n    //console.log(\"getRange Cols:\"+JSON.stringify(colvalues)+\" Rows:\"+JSON.stringify(rowvalues));\n\n    range = undefined;\n    var slenx = colvalues.length;\n\n    for (var ii = 0; ii < slenx; ii++) {\n      var sleny = rowvalues.length;\n\n      for (var jj = 0; jj < sleny; jj++) {\n        var element = this.getMatrixElement(colvalues[ii], rowvalues[jj], matrix);\n\n        if (element !== undefined) {\n          //console.log(\"Looking for range:\",ii,\"='\",colvalues[ii],\"' \",\n          //                                jj,\"='\",rowvalues[jj],\"'\",\n          //\t    JSON.stringify(element));\n          var docs = element.docs;\n\n          if (docs !== undefined) {\n            var dlen = docs.length;\n\n            for (var dd = 0; dd < dlen; dd++) {\n              var doc = docs[dd];\n\n              if (doc._thr !== undefined && doc._thr.val !== undefined) {\n                var val = doc._thr.val;\n                range = this.setRange(range, val);\n                var ts, dr;\n\n                if (doc._thr.max !== undefined) {\n                  //console.log(\"GetRange:\",JSON.stringify(doc._thr));\n                  ts = doc._thr.max;\n                  dr = ts[0] - ts[ts.length - 1];\n\n                  if (ts[ts.length - 1] > 0 && ts[ts.length - 1] - dr < 0) {\n                    // include zero\n                    range = this.setRange(range, 0);\n                  } //console.log(\"Found max:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n\n                } else if (doc._thr.min !== undefined) {\n                  ts = doc._thr.min;\n\n                  if (ts[ts.length - 1] < 0 && ts[ts.length - 1] + dr > 0) {\n                    // include zero\n                    range = this.setRange(range, 0);\n                  } //console.log(\"Found min:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n\n                }\n\n                range = this.setRange(range, ts[0]); // include lowest level\n\n                range = this.setRange(range, ts[ts.length - 1]); // include highest level\n                //console.log(\"After adjustment:\",tlev,ts.length,JSON.stringify(ts[tlev]),\"range=\",JSON.stringify(range));\n              }\n\n              ;\n            }\n          } else {//console.log(\"No matrix-element found:\",\n            //\t    JSON.stringify(colvalues[ii]),\n            //\t    JSON.stringify(rowvalues[jj]),\n            //\t    matrix.length,JSON.stringify(Object.keys(matrix))\n            //\t   );\n          }\n        }\n      }\n    } //console.log(\"Initial range:\",JSON.stringify(range));\n\n\n    range = this.adjustRange(range); //console.log(\"Final range:\",JSON.stringify(range));\n\n    return range;\n  };\n\n  this.setRange = function (range, val) {\n    //console.log(\"SetRange Start:\",JSON.stringify(range),val);\n    if (range === undefined) {\n      range = [val, val];\n    } else {\n      range = [Math.min(val, range[0]), Math.max(val, range[1])];\n    }\n\n    ; //console.log(\"SetRange Final:\",JSON.stringify(range),val);\n\n    return range;\n  };\n\n  this.adjustRange = function (range) {\n    if (range !== undefined) {\n      //console.log(\"Adjusting:\",JSON.stringify(range));\n      var dx = range[1] - range[0];\n      range = [range[0] - dx * 0.01, range[1] + dx * 0.01];\n\n      if (range[0] > 0 && range[0] - dx < 0) {\n        range[0] = 0;\n      }\n\n      if (range[1] < 0 && range[1] + dx > 0) {\n        range[1] = 0;\n      } //console.log(\"Result:\",JSON.stringify(range));\n\n\n      return range;\n    }\n  };\n\n  this.sortTooltipDocs = function (state, docs) {\n    var sort = state.Path.tooltip.sort || [];\n    var lens = sort.length;\n    var order = state.Path.order;\n\n    var funk = function funk(a, b) {\n      for (var ss = 0; ss < lens; ss++) {\n        var key = sort[ss];\n        var va = a[key];\n        var vb = b[key];\n\n        if (order[key] !== undefined) {\n          // we have a predefined order\n          var ia = order[key].indexOf(va);\n          var ib = order[key].indexOf(vb);\n\n          if (ia !== -1 && ib !== -1) {\n            return ia - ib;\n          } else if (ia !== -1) {\n            return 1;\n          } else if (ia !== -1) {\n            return -1;\n          } else if (va !== vb) {\n            return (va > vb) - (va < vb);\n          }\n        } else {\n          if (va !== vb) {\n            return (va > vb) - (va < vb);\n          }\n        }\n      }\n\n      return 0;\n    };\n\n    var ret = docs.sort(funk);\n    return ret;\n  };\n\n  this.sortMatrixValues = function (state) {\n    var tlen = state.Path.other.table.length; //console.log(\"this.sortMatrixValues row/column:\",JSON.stringify(state.Path.other.table),tlen);\n    // sort values\n\n    for (var jj = 0; jj < tlen; jj++) {\n      var key = state.Path.other.table[jj];\n\n      if (this.values[key] !== undefined) {\n        //console.log(\"Key:\",key,\"Values:\",JSON.stringify(this.values[key]),jj,\n        //\t    \" sort:\",JSON.stringify(state.Database.keyCnt));\n        if (state.Database.keyCnt[key] === undefined) {\n          console.log(\"**** Undefined keycnt:\", key);\n        } else if (state.Database.keyCnt[key].order === state.Database.casc) {\n          this.values[key] = this.values[key].sort(state.Utils.ascending);\n        } else if (state.Database.keyCnt[key].order === state.Database.nasc) {\n          this.values[key] = this.values[key].sort(state.Utils.descendingN);\n        } else if (state.Database.keyCnt[key].order === state.Database.cdes) {\n          this.values[key] = this.values[key].sort(state.Utils.descending);\n        } else if (state.Database.keyCnt[key].order === state.Database.ndes) {\n          this.values[key] = this.values[key].sort(state.Utils.descendingN);\n        }\n\n        ; //console.log(\"Sorted keys:\",key,JSON.stringify(this.values[key]),state.Database.keyCnt[key].order);\n        // override sort\n\n        if (state.Path.order !== undefined && state.Path.order[key] !== undefined) {\n          // we have a predefined order\n          var buff = [];\n          var olen = state.Path.order[key].length;\n          var kk, val; //console.log(\"Order length:\",olen,jj);\n          // add ordered values (not in trash)\n\n          for (kk = 0; kk < olen; kk++) {\n            val = state.Path.order[key][kk];\n\n            if (this.values[key].indexOf(val) !== -1) {\n              //console.log(\"Adding:\",kk,val);\n              buff.push(val);\n            }\n          } // add remaining this.values values (not in trash)\n\n\n          var rlen = this.values[key].length;\n\n          for (kk = 0; kk < rlen; kk++) {\n            val = this.values[key][kk];\n\n            if (buff.indexOf(val) === -1) {\n              // not in sub\n              buff.push(val);\n              state.Path.order[key].push(val);\n            }\n          }\n\n          ;\n          this.values[key] = buff; // use requested order\n          //console.log(\"Using requested order:\",key);\n        }\n\n        ;\n      }\n\n      ; //console.log(\"Found values:\",key,JSON.stringify(this.values[key]));\n    }\n\n    ;\n  };\n\n  this.sortedKeys = function (state, obj) {\n    var key;\n    var skeys = [];\n\n    for (key in obj) {\n      if (obj.hasOwnProperty(key) && key.substring(0, 1) !== \"_\") {\n        skeys.push(key);\n      }\n    }\n\n    ;\n    skeys = skeys.sort(state.Utils.ascending);\n    var ks = [];\n    var slen = skeys.length;\n\n    for (var jj = 0; jj < slen; jj++) {\n      key = skeys[jj];\n\n      if (key.substr(state, 0, 1) !== \"_\" && ks.indexOf(key) === -1) {\n        ks.push(key);\n      }\n    } //console.log(\"state.Utils.sortedKeys...\",JSON.stringify(skeys),JSON.stringify(ks));\n\n\n    return ks;\n  };\n\n  this.getInfo = function (state, elements) {\n    var tooltip = {}; // list of maxrank-docs\n\n    var cnt = 0;\n    var maxlev = -1;\n    var minlev = 0;\n    var docs = [];\n\n    if (elements === undefined) {\n      console.log(\"No elements found.\");\n    } else {\n      var elen = elements.length;\n\n      for (var ee = 0; ee < elen; ee++) {\n        cnt = cnt + elements[ee].cnt;\n\n        if (elements[ee].maxlev === undefined || elements[ee].minlev === undefined) {\n          minlev = Math.min(minlev, -2);\n        } else {\n          maxlev = Math.max(maxlev, elements[ee].maxlev);\n          minlev = Math.min(minlev, elements[ee].minlev);\n        } // loop over tooltips and put maxrank-docs into tooltip array\n\n\n        this.mergeTooltipElement(state, elements[ee].tooltip, tooltip, state.Path.tooltip.select.length);\n      }\n\n      docs = this.getTooltipDocs(state, tooltip); //console.log(\"Tooltip docs:\",JSON.stringify(docs));\n    }\n\n    return {\n      cnt: cnt,\n      minlev: minlev,\n      maxlev: maxlev,\n      tooltip: this.sortTooltipDocs(state, docs)\n    };\n  };\n\n  this.mergeTooltipElement = function (state, nel, mel, pos) {\n    if (nel === undefined) {\n      return;\n    } // nothing to merge\n\n\n    var ipos = pos;\n\n    if (ipos === undefined) {\n      ipos = state.Path.tooltip.select.length;\n    } //console.log(\"Merging tooltip:\",ipos,JSON.stringify(nel));\n\n\n    if (ipos > 0) {\n      var vals = Object.keys(nel);\n      var lenv = vals.length;\n\n      for (var ii = 0; ii < lenv; ii++) {\n        var val = vals[ii];\n\n        if (mel[val] === undefined) {\n          mel[val] = {};\n        }\n\n        ;\n        this.mergeTooltipElement(state, nel[val], mel[val], ipos - 1);\n      }\n    } else {\n      if (mel.maxrank === undefined || mel.maxrank < nel.maxrank) {\n        mel.maxrank = nel.maxrank;\n        mel.docs = nel.docs;\n      }\n\n      ;\n    }\n  };\n\n  this.getTooltipDocs = function (state, el, pos) {\n    var docs = [];\n    var ipos = pos;\n\n    if (ipos === undefined) {\n      ipos = state.Path.tooltip.select.length;\n    }\n\n    if (el !== undefined) {\n      if (ipos > 0) {\n        var vals = Object.keys(el);\n        var lenv = vals.length;\n\n        for (var ii = 0; ii < lenv; ii++) {\n          var val = vals[ii];\n          var ndocs = this.getTooltipDocs(state, el[val], ipos - 1);\n          state.Utils.cpArray(docs, ndocs);\n        }\n      } else if (el.docs !== undefined) {\n        state.Utils.cpArray(docs, el.docs);\n      }\n\n      ;\n    }\n\n    ;\n    return docs;\n  };\n\n  this.checkTooltip = function (state, data) {\n    var rowval = data.rowval;\n    var colvalues = data.colvalues;\n    var step = data.step;\n    var index = data.index; // get elements\n\n    var elements = this.getMatrixElements(colvalues, rowval, state.React.matrix, index, step) || []; // loop over elements\t\n\n    var lene = elements.length;\n    var ttset = true;\n\n    for (var ee = 0; ee < lene; ee++) {\n      // check if elements have tooltip set\n      if (elements[ee].tooltip === undefined) {\n        ttset = false;\n      } //console.log(\"Element:\",ee,JSON.stringify(elements[ee]));\n\n    }\n\n    ;\n    return ttset;\n  };\n\n  this.addTooltip = function (state, data) {\n    if (this.bdeb) {\n      console.log(\"Updated Matrix with tooltip.\", data.rowkey, data.colkey);\n    }\n\n    ;\n    var rowval = data.rowval;\n    var colvalues = data.colvalues;\n    var step = data.step;\n    var index = data.index; // get elements\n\n    var elements = this.getMatrixElements(colvalues, rowval, state.React.matrix, index, step) || [];\n    var lene = elements.length;\n\n    for (var ee = 0; ee < lene; ee++) {\n      // check if elements have tooltip set\n      if (elements[ee].tooltip === undefined) {\n        this.addElementTooltip(state, elements[ee]);\n      }\n    }\n\n    ;\n  };\n\n  this.makeCntTooltip = function (state, docs) {\n    // called when matrix is made if tooltip mode is toggled\n    var tooltip = {};\n    var dlen = docs.length;\n\n    for (var ii = 0; ii < dlen; ii++) {\n      var doc = docs[ii];\n      var rank = doc._rank;\n      var el = this.getTooltipElement(state, tooltip, doc);\n\n      if (el.maxrank === undefined || el.maxrank < rank) {\n        el.maxrank = rank;\n        el.docs = [];\n        el.docs.push(doc);\n      } else if (el.maxrank === rank) {\n        if (rank !== 0 || el.docs.length < 3) {\n          el.docs.push(doc);\n        }\n      } //console.log(\"Rank:\",rank,el.maxrank,JSON.stringify(tooltip));\n\n    }\n\n    return tooltip;\n  };\n\n  this.getElementWhere = function (state, el) {\n    var where = state.Database.getWhere(state);\n    var colkey = state.Path.getColKey(state);\n    var rowkey = state.Path.getRowKey(state);\n\n    if (rowkey !== undefined && rowkey !== \"\") {\n      var rowval = el.rowval;\n      where = state.Database.addWhere(where, rowkey + \"='\" + rowval + \"'\");\n    }\n\n    ;\n\n    if (colkey !== undefined && colkey !== \"\") {\n      var colval = el.colval;\n      where = state.Database.addWhere(where, colkey + \"='\" + colval + \"'\");\n    }\n\n    ;\n    return where;\n  };\n\n  this.addAllTooltip = function (state, matrix) {\n    // loop over all elements and add tooltips\n    var colvalues = Object.keys(matrix);\n    var lenc = colvalues.length;\n\n    for (var cc = 0; cc < lenc; cc++) {\n      var col = colvalues[cc];\n      var column = matrix[col];\n      var rowvalues = Object.keys(column);\n      var lenr = rowvalues.length;\n\n      for (var rr = 0; rr < lenr; rr++) {\n        var row = rowvalues[rr];\n        var el = column[row];\n        this.addElementTooltip(state, el);\n      }\n    }\n  };\n\n  this.addElementTooltip = function (state, el) {\n    // called when info-button is pressed - to add tooltip to element...\n    var where = this.getElementWhere(state, el);\n    var docs = [];\n\n    if (el.cnt > 0) {\n      docs = state.Database.getDocs(state, where);\n    }\n\n    ;\n    el.tooltip = this.makeCntTooltip(state, docs); //console.log(\"Added tooltip for element:\",docs.length,where); // JSON.stringify(el);\n  };\n\n  this.getTooltip = function (state, data) {\n    var rowval = data.rowval;\n    var colvalues = data.colvalues;\n    var step = data.step;\n    var index = data.index; // // get elements\n\n    var elements = this.getMatrixElements(colvalues, rowval, state.React.matrix, index, step); //console.log(\"Elements:\",JSON.stringify(elements));\n\n    var info = this.getInfo(state, elements);\n    return info.tooltip;\n  };\n}\n\n;\nexport default Matrix;","map":{"version":3,"sources":["/home/franktt/react/varseltavle/src/lib/MatrixLib.js"],"names":["Matrix","bdeb","cnt","keyCnt","levCnt","values","limit","resolution","area","popSingle","popSeries","init","state","par","Utils","cntKey","key","nrec","where","val","undefined","Path","ignore","indexOf","tcnt","docs","Database","getKeyCnt","dlen","length","jj","doc","push","console","log","Error","stack","initKeyCnt","makeKeyCnt","keys","plen","ii","updateKeyCnt","updateValues","addUndefinedKeyCnt","addUndefinedKeyCntValues","path","roundup","Math","ceil","rounddown","floor","posToVal","pos","min","max","res","ret","dlon","dbor","Number","toString","valToPos","lonToPos","minlon","maxlon","posToLon","latToPos","minlat","maxlat","posToLat","makeMapRange","distinct","value","index","self","vals","JSON","stringify","lat","filter","lon","getLonRange","parseFloat","lonmin","lonmax","getLonWhere","keylon","range","getLatRange","latmin","latmax","getLatWhere","keylat","addMapAreaKeys","latpos","ilat","lonpos","ilon","_lat","_lon","setArea","iminlat","imaxlat","iminlon","imaxlon","eps","epslon","epslat","makeKeyCntMap","getDocVal","setupMap","makeMapArea","addPathKeyCntValues","makeMatrixCntMap","cntDocs","matrix","found","colkey","getColKey","rowkey","getRowKey","colval","rowval","maxlev","maxrank","minlev","arr","makeMatrixElement","def","Html","setFootnote","Layout","tooltip","addAllTooltip","setMapArea","makeMatrix","dlev","Threshold","getLevel","updateLevCnt","updateMatrixElement","lev","first","m","getMatrixElement","printElements","colvalues","Object","getMatrixElements","icolvalues","irowval","iindex","istep","slice","step","elements","clen","kk","rowvalues","mm","rlen","ll","element","getMatrixRowElements","nn","dd","_thr","rank","getRank","el","getTooltipElement","getMaxLevel","select","lenk","getRange","slenx","sleny","setRange","ts","dr","adjustRange","dx","sortTooltipDocs","sort","lens","order","funk","a","b","ss","va","vb","ia","ib","sortMatrixValues","tlen","other","table","casc","ascending","nasc","descendingN","cdes","descending","ndes","buff","olen","sortedKeys","obj","skeys","hasOwnProperty","substring","ks","slen","substr","getInfo","elen","ee","mergeTooltipElement","getTooltipDocs","nel","mel","ipos","lenv","ndocs","cpArray","checkTooltip","data","React","lene","ttset","addTooltip","addElementTooltip","makeCntTooltip","_rank","getElementWhere","getWhere","addWhere","lenc","cc","col","column","lenr","rr","row","getDocs","getTooltip","info"],"mappings":"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","sourcesContent":["//console.log(\"Loading MatrixLib.js\");\n\nfunction Matrix() {\n    this.bdeb=false;\n    this.cnt=0;\n    this.keyCnt={};\n    this.levCnt={};\n    this.values={};\n    this.limit=100;     // displayed data\n    this.resolution=20; // map resolution\n    this.area={};\n    this.popSingle=1000;//0000;\n    this.popSeries=5000;//0000;\n    this.init=function(state){\n\tvar par=\"Matrix\";\n\tstate.Utils.init(par,this);\n    };\n    this.cntKey=function(state,key,nrec,where) {\n\tvar val;\n\tif (this.values[key]  === undefined) {\n\t    this.keyCnt[key]=0;\n\t    this.values[key]=[];\n\t}\n\tif (state.Path.ignore.indexOf(key)  === -1 && key !== \"\") {//ignore special words... \n\t    var tcnt=0;\n\t    var docs=state.Database.getKeyCnt(state,key,where)\n\t    //console.log(\"Count:\",sql,JSON.stringify(docs));\n\t    var dlen = docs.length;\n\t    for (var jj = 0; jj < dlen; jj++) {\n    \t\tvar doc=docs[jj];\n    \t\tval=doc[key];\n\t\tvar cnt=doc.cnt;\n\t\tif (val !== undefined) {\n\t\t    //console.log(\"Found key:\",key,this.getDocVal(state,doc,key));\n    \t\t    this.keyCnt[key]=this.keyCnt[key]+cnt;\n\t\t    this.values[key].push(val);\n\t\t    tcnt=tcnt+cnt;\n\t\t}\n\t    };\n\t    if (tcnt < nrec) { // insert undefined...\n\t\tval=\"\";\n\t\tthis.values[key].push(val);\n\t    };\n\t} else if (key === \"\") {\n\t    console.log(\"Key error...\",new Error().stack);\n\t}\n    };\n    this.initKeyCnt=function(state) {\n\tthis.values={};\n\tthis.keyCnt={};\n    };\n    this.makeKeyCnt=function(state,where,nrec,keys) {\n\tif (keys !== undefined) {\n\t    var plen = keys.length;\n\t    for (var ii = 0; ii < plen; ii++) {\n\t\tvar key=keys[ii];\n\t\tif (key !== \"\") {\n\t\t    this.cntKey(state,key,nrec,where);\n\t\t}\n\t    }\n\t};\n    };\n    this.updateKeyCnt=function(state,key){\n\tif (this.keyCnt[key]  === undefined) {\n    \t    this.keyCnt[key]=1;\n\t    this.values[key]=[];\n\t} else {\n    \t    this.keyCnt[key]++;\n\t}\n    };\n    this.updateValues=function(state,key,val) {\n\tif ( val !== undefined &&\n\t     this.values[key].indexOf(val)  === -1 ) { // value not in range\n\t\t//console.log(\"Checking val=\",JSON.stringify(val),\" key=\",key,\" doc=\",JSON.stringify(doc));\n\t\t//console.log(\"range=\",state.Utils.toString(state.Path.trash));\n    \t\tthis.values[key].push(val);\n\t};\n    }\n\n    // add \"undefined\" range of keys that are not present in every doc...\n    this.addUndefinedKeyCnt=function(state,docs){\n\tvar dlen = docs.length;\n\tfor (var key in this.keyCnt) {\n\t    if (this.keyCnt[key] < dlen) {\n\t\tvar val=\"\";\n\t\tthis.values[key].push(val);\n\t    }\n\t}\n    };\n    // parent path keys are always present (undefined parents can be used)...\n    this.addUndefinedKeyCntValues=function(state) {\n\tvar plen = state.Path.keys.path.length;\n\tfor (var ii = 0; ii < plen; ii++) {\n\t    var key=state.Path.keys.path[ii];\n\t    if (this.keyCnt[key]  === undefined) {\n    \t\tthis.keyCnt[key]=0;\n\t\tthis.values[key]=[];\n\t    }\n\t}\n    };\n    this.roundup=function(val) {\n\treturn Math.ceil(val*1000)/1000;\n    }\n    this.rounddown=function(val) {\n\treturn Math.floor(val*1000)/1000;\n    }\n    this.posToVal=function(state,pos,min,max) {\n\tvar res=this.resolution-1;\n\tif (pos !== undefined &&\n\t    min !== undefined &&\n\t    max !== undefined ) {\n\t    var ret;\n\t    var dlon=(max-min)/res;\n\t    var dbor=dlon/2;\n\t    var val=( (Number(pos)) * dlon ) + min;\n\t    if (this.bdeb) {console.log(\"PosToVal \",pos,min,max,val);};\n\t    return val.toString();\n\t}\n    };\n    this.valToPos=function(state,val,min,max) {\n\tvar res=this.resolution-1;\n\tif (val !== undefined &&\n\t    min !== undefined &&\n\t    max !== undefined ) {\n\t    var dlon=(max-min)/res;\n\t    if (max==min) {\n\t\tconsole.log(\"ValToPos#\",Number(val)-min,dlon,res/2);\n\t\treturn Math.floor(res/2);\n\t    } else {\n\t\tvar dbor=dlon/2;\n\t\tvar pos=(Number(val) - min + dbor)/dlon;\n\t\tif(this.bdeb){console.log(\"ValToPos:\",pos,Number(val)-min+dbor,dlon);};\n\t\treturn Math.max(0,Math.min(res,Math.floor(pos)))\n\t    }\n\t}\n    };\n    this.lonToPos=function(state,val) {\n\tvar min=this.area.minlon;\n\tvar max=this.area.maxlon;\n\treturn this.valToPos(state,val,min,max)\n    };\n    this.posToLon=function(state,pos) {\n\tvar min=this.area.minlon;\n\tvar max=this.area.maxlon;\n\treturn this.posToVal(state,pos,min,max)\n    };\n    this.latToPos=function(state,val) {\n\tvar min=this.area.minlat;\n\tvar max=this.area.maxlat;\n\treturn this.valToPos(state,val,min,max)\n    };\n    this.posToLat=function(state,pos) {\n\tvar min=this.area.minlat;\n\tvar max=this.area.maxlat;\n\treturn this.posToVal(state,pos,min,max)\n    };\n    this.makeMapRange=function(state){\n\tconst distinct=(value, index, self) => {\n\t    return self.indexOf(value) === index;\n\t};\n\tvar vals=[];\n\tvar ii;\n\tif (this.bdeb) {console.log(\"makeMapRange:\",JSON.stringify(this.area));};\n\tfor (ii=0;ii<this.resolution;ii++) {\n\t    var lat=this.posToLat(state,this.resolution-ii-1);\n\t    if (this.bdeb) {console.log(\"Values _lat:\",this.resolution,ii,lat)};\n\t    vals.push(lat);\n\t}\n\tthis.values[\"_lat\"]=vals.filter(distinct);\n\tvals=[];\n\tfor (ii=0;ii<this.resolution;ii++) {\n\t    var lon=this.posToLon(state,ii);\n\t    if (this.bdeb) {console.log(\"Values _lon:\",this.resolution,ii,lon)};\n\t    vals.push(lon);\n\t}\n\tthis.values[\"_lon\"]=vals.filter(distinct);\n    };\n    this.getLonRange=function(state,lon) {\n\tvar min=parseFloat(this.area.minlon);//Number(arr[0]);\n\tvar max=parseFloat(this.area.maxlon);//Number(arr[arr.length-1]);\n\tvar pos=this.valToPos(state,lon,min,max);\n\tvar lonmin=parseFloat(this.posToVal(state,pos-0.506,min,max));\n\tvar lonmax=parseFloat(this.posToVal(state,pos+0.494,min,max));\n\treturn {min:lonmin,max:lonmax};\n    }\n    this.getLonWhere=function(state,keylon,lon) {\n\tvar range=this.getLonRange(state,lon);\n\tvar lonmin=range.min;\n\tvar lonmax=range.max;\n\tif (parseFloat(lonmin) < parseFloat(lonmax)) {\n\t    return ''+keylon+' >= '+lonmin+' and '+keylon+ ' < '+lonmax+'';\n\t} else {\n\t    return ''+keylon+' >= '+lonmax+' and '+keylon+ ' < '+lonmin+'';\n\t}\n    };\n    this.getLatRange=function(state,lat) {\n\tvar min=parseFloat(this.area.minlat);//Number(arr[0]);\n\tvar max=parseFloat(this.area.maxlat);//Number(arr[arr.length-1]);\n\tvar pos=this.valToPos(state,lat,min,max);\n\tvar latmin=parseFloat(this.posToVal(state,pos-0.506,min,max));\n\tvar latmax=parseFloat(this.posToVal(state,pos+0.494,min,max));\n\treturn {min:latmin,max:latmax};\n    }\n    this.getLatWhere=function(state,keylat,lat) {\n\tvar range=this.getLatRange(state,lat);\n\tvar latmin=range.min;\n\tvar latmax=range.max;\n\tif (parseFloat(latmin) < parseFloat(latmax)) {\n\t    return ''+keylat+' >= '+latmin+' and '+keylat+ ' < '+latmax+'';\n\t} else {\n\t    return ''+keylat+' >= '+latmax+' and '+keylat+ ' < '+latmin+'';\n\t}\n    };\n    this.addMapAreaKeys=function(state,docs) {\n\t//var maxlat,minlat,maxlon,minlon;\n\tvar dlen = docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n    \t    //var vals=[];\n\t    //var lat=docs[\"lat\"];\n\t    var latpos=this.latToPos(state,doc.lat);\n\t    var ilat=this.posToLat(state,latpos);\n\t    //var lon=docs[\"lon\"];\n\t    var lonpos=this.lonToPos(state,doc.lon);\n\t    var ilon=this.posToLon(state,lonpos);\n\t    doc._lat=ilat\n\t    doc._lon=ilon\n\t    this.updateKeyCnt(state,\"_lat\");\n\t    this.updateKeyCnt(state,\"_lon\");\n\t    //console.log(\"AddMapAreaKeys=\",doc.lon,lonpos,ilon,doc._lon,JSON.stringify(this.area));\n\t}\n    };\n    this.setArea=function(iminlat,imaxlat,iminlon,imaxlon) {\n\tvar eps=0.1;\n\tvar minlat=parseFloat(iminlat);\n\tvar maxlat=parseFloat(imaxlat);\n\tvar minlon=parseFloat(iminlon);\n\tvar maxlon=parseFloat(imaxlon);\n\tvar epslon=maxlon-minlon;\n\tvar epslat=maxlat-minlat;\n\tif (epslon < eps) {\n\t    maxlon=maxlon+eps/2;\n\t    minlon=minlon-eps/2;\n\t};\n\tif (epslat < eps) {\n\t    maxlat=maxlat+eps/2;\n\t    minlat=minlat-eps/2;\n\t};\n\tthis.area={minlat:minlat,maxlat:maxlat,minlon:minlon,maxlon:maxlon};\n\tconsole.log(\"setArea:\",JSON.stringify(this.area));\n    }\n    this.makeKeyCntMap=function(state,docs) {\n\tvar key;\n\tvar maxlat,minlat,maxlon,minlon;\n\tvar dlen = docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n\t    //console.log(\"Trash doc=\",ii,JSON.stringify(doc));\n    \t    //var vals=[];\n    \t    for (key in doc) { // loop over keys in each doc\n\t\tthis.updateKeyCnt(state,key);\n\t\tvar val=this.getDocVal(state,doc,key);\n\t\tthis.updateValues(state,key,val)\n\t\tif (key  === \"lat\") {\n\t\t    if (maxlat  === undefined) {\n\t\t\tmaxlat=val\n\t\t    }else {\n\t\t\tmaxlat=Math.max(val,maxlat)\n\t\t    };\n\t\t    if (minlat  === undefined) {\n\t\t\tminlat=val\n\t\t    }else {\n\t\t\tminlat=Math.min(val,minlat)\n\t\t    };\n\t\t    this.updateKeyCnt(state,\"_lat\");\n\t\t} else if (key  === \"lon\") {\n\t\t    if (maxlon  === undefined) {\n\t\t\tmaxlon=val\n\t\t    }else {\n\t\t\tmaxlon=Math.max(val,maxlon)\n\t\t    };\n\t\t    if (minlon  === undefined) {\n\t\t\tminlon=val\n\t\t    }else {\n\t\t\tminlon=Math.min(val,minlon)\n\t\t    };\n\t\t    this.updateKeyCnt(state,\"_lon\");\n\t\t}\n    \t    };\n\t}\n\tthis.setArea(minlat,maxlat,minlon,maxlon);\n\treturn;\n    };\n    this.setupMap=function(state,docs) {\n\tthis.makeMapArea(state,docs);\n\tthis.makeMapRange(state);\n\tthis.addUndefinedKeyCnt(state,docs); // add \"undefined\"\n\tthis.addPathKeyCntValues(state);\n\tthis.addMapAreaKeys(state,docs);\n    };\n    this.makeMatrixCntMap=function(state,cntDocs,matrix) {\n\t//console.log(\"MatrixCnt:\",JSON.stringify(cntDocs));\n\t//var lonmin,lonmax,latmin,latmax;\n\tvar found=false;\n\tvar colkey=state.Path.getColKey(state);\n\tvar rowkey=state.Path.getRowKey(state);\n\tthis.levCnt={};\n\tif (this.bdeb) {console.log(\"Keys:\",JSON.stringify(colkey),JSON.stringify(rowkey),);};\n\t//var pos=[];\n\tvar dlen=cntDocs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=cntDocs[ii];\n\t    var colval=this.getDocVal(state,doc,colkey);\n\t    var rowval=this.getDocVal(state,doc,rowkey);\n\t    var cnt=this.getDocVal(state,doc,\"cnt\");\n\t    var maxlev=this.getDocVal(state,doc,\"maxlev\");\n\t    var maxrank=this.getDocVal(state,doc,\"maxrank\");\n\t    var minlev=this.getDocVal(state,doc,\"minlev\");\n\t    var minlon=this.getDocVal(state,doc,\"minlon\");\n\t    var maxlon=this.getDocVal(state,doc,\"maxlon\");\n\t    var minlat=this.getDocVal(state,doc,\"minlat\");\n\t    var maxlat=this.getDocVal(state,doc,\"maxlat\");\n\t    //if (lonmin === undefined || minlon < lonmin) {\n\t//\tlonmin=minlon\n\t    //};\n\t    //if (latmin === undefined || minlat < latmin) {\n\t//\tlatmin=minlat\n\t    //};\n    \t    // find matrix array element\n    \t    //console.log (\"Processing:\",JSON.stringify(doc),maxlev,minlev,cnt);\n    \t    var arr=this.makeMatrixElement(state,colval,rowval,matrix);\n    \t    // update matrix array element\n\t    if (maxlev >= 0) { found=true;}\n\t    if (arr !== undefined) {\n\t\tarr.maxlev=maxlev;\n\t\tarr.minlev=minlev;\n\t\tarr.maxrank=maxrank;\n\t\tarr.cnt=cnt;\n\t\tarr.def=0;\n\t\t//arr.docs=[];\n    \t\t//console.log (\"Array:\",JSON.stringify(arr));\n\t    }\n\t    // \tthis.setArea(minlat,maxlat,minlon,maxlon);\n\t}\n\tif (! found) {\n\t    console.log(\"this.makeMatrix No relevant thresholds found.\");\n\t    state.Html.setFootnote(state,\"No data found.\");\n\t}\n\tif (state.Layout.state.tooltip === 0) { // pre-generate all tooltips\n\t    state.Matrix.addAllTooltip(state,matrix);\n\t};\n    \t//console.log (\"Matrix:\",JSON.stringify(matrix));\n    };\n    this.setMapArea=function(state,docs) {\n\tvar dlen=docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n\t    var minlon=this.getDocVal(state,doc,\"minlon\");\n\t    var maxlon=this.getDocVal(state,doc,\"maxlon\");\n\t    var minlat=this.getDocVal(state,doc,\"minlat\");\n\t    var maxlat=this.getDocVal(state,doc,\"maxlat\");\n\t    this.setArea(minlat,maxlat,minlon,maxlon);\n\t    if (this.bdeb) {console.log(\"setMapArea:\",JSON.stringify(this.area),JSON.stringify(this.doc));};\n\t}\n    }\n    this.makeMatrix=function(state,docs,matrix) {\n\tvar found=false;\n\tvar colkey=state.Path.getColKey(state);\n\tvar rowkey=state.Path.getRowKey(state);\n\tthis.levCnt={};\n\t//var pos=[];\n\tvar dlen=docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n\t    var colval=this.getDocVal(state,doc,colkey);\n\t    var rowval=this.getDocVal(state,doc,rowkey);\n\t    //console.log(\"Found doc:\",colval,rowval,doc[\"lon\"],doc[\"lat\"])\n    \t    // find matrix array element\n    \t    var arr=this.makeMatrixElement(state,colval,rowval,matrix);\n    \t    // update matrix array element\n    \t    //console.log (\"Processing:\",JSON.stringify(pos),pos.length,JSON.stringify(doc));\n\t    var dlev=state.Threshold.getLevel(state,doc);\n\t    if (dlev === undefined) {dlev=-2;};\n\t    if (dlev >= 0) { found=true;}\n\t    this.updateLevCnt(state,colval,dlev);\n\t    this.updateLevCnt(state,rowval,dlev);\n    \t    this.updateMatrixElement(state,arr,dlev,doc);\n\t}\n\tif (! found) {\n\t    console.log(\"this.makeMatrix No relevant thresholds found.\");\n\t    state.Html.setFootnote(state,\"No data with valid threshold was found.\");\n\t}\n    };\n    this.updateLevCnt=function(state,val,lev) {\n\tif (this.levCnt[val]  === undefined) { this.levCnt[val]={};};\n\tif (this.levCnt[val][lev]  === undefined) { this.levCnt[val][lev]=0;};\n\tthis.levCnt[val][lev]=this.levCnt[val][lev]+1;\n    };\n    this.makeMatrixElement=function(state,colval,rowval,matrix) {\n\tvar first=false;\n\tif (matrix[colval] === undefined) {first=true;matrix[colval]={};};\n\tif (matrix[colval][rowval] === undefined) {first=true;matrix[colval][rowval]={};};\n\tvar m=matrix[colval][rowval];\n\tif (first) {\n\t    m.colval=colval;\n\t    m.rowval=rowval;\n\t};\n\treturn m\n    };\n    this.getMatrixElement=function(colval,rowval,matrix) {\n\t//console.log(\"getMatrixElement:\",colval,\"|\",rowval,\"|\",JSON.stringify(matrix));\n\tif (matrix[colval] !== undefined && matrix[colval][rowval] !== undefined ) {\n\t    return matrix[colval][rowval];\n\t}\n\treturn;\n    };\n    this.printElements=function(matrix) {\n\t// loop over colvalues\n\t//console.log(\"Matrix:\",JSON.stringify(matrix));\n\tvar colvalues=Object.keys(matrix);\n\t//console.log(\"Matrix keys:\",JSON.stringify(colvalues));\n\t//for (var colval of colvalues) {\n\t//   console.log(\">\",colval);\n\t//    if (colval === undefined) {\n\t//\tconsole.log(colval,\": ***\");\n\t//    } else {\n\t//\t//var rowvalues=Object.keys(matrix[colval]);\n\t//\t//console.log(colval,\":\",rowvalues);\n\t//    };\n\t//};\n    };\n    this.getMatrixElements=function(icolvalues,irowval,matrix,iindex,istep) {\n\tvar colvalues= (icolvalues === undefined ? undefined : icolvalues.slice());\n\tvar index=iindex;\n\tvar step=istep;\n\tvar elements=undefined;\n\tif (colvalues === undefined) { // all colvalues\n\t    colvalues=Object.keys(matrix);\n\t    index=0;\n\t    step=colvalues.length;\n\t};\n\tvar clen=colvalues.length;\n\tif (matrix!==undefined && matrix !== null) {\n\t    for (var kk=index;kk<Math.min(clen,index+step);kk++) {\n\t\tvar colval=colvalues[kk];\n\t\tvar rowvalues=[irowval];\n\t\tif (irowval===undefined) {\n\t\t    var mm=matrix[colval];if (mm !== undefined) {rowvalues=Object.keys(mm);}\n\t\t}\n\t\t//console.log(\"Checking:\",kk,clen,colval,JSON.stringify(rowvalues),\n\t\t//\t    JSON.stringify(icolvalues),JSON.stringify(colvalues),irowval,index,step);\n\t\tvar rlen=rowvalues.length;\n\t\tfor (var ll=0;ll<rlen;ll++) {\n\t\t    var rowval=rowvalues[ll];\n\t\t    var element=this.getMatrixElement(colvalues[kk],rowval,matrix);\n\t\t    if (element === undefined) {\n\t\t    } else {\n\t\t\t//console.log(\"getMatrixElements Found:\",kk,colval,rowval);\n\t\t\tif (elements===undefined) {elements=[];};\n\t\t\telements.push(element);\n\t\t\t//console.log(\"Added element:\",JSON.stringify(element),element.docs.length);\n\t\t    }\n\t\t}\n\t    };               \n\t} else {\n\t    //console.log(\"No matrix available.\");\n\t}\n\treturn elements;\n    };\n    this.getMatrixRowElements=function(colval,rowvalues,matrix,index,step) {\n\tvar rlen=rowvalues.length;\n\tvar elements=undefined;\n\tif (matrix!==undefined) {\n            for (var kk=index;kk<Math.min(rlen,index+step);kk++) {\n\t\tvar element=this.getMatrixElement(colval,rowvalues[kk],matrix);\n\t\tif (element === undefined) {\n\t\t} else {\n                    //console.log(\"getMatrixElements Found:\",kk,rowvalues[kk],colval);\n                    if (elements===undefined) {elements=[];};\n                    elements.push(element);\n\t\t}\n            };               \n\t} else {\n\t    console.log(\"No matrix available.\");\n\t}\n\treturn elements;\n    };\n    this.getDocVal=function(state,doc,key) {\n\tvar val = doc[key];if (val  === undefined) {val=\"\";};return val;\n    };\n    this.updateMatrixElement=function(state,arr,dlev,doc) { // called once for every hit\n\tif (arr  === undefined) {\n\t    console.log(\"Undefined matrix element.\");\n\t    return;\n\t};\n\tvar nn=arr.cnt||0;\n\tvar dd=arr.def||0;\n\tif (arr.maxlev  === undefined || arr.maxlev === -1 ||\n\t    (dlev !== -1 && arr.maxlev < dlev)) {\n\t    arr.maxlev=dlev;\n\t};\n\tif (arr.minlev === undefined || (arr.minlev > dlev)) {\n\t    arr.minlev=dlev;\n\t};\n\tif (arr.docs === undefined) {arr.docs=[];};\n\tarr.cnt=nn+1;\n\t//console.log(\"Matrix doc:\",JSON.stringify(doc),dlev);\n\tif (doc._thr !== undefined && doc._thr.val !== undefined) {\n\t    arr.def=dd+1;\n\t    if (arr.def <= this.limit) {arr.docs.push(doc);};\n\t} else if (nn === dd) { // make sure at least 1 undef is added...\n\t    arr.docs.push(doc);\n\t}\n\t//if (state.Layout.state.tooltip === 0) {\n\t    var rank=state.Threshold.getRank(state,doc);\n\t    if (arr.tooltip === undefined) {arr.tooltip={};};\n\t    var el=this.getTooltipElement(state,arr.tooltip,doc);\n\t    if ( dlev !== -1 &&\n\t\t ((el.maxrank === undefined && el.maxlev === undefined) || \n\t\t  (el.maxlev < dlev || (el.maxlev===dlev && el.maxrank < rank)))\n\t       ) {\n\t\tel.maxlev=dlev;\n\t\tel.maxrank=rank;\n\t\tel.docs=[];\n\t\tel.docs.push(doc);\n\t    } else if (el.maxlev === dlev && el.maxrank === rank) {\n\t\tif ((dlev > 0 && dlev < state.Threshold.getMaxLevel(doc) && \n\t\t     el.docs.length < 3) || el.docs.length < 1) {\n\t\t    el.docs.push(doc);\n\t\t};\n\t    };\n\t//}\n\t//console.log (\"Updating:\",JSON.stringify(arr),dlev,rank,JSON.stringify(doc));\n    };\n    this.getTooltipElement=function(state,tooltip,doc) {\n\tvar ret=tooltip;\n\tvar keys=state.Path.tooltip.select;\n\tvar lenk=keys.length;\n\t//console.log(\"Select-keys: \",lenk,JSON.stringify(keys));\n\tfor (var ii=0;ii < lenk;ii++) {\n\t    var key=keys[ii];\n\t    var val=doc[key];\n\t    if (ret[val]=== undefined) {ret[val]={};};\n\t    ret=ret[val];\n\t    //console.log(\"Selecting: \",ii,key,val,JSON.stringify(ret));\n\t};\n\treturn ret;\n    };\n    this.getRange=function(state,matrix,colvalues,rowvalues) {\n\tvar range;\n\t//console.log(\"Thresholds:\",JSON.stringify(state.Threshold.thrs));\n\t//console.log(\"getRange Cols:\"+JSON.stringify(colvalues)+\" Rows:\"+JSON.stringify(rowvalues));\n\trange=undefined;\n\tvar slenx=colvalues.length;\n\tfor(var ii=0; ii<slenx; ii++) {\n\t    var sleny=rowvalues.length;\n\t    for(var jj=0; jj<sleny; jj++) {\n\t\tvar element=this.getMatrixElement(colvalues[ii],rowvalues[jj],matrix);\n\t\tif (element !== undefined) {\n\t\t    //console.log(\"Looking for range:\",ii,\"='\",colvalues[ii],\"' \",\n\t\t    //                                jj,\"='\",rowvalues[jj],\"'\",\n\t\t    //\t    JSON.stringify(element));\n\t\t    var docs=element.docs;\n\t\t    if (docs !== undefined) {\n\t\t\tvar dlen = docs.length;\n\t\t\tfor (var dd = 0; dd < dlen; dd++) {\n    \t\t\t    var doc = docs[dd];\n\t\t\t    if  (doc._thr !== undefined && doc._thr.val !== undefined) {\n\t\t\t\tvar val = doc._thr.val;\n\t\t\t\trange=this.setRange(range,val);\n\t\t\t\tvar ts,dr;\n\t\t\t\tif (doc._thr.max !== undefined) {\n\t\t\t\t    //console.log(\"GetRange:\",JSON.stringify(doc._thr));\n\t\t\t\t    ts=doc._thr.max;\n\t\t\t\t    dr=ts[0]-ts[ts.length-1];\n\t\t\t\t    if (ts[ts.length-1]>0 && ts[ts.length-1]-dr<0) { // include zero\n\t\t\t\t\trange=this.setRange(range,0);\n\t\t\t\t    }\n\t\t\t\t    //console.log(\"Found max:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n\t\t\t\t} else if (doc._thr.min !== undefined) {\n\t\t\t\t    ts=doc._thr.min;\n\t\t\t\t    if (ts[ts.length-1]<0 && ts[ts.length-1]+dr>0) { // include zero\n\t\t\t\t\trange=this.setRange(range,0);\n\t\t\t\t    }\n\t\t\t\t    //console.log(\"Found min:\",ts[0],ts[ts.length-1],dr,JSON.stringify(range),thr,key,val);\n\t\t\t\t}\n\t\t\t\trange=this.setRange(range,ts[0]); // include lowest level\n\t\t\t\trange=this.setRange(range,ts[ts.length-1]); // include highest level\n\t\t\t\t//console.log(\"After adjustment:\",tlev,ts.length,JSON.stringify(ts[tlev]),\"range=\",JSON.stringify(range));\n\t\t\t    };\n\t\t\t}\n\t\t    } else {\n\t\t\t//console.log(\"No matrix-element found:\",\n\t\t\t//\t    JSON.stringify(colvalues[ii]),\n\t\t\t//\t    JSON.stringify(rowvalues[jj]),\n\t\t\t//\t    matrix.length,JSON.stringify(Object.keys(matrix))\n\t\t\t//\t   );\n\t\t    }\n\t\t}\n\t    }\n\t}\n\t//console.log(\"Initial range:\",JSON.stringify(range));\n\trange=this.adjustRange(range);\n\t//console.log(\"Final range:\",JSON.stringify(range));\n\treturn range;\n    };\n    this.setRange=function(range,val) {\n\t//console.log(\"SetRange Start:\",JSON.stringify(range),val);\n\tif (range  === undefined) {\n\t    range=[val,val];\n\t} else {\n\t    range=[Math.min(val,range[0]),Math.max(val,range[1])];\n\t};\n\t//console.log(\"SetRange Final:\",JSON.stringify(range),val);\n\treturn range;\n    };\n    this.adjustRange=function(range) {\n\tif (range !== undefined) {\n\t    //console.log(\"Adjusting:\",JSON.stringify(range));\n\t    var dx=(range[1]-range[0]);\n\t    range=[range[0]-dx*0.01,range[1]+dx*0.01];\n\t    if (range[0]>0 && range[0]-dx<0) { range[0]=0;}\n\t    if (range[1]<0 && range[1]+dx>0) { range[1]=0;}\n\t    //console.log(\"Result:\",JSON.stringify(range));\n\t    return range;\n\t}\n    };\n    this.sortTooltipDocs=function(state,docs) {\n\tvar sort=state.Path.tooltip.sort||[];\n\tvar lens=sort.length;\n\tvar order=state.Path.order;\n\tvar funk=function(a,b){\n\t    for (var ss=0;ss<lens;ss++) {\n\t\tvar key=sort[ss];\n\t\tvar va=a[key];\n\t\tvar vb=b[key];\n\t\tif (order[key] !== undefined) { // we have a predefined order\n\t\t    var ia=order[key].indexOf(va);\n\t\t    var ib=order[key].indexOf(vb);\n\t\t    if (ia !==-1 && ib !== -1) {\n\t\t\treturn ia-ib\n\t\t    } else if (ia !== -1) {\n\t\t\treturn 1;\n\t\t    } else if (ia !== -1) {\n\t\t\treturn -1;\n\t\t    } else if (va !== vb) {\n\t\t\treturn (va > vb) - (va < vb);\n\t\t    }\n\t\t} else {\n\t\t    if (va !== vb) {\n\t\t\treturn (va > vb) - (va < vb);\n\t\t    }\n\t\t}\n\t    }\n\t    return 0;\n\t};\n\tvar ret=docs.sort(funk);\n\treturn ret; \n    };\n    this.sortMatrixValues=function(state) {\n\tvar tlen=state.Path.other.table.length;\n\t//console.log(\"this.sortMatrixValues row/column:\",JSON.stringify(state.Path.other.table),tlen);\n\t// sort values\n\tfor (var jj = 0; jj < tlen; jj++) {\n    \t    var key=state.Path.other.table[jj];\n\t    if (this.values[key] !== undefined) {\n\t\t//console.log(\"Key:\",key,\"Values:\",JSON.stringify(this.values[key]),jj,\n\t    \t//\t    \" sort:\",JSON.stringify(state.Database.keyCnt));\n\t\tif (state.Database.keyCnt[key]===undefined) {\n\t\t    console.log(\"**** Undefined keycnt:\",key);\n\t\t} else if (state.Database.keyCnt[key].order  === state.Database.casc) {\n    \t\t    this.values[key]=this.values[key].sort(state.Utils.ascending);\n\t\t} else if (state.Database.keyCnt[key].order  === state.Database.nasc) {\n    \t\t    this.values[key]=this.values[key].sort(state.Utils.descendingN);\n\t\t} else if (state.Database.keyCnt[key].order  === state.Database.cdes) {\n    \t\t    this.values[key]=this.values[key].sort(state.Utils.descending);\n\t\t} else if (state.Database.keyCnt[key].order  === state.Database.ndes) {\n    \t\t    this.values[key]=this.values[key].sort(state.Utils.descendingN);\n\t\t};\n\t\t//console.log(\"Sorted keys:\",key,JSON.stringify(this.values[key]),state.Database.keyCnt[key].order);\n\t\t// override sort\n\t\tif (state.Path.order !== undefined &&\n\t\t    state.Path.order[key] !== undefined) { // we have a predefined order\n\t\t\tvar buff=[];\n\t\t    var olen=state.Path.order[key].length;\n\t\t    var kk,val;\n\t\t    //console.log(\"Order length:\",olen,jj);\n\t\t    // add ordered values (not in trash)\n\t\t    for (kk = 0; kk < olen; kk++) {\n\t\t\tval=state.Path.order[key][kk];\n\t\t\tif (this.values[key].indexOf(val) !== -1) {\n\t\t\t    //console.log(\"Adding:\",kk,val);\n\t\t\t    buff.push(val);\n\t\t\t}\n\t\t    }\n\t\t    // add remaining this.values values (not in trash)\n\t\t    var rlen=this.values[key].length;\n\t\t    for (kk = 0; kk < rlen; kk++) {\n\t\t\tval=this.values[key][kk];\n\t\t\tif (buff.indexOf(val)  === -1) { // not in sub\n\t\t\t    buff.push(val);\n\t\t\t    state.Path.order[key].push(val);\n\t\t\t}\n\t\t    };\n\t\t    this.values[key]=buff; // use requested order\n\t\t    //console.log(\"Using requested order:\",key);\n\t\t};\n\t    };\n    \t    //console.log(\"Found values:\",key,JSON.stringify(this.values[key]));\n\t};\n    };\n    this.sortedKeys=function(state,obj) {\n\tvar key;\n\tvar skeys = [];\n\tfor(key in obj){\n\t    if (obj.hasOwnProperty(key) && key.substring(0,1) !== \"_\") {skeys.push(key);}\n\t};\n\tskeys=skeys.sort(state.Utils.ascending);\n\tvar ks=[];\n\tvar slen=skeys.length;\n\tfor (var jj = 0; jj < slen; jj++) {\n\t    key=skeys[jj];\n\t    if (key.substr(state,0,1) !== \"_\" && ks.indexOf(key) === -1) {\n\t\tks.push(key);\n\t    }\n\t}\n\t//console.log(\"state.Utils.sortedKeys...\",JSON.stringify(skeys),JSON.stringify(ks));\n\treturn ks;\n    }\n    this.getInfo=function(state,elements) {\n\tvar tooltip={}; // list of maxrank-docs\n\tvar cnt=0;\n\tvar maxlev=-1;\n\tvar minlev=0;\n\tvar docs=[];\n\tif (elements === undefined) {\n\t    console.log(\"No elements found.\");\n\t} else {\n\t    var elen=elements.length;\n\t    for (var ee=0;ee<elen;ee++) {\n\t\tcnt=cnt+elements[ee].cnt;\n\t\tif (elements[ee].maxlev === undefined || elements[ee].minlev === undefined) {\n\t\t    minlev=Math.min(minlev,-2);\n\t\t} else {\n\t\t    maxlev=Math.max(maxlev,elements[ee].maxlev);\n\t\t    minlev=Math.min(minlev,elements[ee].minlev);\n\t\t}\n\t\t// loop over tooltips and put maxrank-docs into tooltip array\n\t\tthis.mergeTooltipElement(state,elements[ee].tooltip,tooltip,state.Path.tooltip.select.length);\n\t    }\n\t    docs=this.getTooltipDocs(state,tooltip);\n\t    //console.log(\"Tooltip docs:\",JSON.stringify(docs));\n\t}\n\treturn {cnt:cnt,\n\t\tminlev:minlev,\n\t\tmaxlev:maxlev,\n\t\ttooltip:this.sortTooltipDocs(state,docs)};\n    }\n    this.mergeTooltipElement=function(state,nel,mel,pos) {\n\tif (nel === undefined) {return;} // nothing to merge\n\tvar ipos=pos;\n\tif (ipos === undefined) {ipos=state.Path.tooltip.select.length;}\n\t//console.log(\"Merging tooltip:\",ipos,JSON.stringify(nel));\n\tif (ipos > 0) {\n\t    var vals=Object.keys(nel);\n\t    var lenv=vals.length;\n\t    for (var ii=0;ii<lenv;ii++) {\n\t\tvar val=vals[ii];\n\t\tif (mel[val]===undefined) {mel[val]={}};\n\t\tthis.mergeTooltipElement(state,nel[val],mel[val],ipos-1);\n\t    }\n\t} else {\n\t    if (mel.maxrank === undefined || mel.maxrank < nel.maxrank) {\n\t\tmel.maxrank=nel.maxrank;\n\t\tmel.docs=nel.docs;\n\t    };\n\t}\n    };\n    this.getTooltipDocs=function(state,el,pos) {\n\tvar docs=[];\n\tvar ipos=pos;\n\tif (ipos === undefined) {ipos=state.Path.tooltip.select.length;}\n\tif (el !== undefined) {\n\t    if (ipos > 0) {\n\t\tvar vals=Object.keys(el);\n\t\tvar lenv=vals.length;\n\t\tfor (var ii=0;ii<lenv;ii++) {\n\t\t    var val=vals[ii];\n\t\t    var ndocs=this.getTooltipDocs(state,el[val],ipos-1);\n\t\t    state.Utils.cpArray(docs,ndocs);\n\t\t}\n\t    } else if (el.docs !== undefined) {\n\t\tstate.Utils.cpArray(docs,el.docs);\n\t    };\n\t};\n\treturn docs;\n    };\n    this.checkTooltip=function(state,data) {\n\tvar rowval=data.rowval;\n\tvar colvalues=data.colvalues;\n\tvar step=data.step;\n\tvar index=data.index;\n\t// get elements\n\tvar elements=this.getMatrixElements(colvalues,rowval,state.React.matrix,index,step)||[];\n\t// loop over elements\t\n\tvar lene=elements.length;\n\tvar ttset=true;\n\tfor (var ee=0; ee<lene; ee++) {\n\t    // check if elements have tooltip set\n\t    if (elements[ee].tooltip===undefined) {\n\t\tttset=false;\n\t    }\n\t    //console.log(\"Element:\",ee,JSON.stringify(elements[ee]));\n\n\t};\n\treturn ttset;\n    };\n    this.addTooltip=function(state,data) {\n\tif (this.bdeb) {console.log(\"Updated Matrix with tooltip.\",data.rowkey,data.colkey);};\n\tvar rowval=data.rowval;\n\tvar colvalues=data.colvalues;\n\tvar step=data.step;\n\tvar index=data.index;\n\t// get elements\n\tvar elements=this.getMatrixElements(colvalues,rowval,state.React.matrix,index,step)||[];\n\tvar lene=elements.length;\n\tfor (var ee=0; ee<lene; ee++) {\n\t    // check if elements have tooltip set\n\t    if (elements[ee].tooltip===undefined) {\n\t\tthis.addElementTooltip(state,elements[ee]);\n\t    }\n\t};\n    };\n    this.makeCntTooltip=function(state,docs) {\n\t// called when matrix is made if tooltip mode is toggled\n\tvar tooltip={};\n\tvar dlen=docs.length;\n\tfor (var ii = 0; ii < dlen; ii++) {\n    \t    var doc=docs[ii];\n\t    var rank=doc._rank\n\t    var el=this.getTooltipElement(state,tooltip,doc);\n\t    if (el.maxrank === undefined || el.maxrank < rank) {\n\t\tel.maxrank=rank;\n\t\tel.docs=[];\n\t\tel.docs.push(doc);\n\t    } else if (el.maxrank === rank) {\n\t\tif (rank!==0 || el.docs.length < 3) {\n\t\t    el.docs.push(doc);\n\t\t}\n\t    }\n\t    //console.log(\"Rank:\",rank,el.maxrank,JSON.stringify(tooltip));\n\t}\n\treturn tooltip;\n    };\n    this.getElementWhere=function(state,el) {\n\tvar where = state.Database.getWhere(state);\n\tvar colkey= state.Path.getColKey(state);\n\tvar rowkey= state.Path.getRowKey(state);\n\tif (rowkey !== undefined && rowkey !== \"\") {\n\t    var rowval=el.rowval;\n\t    where=state.Database.addWhere(where,rowkey+\"='\" + rowval+\"'\");\n\t};\n\tif (colkey !== undefined && colkey !== \"\") {\n\t    var colval=el.colval;\n\t    where=state.Database.addWhere(where,colkey+\"='\" + colval+\"'\");\n\t};\n\treturn where;\n    };\n    this.addAllTooltip=function(state,matrix) {\n\t// loop over all elements and add tooltips\n\tvar colvalues=Object.keys(matrix);\n\tvar lenc=colvalues.length;\n\tfor (var cc=0;cc<lenc;cc++) {\n\t    var col=colvalues[cc];\n\t    var column=matrix[col];\n\t    var rowvalues=Object.keys(column);\n\t    var lenr=rowvalues.length;\n\t    for (var rr=0;rr<lenr;rr++) {\n\t\tvar row=rowvalues[rr];\n\t\tvar el=column[row];\n\t\tthis.addElementTooltip(state,el);\n\t    }\n\t}\n    };\n    this.addElementTooltip=function(state,el) {\n\t// called when info-button is pressed - to add tooltip to element...\n\tvar where = this.getElementWhere(state,el);\n\tvar docs=[];\n\tif (el.cnt>0) {docs=state.Database.getDocs(state,where);};\n\tel.tooltip=this.makeCntTooltip(state,docs);\n\t//console.log(\"Added tooltip for element:\",docs.length,where); // JSON.stringify(el);\n    };\n    this.getTooltip=function(state,data) {\n\tvar rowval=data.rowval;\n\tvar colvalues=data.colvalues;\n\tvar step=data.step;\n\tvar index=data.index;\n\t// // get elements\n\tvar elements=this.getMatrixElements(colvalues,rowval,state.React.matrix,index,step);\n\n\t//console.log(\"Elements:\",JSON.stringify(elements));\n\n\tvar info=this.getInfo(state,elements);\n\treturn info.tooltip;\n    };\n};\nexport default Matrix;\n"]},"metadata":{},"sourceType":"module"}